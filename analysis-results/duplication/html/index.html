<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Copy/Paste Detector Report</title><link href="styles/tailwind.css" rel="stylesheet"><link href="styles/prism.css" rel="stylesheet"></head><body class="bg-gray-100"><header class="bg-white shadow py-4"><div class="container mx-auto px-4"><h1 class="text-3xl font-semibold text-gray-800">jscpd - copy/paste report</h1></div></header><main class="container mx-auto my-8 p-4 bg-white shadow rounded"><section class="mb-8" id="dashboard"><h2 class="text-2xl font-semibold text-gray-700 mb-4">Dashboard</h2><div class="grid grid-cols-4 gap-4"><div class="bg-blue-200 p-4 rounded text-center"><h3 class="text-lg font-semibold text-blue-800 mb-2">Total Files</h3><span class="text-4xl font-bold text-blue-800">964</span></div><div class="bg-green-200 p-4 rounded text-center"><h3 class="text-lg font-semibold text-green-800 mb-2">Total Lines of Code</h3><span class="text-4xl font-bold text-green-800">122112</span></div><div class="bg-yellow-200 p-4 rounded text-center"><h3 class="text-lg font-semibold text-yellow-800 mb-2">Number of Clones</h3><span class="text-4xl font-bold text-yellow-800">357</span></div><div class="bg-red-200 p-4 rounded text-center"><h3 class="text-lg font-semibold text-red-800 mb-2">Duplicated Lines</h3><span class="text-4xl font-bold text-red-800">6212 (5.09%)</span></div></div></section><section class="mb-8" id="formats"><h2 class="text-2xl font-semibold text-gray-700 mb-4">Formats with Duplications</h2><table class="w-full table-auto"><thead><tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal"><th class="py-3 px-6 text-left">Format</th><th class="py-3 px-6 text-left">Files</th><th class="py-3 px-6 text-left">Lines</th><th class="py-3 px-6 text-left">Clones</th><th class="py-3 px-6 text-left">Duplicated Lines</th><th class="py-3 px-6 text-left">Duplicated Tokens</th></tr></thead><tbody><tr class="bg-white border-b border-gray-200 text-gray-800 text-sm"><td class="py-3 px-6"><a class="text-blue-600 hover:underline" href="#typescript-clones">typescript</a></td><td class="py-3 px-6">435</td><td class="py-3 px-6">68226</td><td class="py-3 px-6">254</td><td class="py-3 px-6">4396</td><td class="py-3 px-6">33975</td></tr><tr class="bg-white border-b border-gray-200 text-gray-800 text-sm"><td class="py-3 px-6"><a class="text-blue-600 hover:underline" href="#javascript-clones">javascript</a></td><td class="py-3 px-6">257</td><td class="py-3 px-6">16997</td><td class="py-3 px-6">22</td><td class="py-3 px-6">519</td><td class="py-3 px-6">4436</td></tr><tr class="bg-white border-b border-gray-200 text-gray-800 text-sm"><td class="py-3 px-6"><a class="text-blue-600 hover:underline" href="#tsx-clones">tsx</a></td><td class="py-3 px-6">268</td><td class="py-3 px-6">36477</td><td class="py-3 px-6">79</td><td class="py-3 px-6">1247</td><td class="py-3 px-6">10317</td></tr><tr class="bg-white border-b border-gray-200 text-gray-800 text-sm"><td class="py-3 px-6"><a class="text-blue-600 hover:underline" href="#css-clones">css</a></td><td class="py-3 px-6">4</td><td class="py-3 px-6">412</td><td class="py-3 px-6">2</td><td class="py-3 px-6">50</td><td class="py-3 px-6">358</td></tr></tbody></table></section><section class="mb-8" id="txt-clones"><a name="typescript-clones"></a><h2 class="text-2xl font-semibold text-gray-700 mb-4">typescript</h2><div class="divide-y divide-gray-200 border-b-2"><div class="py-4"><p class="text-gray-600">libs/auth/src/lib/express/adapter.ts (Line 34:2 - Line 47:4), libs/auth/src/lib/express/server-auth.ts (Line 14:11 - Line 26:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn0" onclick="toggleCodeBlock('cloneGroup0', 'expandBtn0', 'collapseBtn0')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn0" onclick="toggleCodeBlock('cloneGroup0', 'expandBtn0', 'collapseBtn0')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup0"><code class="language-typescript text-sm text-gray-800">;

// Placeholder logger until we set up proper imports
const logger = {
  info: (message: string, context?: any) =&gt; console.log(`[INFO] ${message}`, context),
  error: (message: string, error?: any) =&gt; console.error(`[ERROR] ${message}`, error),
  warn: (message: string, context?: any) =&gt; console.warn(`[WARN] ${message}`, context),
  debug: (message: string, context?: any) =&gt; console.debug(`[DEBUG] ${message}`, context),
};

/**
 * Creates a Next.js middleware function that uses Clerk Express SDK
 * @returns Middleware function compatible with Next.js
 */</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/bookings/create/route.ts (Line 55:37 - Line 69:51), app/api/scheduling/bookings/initialize/route.ts (Line 46:41 - Line 60:45)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn1" onclick="toggleCodeBlock('cloneGroup1', 'expandBtn1', 'collapseBtn1')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn1" onclick="toggleCodeBlock('cloneGroup1', 'expandBtn1', 'collapseBtn1')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup1"><code class="language-typescript text-sm text-gray-800">, {
        bookingId: bookingContext.bookingId,
        state: bookingContext.state,
        userId: user?.id || 'anonymous',
        isAuthenticated: !!user
      });
      
      return NextResponse.json({
        success: true,
        bookingId: bookingContext.bookingId,
        state: bookingContext.state
      });
      
    } catch (validationError) {
      logger.error('Validation error when creating anonymous booking'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/bookings/create/route.ts (Line 69:51 - Line 81:35), app/api/scheduling/bookings/initialize/route.ts (Line 60:45 - Line 72:29)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn2" onclick="toggleCodeBlock('cloneGroup2', 'expandBtn2', 'collapseBtn2')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn2" onclick="toggleCodeBlock('cloneGroup2', 'expandBtn2', 'collapseBtn2')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup2"><code class="language-typescript text-sm text-gray-800">, {
        error: validationError,
        userId: user?.id || 'anonymous'
      });
      
      return NextResponse.json(
        { error: 'Invalid request data', details: validationError },
        { status: 400 }
      );
    }
    
  } catch (error) {
    logger.error('Error creating anonymous booking'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/bookings/[bookingId]/route.ts (Line 147:2 - Line 158:34), app/api/scheduling/bookings/[bookingId]/route.ts (Line 25:2 - Line 36:33)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn3" onclick="toggleCodeBlock('cloneGroup3', 'expandBtn3', 'collapseBtn3')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn3" onclick="toggleCodeBlock('cloneGroup3', 'expandBtn3', 'collapseBtn3')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup3"><code class="language-typescript text-sm text-gray-800">= withAuth(async (
  req: NextRequest,
  userId: string,
  { params }: { params: { bookingId: string } }
) =&gt; {
  const startTime = performance.now();
  const path = req.nextUrl.pathname;
  const method = req.method;
  const { bookingId } = params;

  try {
    logger.info('Booking update request received'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/bookings/[bookingId]/route.ts (Line 169:31 - Line 191:23), app/api/scheduling/bookings/[bookingId]/route.ts (Line 47:20 - Line 69:59)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn4" onclick="toggleCodeBlock('cloneGroup4', 'expandBtn4', 'collapseBtn4')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn4" onclick="toggleCodeBlock('cloneGroup4', 'expandBtn4', 'collapseBtn4')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup4"><code class="language-typescript text-sm text-gray-800">, {
        path,
        method,
        userId,
        bookingId
      });
      
      return createAuthErrorResponse(
        'RESOURCE_NOT_FOUND',
        'Booking not found',
        404,
        path,
        method,
        userId
      );
    }
    
    // Get user roles from auth context
    const req_roles = req.auth?.sessionClaims?.roles as UserRole[] || 
                    req.auth?.sessionClaims?.['public_metadata']?.['roles'] as UserRole[] || 
                    [];
    
    // Authorization check</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/bookings/[bookingId]/route.ts (Line 346:14 - Line 365:2), app/api/scheduling/bookings/[bookingId]/route.ts (Line 272:7 - Line 291:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn5" onclick="toggleCodeBlock('cloneGroup5', 'expandBtn5', 'collapseBtn5')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn5" onclick="toggleCodeBlock('cloneGroup5', 'expandBtn5', 'collapseBtn5')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup5"><code class="language-typescript text-sm text-gray-800">,
        duration: `${(performance.now() - startTime).toFixed(2)}ms`
      });

      // Create response with standardized format
      const response = NextResponse.json({
        success: true,
        data: { booking: updatedBooking }
      });

      // Add performance metrics to the response
      return addAuthPerformanceMetrics(
        response, 
        startTime, 
        true, 
        path, 
        method, 
        userId
      );
    } else {</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/bookings/[bookingId]/route.ts (Line 385:25 - Line 398:27), app/api/scheduling/bookings/[bookingId]/route.ts (Line 121:25 - Line 134:26)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn6" onclick="toggleCodeBlock('cloneGroup6', 'expandBtn6', 'collapseBtn6')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn6" onclick="toggleCodeBlock('cloneGroup6', 'expandBtn6', 'collapseBtn6')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup6"><code class="language-typescript text-sm text-gray-800">, {
      error: errorMessage,
      path,
      method,
      userId,
      bookingId,
      duration: `${(performance.now() - startTime).toFixed(2)}ms`
    });
    
    Sentry.captureException(error);
    
    return createAuthErrorResponse(
      AuthErrorType.SERVER,
      'Failed to update booking'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/profiles/builder/[id]/route.ts (Line 41:2 - Line 77:5), app/api/profiles/builder/slug/[slug]/route.ts (Line 33:2 - Line 69:5)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn7" onclick="toggleCodeBlock('cloneGroup7', 'expandBtn7', 'collapseBtn7')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn7" onclick="toggleCodeBlock('cloneGroup7', 'expandBtn7', 'collapseBtn7')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup7"><code class="language-typescript text-sm text-gray-800">},
      include: {
        user: {
          select: {
            id: true,
            name: true,
            email: true,
            image: true,
            roles: true,
          }
        },
        skills: {
          include: {
            skill: true
          }
        }
      }
    });

    if (!builderProfile) {
      return NextResponse.json(
        { error: 'Builder profile not found' },
        { status: 404 }
      );
    }

    // Transform skills into a more readable format
    const formattedSkills = builderProfile.skills.map(skill =&gt; ({
      id: skill.skill.id,
      name: skill.skill.name,
      category: skill.skill.category,
    }));

    // Return the builder profile with user information
    return NextResponse.json({
      id: builderProfile.id,
      user</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/profiles/builder/[id]/route.ts (Line 76:3 - Line 94:7), app/api/profiles/builder/slug/[slug]/route.ts (Line 69:5 - Line 87:8)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn8" onclick="toggleCodeBlock('cloneGroup8', 'expandBtn8', 'collapseBtn8')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn8" onclick="toggleCodeBlock('cloneGroup8', 'expandBtn8', 'collapseBtn8')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup8"><code class="language-typescript text-sm text-gray-800">,
      user: {
        id: builderProfile.user.id,
        name: builderProfile.user.name,
        email: builderProfile.user.email,
        image: builderProfile.user.image,
      },
      bio: builderProfile.bio,
      headline: builderProfile.headline,
      skills: formattedSkills,
      availableForHire: builderProfile.availableForHire,
      adhdFocus: builderProfile.adhdFocus,
      validationTier: builderProfile.validationTier,
      socialLinks: builderProfile.socialLinks,
      createdAt: builderProfile.createdAt,
      updatedAt: builderProfile.updatedAt,
    });
  } catch (error) {
    logger</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/apps/edit/[id]/route.ts (Line 81:7 - Line 111:47), app/api/apps/edit/[id]/route.ts (Line 14:2 - Line 44:45)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn9" onclick="toggleCodeBlock('cloneGroup9', 'expandBtn9', 'collapseBtn9')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn9" onclick="toggleCodeBlock('cloneGroup9', 'expandBtn9', 'collapseBtn9')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup9"><code class="language-typescript text-sm text-gray-800">;
    
    // Get the app with builder info
    const app = await db.app.findUnique({
      where: { id },
      include: {
        builder: {
          include: {
            user: true
          }
        }
      }
    });
    
    if (!app) {
      return NextResponse.json(
        { error: &quot;App not found&quot; },
        { status: 404 }
      );
    }
    
    // Check if the user owns this app
    if (app.builder.user.email !== user.email) {
      // Admin check
      const currentUser = await db.user.findUnique({
        where: { email: user.email }
      });
      
      if (!currentUser?.roles.includes(&quot;ADMIN&quot;)) {
        return NextResponse.json(
          { error: &quot;You don't have permission to delete this app&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/admin/session-types/[id]/route.ts (Line 125:2 - Line 137:45), app/api/admin/session-types/[id]/route.ts (Line 26:2 - Line 38:38)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn10" onclick="toggleCodeBlock('cloneGroup10', 'expandBtn10', 'collapseBtn10')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn10" onclick="toggleCodeBlock('cloneGroup10', 'expandBtn10', 'collapseBtn10')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup10"><code class="language-typescript text-sm text-gray-800">= withAdmin(async (
  req: NextRequest,
  userId: string,
  roles: UserRole[],
  { params }: { params: { id: string } }
) =&gt; {
  const startTime = performance.now();
  const path = req.nextUrl.pathname;
  const method = req.method;
  const id = params.id;

  try {
    logger.info('Admin session type update request received'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/admin/session-types/[id]/route.ts (Line 241:30 - Line 254:32), app/api/admin/session-types/[id]/route.ts (Line 101:30 - Line 114:31)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn11" onclick="toggleCodeBlock('cloneGroup11', 'expandBtn11', 'collapseBtn11')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn11" onclick="toggleCodeBlock('cloneGroup11', 'expandBtn11', 'collapseBtn11')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup11"><code class="language-typescript text-sm text-gray-800">, {
      error: errorMessage,
      sessionTypeId: id,
      path,
      method,
      userId,
      duration: `${(performance.now() - startTime).toFixed(2)}ms`
    });
    
    Sentry.captureException(error);
    
    return createAuthErrorResponse(
      AuthErrorType.SERVER,
      'Failed to update session type'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/admin/session-types/[id]/route.ts (Line 265:2 - Line 277:47), app/api/admin/session-types/[id]/route.ts (Line 26:2 - Line 38:38)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn12" onclick="toggleCodeBlock('cloneGroup12', 'expandBtn12', 'collapseBtn12')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn12" onclick="toggleCodeBlock('cloneGroup12', 'expandBtn12', 'collapseBtn12')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup12"><code class="language-typescript text-sm text-gray-800">= withAdmin(async (
  req: NextRequest,
  userId: string,
  roles: UserRole[],
  { params }: { params: { id: string } }
) =&gt; {
  const startTime = performance.now();
  const path = req.nextUrl.pathname;
  const method = req.method;
  const id = params.id;

  try {
    logger.info('Admin session type deletion request received'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/admin/session-types/[id]/route.ts (Line 363:30 - Line 376:32), app/api/admin/session-types/[id]/route.ts (Line 101:30 - Line 114:31)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn13" onclick="toggleCodeBlock('cloneGroup13', 'expandBtn13', 'collapseBtn13')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn13" onclick="toggleCodeBlock('cloneGroup13', 'expandBtn13', 'collapseBtn13')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup13"><code class="language-typescript text-sm text-gray-800">, {
      error: errorMessage,
      sessionTypeId: id,
      path,
      method,
      userId,
      duration: `${(performance.now() - startTime).toFixed(2)}ms`
    });
    
    Sentry.captureException(error);
    
    return createAuthErrorResponse(
      AuthErrorType.SERVER,
      'Failed to delete session type'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/scheduling/calendly/service.test.ts (Line 274:37 - Line 285:50), __tests__/unit/lib/scheduling/calendly/service.test.ts (Line 191:39 - Line 202:47)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn14" onclick="toggleCodeBlock('cloneGroup14', 'expandBtn14', 'collapseBtn14')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn14" onclick="toggleCodeBlock('cloneGroup14', 'expandBtn14', 'collapseBtn14')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup14"><code class="language-typescript text-sm text-gray-800">, async () =&gt; {
      const eventId = 'test-event-id';
      const inviteeId = 'test-invitee-id';

      const webhookPayload = createMockWebhookPayload('invitee.created', eventId, inviteeId, {
        payload: {
          invitee: {
            tracking: {
              utm_source: 'buildappswith',
              utm_medium: 'scheduling',
              utm_campaign: 'booking',
              utm_content: 'session_type_id=non-existent&amp;client_id=client-1'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/scheduling/calendly/api-client.test.ts (Line 94:7 - Line 105:24), __tests__/unit/lib/scheduling/calendly/api-client.test.ts (Line 70:7 - Line 81:55)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn15" onclick="toggleCodeBlock('cloneGroup15', 'expandBtn15', 'collapseBtn15')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn15" onclick="toggleCodeBlock('cloneGroup15', 'expandBtn15', 'collapseBtn15')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup15"><code class="language-typescript text-sm text-gray-800">vi.mock('@/lib/scheduling/calendly/key-manager', () =&gt; ({
        getCalendlyKeyManager: () =&gt; ({
          getToken: () =&gt; 'test-token',
          markTokenFailed: vi.fn()
        }),
        TokenStatus: {
          ACTIVE: 'active',
          INVALID: 'invalid'
        }
      }));

      // Mock a network error</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/scheduling/calendly/api-client.test.ts (Line 120:38 - Line 133:51), __tests__/unit/lib/scheduling/calendly/api-client.test.ts (Line 92:31 - Line 81:55)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn16" onclick="toggleCodeBlock('cloneGroup16', 'expandBtn16', 'collapseBtn16')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn16" onclick="toggleCodeBlock('cloneGroup16', 'expandBtn16', 'collapseBtn16')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup16"><code class="language-typescript text-sm text-gray-800">, async () =&gt; {
      // Mock the key manager to return a token without error
      vi.mock('@/lib/scheduling/calendly/key-manager', () =&gt; ({
        getCalendlyKeyManager: () =&gt; ({
          getToken: () =&gt; 'test-token',
          markTokenFailed: vi.fn()
        }),
        TokenStatus: {
          ACTIVE: 'active',
          INVALID: 'invalid'
        }
      }));

      // Mock the users/me endpoint for the current user</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/scheduling/calendly/api-client.test.ts (Line 204:48 - Line 217:6), __tests__/unit/lib/scheduling/calendly/api-client.test.ts (Line 92:31 - Line 81:55)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn17" onclick="toggleCodeBlock('cloneGroup17', 'expandBtn17', 'collapseBtn17')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn17" onclick="toggleCodeBlock('cloneGroup17', 'expandBtn17', 'collapseBtn17')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup17"><code class="language-typescript text-sm text-gray-800">, async () =&gt; {
      // Mock the key manager to return a token without error
      vi.mock('@/lib/scheduling/calendly/key-manager', () =&gt; ({
        getCalendlyKeyManager: () =&gt; ({
          getToken: () =&gt; 'test-token',
          markTokenFailed: vi.fn()
        }),
        TokenStatus: {
          ACTIVE: 'active',
          INVALID: 'invalid'
        }
      }));

      const</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/scheduling/calendly/api-client.test.ts (Line 275:43 - Line 295:22), __tests__/unit/lib/scheduling/calendly/api-client.test.ts (Line 92:31 - Line 140:33)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn18" onclick="toggleCodeBlock('cloneGroup18', 'expandBtn18', 'collapseBtn18')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn18" onclick="toggleCodeBlock('cloneGroup18', 'expandBtn18', 'collapseBtn18')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup18"><code class="language-typescript text-sm text-gray-800">, async () =&gt; {
      // Mock the key manager to return a token without error
      vi.mock('@/lib/scheduling/calendly/key-manager', () =&gt; ({
        getCalendlyKeyManager: () =&gt; ({
          getToken: () =&gt; 'test-token',
          markTokenFailed: vi.fn()
        }),
        TokenStatus: {
          ACTIVE: 'active',
          INVALID: 'invalid'
        }
      }));

      // Mock the users/me endpoint for the current user
      mockServer.use(
        http.get('https://api.calendly.com/users/me', () =&gt; {
          return HttpResponse.json(mockCalendlyUser);
        })
      );

      // Create mock events</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/scheduling/calendly/api-client.test.ts (Line 332:45 - Line 345:55), __tests__/unit/lib/scheduling/calendly/api-client.test.ts (Line 92:31 - Line 81:55)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn19" onclick="toggleCodeBlock('cloneGroup19', 'expandBtn19', 'collapseBtn19')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn19" onclick="toggleCodeBlock('cloneGroup19', 'expandBtn19', 'collapseBtn19')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup19"><code class="language-typescript text-sm text-gray-800">, async () =&gt; {
      // Mock the key manager to return a token without error
      vi.mock('@/lib/scheduling/calendly/key-manager', () =&gt; ({
        getCalendlyKeyManager: () =&gt; ({
          getToken: () =&gt; 'test-token',
          markTokenFailed: vi.fn()
        }),
        TokenStatus: {
          ACTIVE: 'active',
          INVALID: 'invalid'
        }
      }));

      // Create a test implementation for this specific test</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/scheduling/calendly/api-client.test.ts (Line 373:43 - Line 386:10), __tests__/unit/lib/scheduling/calendly/api-client.test.ts (Line 92:31 - Line 217:12)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn20" onclick="toggleCodeBlock('cloneGroup20', 'expandBtn20', 'collapseBtn20')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn20" onclick="toggleCodeBlock('cloneGroup20', 'expandBtn20', 'collapseBtn20')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup20"><code class="language-typescript text-sm text-gray-800">, async () =&gt; {
      // Mock the key manager to return a token without error
      vi.mock('@/lib/scheduling/calendly/key-manager', () =&gt; ({
        getCalendlyKeyManager: () =&gt; ({
          getToken: () =&gt; 'test-token',
          markTokenFailed: vi.fn()
        }),
        TokenStatus: {
          ACTIVE: 'active',
          INVALID: 'invalid'
        }
      }));

      const mockEvent</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/auth/express/server-auth.test.ts (Line 292:18 - Line 303:66), __tests__/unit/lib/auth/express/server-auth.test.ts (Line 86:14 - Line 97:43)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn21" onclick="toggleCodeBlock('cloneGroup21', 'expandBtn21', 'collapseBtn21')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn21" onclick="toggleCodeBlock('cloneGroup21', 'expandBtn21', 'collapseBtn21')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup21"><code class="language-typescript text-sm text-gray-800">();
      
      expect(auth).toEqual({
        userId: 'test-user-id',
        sessionId: 'test-session-id',
        isAuthenticated: true,
        roles: [UserRole.CLIENT, UserRole.BUILDER],
        hasRole: expect.any(Function),
      });
    });
    
    it('should throw AuthenticationError when user is not authenticated'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/auth/express/server-auth.test.ts (Line 313:7 - Line 327:18), __tests__/unit/lib/auth/express/server-auth.test.ts (Line 86:2 - Line 306:18)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn22" onclick="toggleCodeBlock('cloneGroup22', 'expandBtn22', 'collapseBtn22')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn22" onclick="toggleCodeBlock('cloneGroup22', 'expandBtn22', 'collapseBtn22')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup22"><code class="language-typescript text-sm text-gray-800">);
      
      expect(auth).toEqual({
        userId: 'test-user-id',
        sessionId: 'test-session-id',
        isAuthenticated: true,
        roles: [UserRole.CLIENT, UserRole.BUILDER],
        hasRole: expect.any(Function),
      });
    });
    
    it('should throw AuthenticationError when user is not authenticated', () =&gt; {
      mockHeaders.delete('x-clerk-auth-user-id');
      
      expect(() =&gt; requireServerRole</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/auth/express/api-auth.test.ts (Line 48:2 - Line 59:23), __tests__/unit/lib/auth/express/server-auth.test.ts (Line 22:2 - Line 33:34)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn24" onclick="toggleCodeBlock('cloneGroup24', 'expandBtn24', 'collapseBtn24')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn24" onclick="toggleCodeBlock('cloneGroup24', 'expandBtn24', 'collapseBtn24')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup24"><code class="language-typescript text-sm text-gray-800">),
}));

vi.mock('@/lib/logger', () =&gt; ({
  logger: {
    debug: vi.fn(),
    info: vi.fn(),
    error: vi.fn(),
  },
}));

describe('API Route Protection'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/auth/express/api-auth.test.ts (Line 122:15 - Line 130:7), __tests__/unit/lib/auth/express/api-auth.test.ts (Line 99:2 - Line 107:13)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn25" onclick="toggleCodeBlock('cloneGroup25', 'expandBtn25', 'collapseBtn25')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn25" onclick="toggleCodeBlock('cloneGroup25', 'expandBtn25', 'collapseBtn25')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup25"><code class="language-typescript text-sm text-gray-800">);
      
      const handler = vi.fn(() =&gt; NextResponse.json({ success: true }));
      const protectedHandler = withAuth(handler);
      
      await protectedHandler(mockRequest as NextRequest);
      
      expect(handler).not.toHaveBeenCalled();
      expect(logger</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/auth/express/api-auth.test.ts (Line 188:2 - Line 203:70), __tests__/unit/lib/auth/express/api-auth.test.ts (Line 144:7 - Line 159:62)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn26" onclick="toggleCodeBlock('cloneGroup26', 'expandBtn26', 'collapseBtn26')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn26" onclick="toggleCodeBlock('cloneGroup26', 'expandBtn26', 'collapseBtn26')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup26"><code class="language-typescript text-sm text-gray-800">, handler);
      
      await protectedHandler(mockRequest as NextRequest);
      
      expect(handler).toHaveBeenCalledWith(
        expect.objectContaining({
          auth: expect.objectContaining({
            userId: 'test-user-id',
          }),
        }),
        'test-user-id',
        [UserRole.CLIENT, UserRole.BUILDER]
      );
    });
    
    it('should return 403 when user does not have any of the required roles'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/auth/express/api-auth.test.ts (Line 203:70 - Line 214:12), __tests__/unit/lib/auth/express/api-auth.test.ts (Line 159:62 - Line 170:9)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn27" onclick="toggleCodeBlock('cloneGroup27', 'expandBtn27', 'collapseBtn27')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn27" onclick="toggleCodeBlock('cloneGroup27', 'expandBtn27', 'collapseBtn27')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup27"><code class="language-typescript text-sm text-gray-800">, async () =&gt; {
      const { getAuth } = require('@clerk/express');
      getAuth.mockReturnValue({
        userId: 'test-user-id',
        sessionId: 'test-session-id',
        sessionClaims: {
          roles: [UserRole.CLIENT],
        },
      });
      
      const handler = vi.fn(() =&gt; NextResponse.json({ success: true }));
      const protectedHandler = withAnyRole</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/auth/express/api-auth.test.ts (Line 213:7 - Line 218:4), __tests__/unit/lib/auth/express/api-auth.test.ts (Line 187:7 - Line 192:21)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn28" onclick="toggleCodeBlock('cloneGroup28', 'expandBtn28', 'collapseBtn28')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn28" onclick="toggleCodeBlock('cloneGroup28', 'expandBtn28', 'collapseBtn28')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup28"><code class="language-typescript text-sm text-gray-800">const handler = vi.fn(() =&gt; NextResponse.json({ success: true }));
      const protectedHandler = withAnyRole([UserRole.ADMIN, UserRole.BUILDER], handler);
      
      await protectedHandler(mockRequest as NextRequest);
      
      expect(handler).not</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/auth/express/api-auth.test.ts (Line 214:2 - Line 229:15), __tests__/unit/lib/auth/express/api-auth.test.ts (Line 170:6 - Line 185:14)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn29" onclick="toggleCodeBlock('cloneGroup29', 'expandBtn29', 'collapseBtn29')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn29" onclick="toggleCodeBlock('cloneGroup29', 'expandBtn29', 'collapseBtn29')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup29"><code class="language-typescript text-sm text-gray-800">, handler);
      
      await protectedHandler(mockRequest as NextRequest);
      
      expect(handler).not.toHaveBeenCalled();
      expect(NextResponse.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: false,
          message: 'Insufficient permissions',
        }),
        { status: 403 }
      );
    });
  });

  describe('withAllRoles'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/auth/express/api-auth.test.ts (Line 232:7 - Line 247:63), __tests__/unit/lib/auth/express/api-auth.test.ts (Line 188:6 - Line 159:62)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn30" onclick="toggleCodeBlock('cloneGroup30', 'expandBtn30', 'collapseBtn30')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn30" onclick="toggleCodeBlock('cloneGroup30', 'expandBtn30', 'collapseBtn30')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup30"><code class="language-typescript text-sm text-gray-800">, UserRole.BUILDER], handler);
      
      await protectedHandler(mockRequest as NextRequest);
      
      expect(handler).toHaveBeenCalledWith(
        expect.objectContaining({
          auth: expect.objectContaining({
            userId: 'test-user-id',
          }),
        }),
        'test-user-id',
        [UserRole.CLIENT, UserRole.BUILDER]
      );
    });
    
    it('should return 403 when user does not have all required roles'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/auth/express/api-auth.test.ts (Line 247:63 - Line 258:13), __tests__/unit/lib/auth/express/api-auth.test.ts (Line 159:62 - Line 170:9)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn31" onclick="toggleCodeBlock('cloneGroup31', 'expandBtn31', 'collapseBtn31')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn31" onclick="toggleCodeBlock('cloneGroup31', 'expandBtn31', 'collapseBtn31')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup31"><code class="language-typescript text-sm text-gray-800">, async () =&gt; {
      const { getAuth } = require('@clerk/express');
      getAuth.mockReturnValue({
        userId: 'test-user-id',
        sessionId: 'test-session-id',
        sessionClaims: {
          roles: [UserRole.CLIENT],
        },
      });
      
      const handler = vi.fn(() =&gt; NextResponse.json({ success: true }));
      const protectedHandler = withAllRoles</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/auth/express/api-auth.test.ts (Line 257:7 - Line 262:4), __tests__/unit/lib/auth/express/api-auth.test.ts (Line 231:7 - Line 236:21)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn32" onclick="toggleCodeBlock('cloneGroup32', 'expandBtn32', 'collapseBtn32')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn32" onclick="toggleCodeBlock('cloneGroup32', 'expandBtn32', 'collapseBtn32')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup32"><code class="language-typescript text-sm text-gray-800">const handler = vi.fn(() =&gt; NextResponse.json({ success: true }));
      const protectedHandler = withAllRoles([UserRole.CLIENT, UserRole.BUILDER], handler);
      
      await protectedHandler(mockRequest as NextRequest);
      
      expect(handler).not</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/auth/express/api-auth.test.ts (Line 258:7 - Line 273:25), __tests__/unit/lib/auth/express/api-auth.test.ts (Line 214:6 - Line 185:14)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn33" onclick="toggleCodeBlock('cloneGroup33', 'expandBtn33', 'collapseBtn33')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn33" onclick="toggleCodeBlock('cloneGroup33', 'expandBtn33', 'collapseBtn33')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup33"><code class="language-typescript text-sm text-gray-800">, UserRole.BUILDER], handler);
      
      await protectedHandler(mockRequest as NextRequest);
      
      expect(handler).not.toHaveBeenCalled();
      expect(NextResponse.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: false,
          message: 'Insufficient permissions',
        }),
        { status: 403 }
      );
    });
  });

  describe('Role-specific wrappers'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/auth/express/api-auth.test.ts (Line 329:15 - Line 343:3), __tests__/unit/lib/auth/express/api-auth.test.ts (Line 170:6 - Line 183:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn34" onclick="toggleCodeBlock('cloneGroup34', 'expandBtn34', 'collapseBtn34')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn34" onclick="toggleCodeBlock('cloneGroup34', 'expandBtn34', 'collapseBtn34')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup34"><code class="language-typescript text-sm text-gray-800">, handler);
      
      await protectedHandler(mockRequest as NextRequest);
      
      expect(handler).not.toHaveBeenCalled();
      expect(NextResponse.json).toHaveBeenCalledWith(
        expect.objectContaining({
          success: false,
          message: 'Insufficient permissions',
        }),
        { status: 403 }
      );
    });
    
    it</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/auth/express/adapter.test.ts (Line 6:1 - Line 16:16), __tests__/unit/lib/auth/express/api-auth.test.ts (Line 7:1 - Line 17:12)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn35" onclick="toggleCodeBlock('cloneGroup35', 'expandBtn35', 'collapseBtn35')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn35" onclick="toggleCodeBlock('cloneGroup35', 'expandBtn35', 'collapseBtn35')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup35"><code class="language-typescript text-sm text-gray-800">vi.mock('next/server', () =&gt; ({
  NextRequest: vi.fn(),
  NextResponse: {
    next: vi.fn(() =&gt; ({ headers: new Map() })),
    redirect: vi.fn((url) =&gt; ({ headers: new Map(), url })),
    json: vi.fn((body, options) =&gt; ({ body, options, headers: new Map() })),
  },
}));

vi.mock('@clerk/express', () =&gt; ({
  clerkMiddleware</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/auth/express/adapter.test.ts (Line 16:16 - Line 24:2), __tests__/unit/lib/auth/express/api-auth.test.ts (Line 17:12 - Line 25:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn36" onclick="toggleCodeBlock('cloneGroup36', 'expandBtn36', 'collapseBtn36')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn36" onclick="toggleCodeBlock('cloneGroup36', 'expandBtn36', 'collapseBtn36')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup36"><code class="language-typescript text-sm text-gray-800">: vi.fn(() =&gt; async (req: any, res: any, next: any) =&gt; {
    next();
    return true;
  }),
  getAuth: vi.fn(() =&gt; ({
    userId: 'test-user-id',
    sessionId: 'test-session-id',
    sessionClaims: {
      roles: ['CLIENT']</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/auth/express/adapter.test.ts (Line 25:2 - Line 37:28), __tests__/unit/lib/auth/express/api-auth.test.ts (Line 47:2 - Line 33:34)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn37" onclick="toggleCodeBlock('cloneGroup37', 'expandBtn37', 'collapseBtn37')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn37" onclick="toggleCodeBlock('cloneGroup37', 'expandBtn37', 'collapseBtn37')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup37"><code class="language-typescript text-sm text-gray-800">,
  })),
}));

vi.mock('@/lib/logger', () =&gt; ({
  logger: {
    debug: vi.fn(),
    info: vi.fn(),
    error: vi.fn(),
  },
}));

describe('Clerk Express SDK Adapter'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/webhooks/calendly/route.ts (Line 162:36 - Line 182:43), app/api/webhooks/stripe/route.ts (Line 124:34 - Line 144:33)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn41" onclick="toggleCodeBlock('cloneGroup41', 'expandBtn41', 'collapseBtn41')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn41" onclick="toggleCodeBlock('cloneGroup41', 'expandBtn41', 'collapseBtn41')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup41"><code class="language-typescript text-sm text-gray-800">, {
      error: error instanceof Error ? error.message : String(error)
    });
    
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}

/**
 * Handle OPTIONS requests for CORS preflight
 */
export async function OPTIONS() {
  return new NextResponse(null, {
    status: 200,
    headers: {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, calendly-webhook-signature'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/session-types/route.ts (Line 30:1 - Line 41:8), app/api/scheduling/time-slots/route.ts (Line 33:1 - Line 44:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn42" onclick="toggleCodeBlock('cloneGroup42', 'expandBtn42', 'collapseBtn42')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn42" onclick="toggleCodeBlock('cloneGroup42', 'expandBtn42', 'collapseBtn42')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup42"><code class="language-typescript text-sm text-gray-800">export async function GET(request: NextRequest) {
  try {
    // Get query parameters
    const { searchParams } = new URL(request.url);
    const rawParams = Object.fromEntries(searchParams.entries());
    
    // Parse and validate parameters
    const result = querySchema.safeParse(rawParams);
    
    if (!result.success) {
      return NextResponse.json(
        { error: 'Invalid query parameters', details: result.error.flatten</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/builder-settings/route.ts (Line 23:8 - Line 44:4), app/api/scheduling/time-slots/route.ts (Line 11:7 - Line 32:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn43" onclick="toggleCodeBlock('cloneGroup43', 'expandBtn43', 'collapseBtn43')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn43" onclick="toggleCodeBlock('cloneGroup43', 'expandBtn43', 'collapseBtn43')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup43"><code class="language-typescript text-sm text-gray-800">().optional(),
});

/**
 * Helper function to handle service errors with appropriate responses
 */
function handleServiceError(error: any, defaultMessage: string): NextResponse {
  console.error(defaultMessage, error);
  Sentry.captureException(error);
  
  // Extract readable error message if available
  const errorMessage = error.message || defaultMessage;
  
  return NextResponse.json(
    { error: errorMessage }, 
    { status: 500 }
  );
}

/**
 * Helper to check if user has permission to modify a builder's settings
 */</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/builder-settings/route.ts (Line 55:2 - Line 71:2), app/api/scheduling/time-slots/route.ts (Line 33:2 - Line 49:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn44" onclick="toggleCodeBlock('cloneGroup44', 'expandBtn44', 'collapseBtn44')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn44" onclick="toggleCodeBlock('cloneGroup44', 'expandBtn44', 'collapseBtn44')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup44"><code class="language-typescript text-sm text-gray-800">{
  try {
    // Get query parameters
    const { searchParams } = new URL(request.url);
    const rawParams = Object.fromEntries(searchParams.entries());
    
    // Parse and validate parameters
    const result = querySchema.safeParse(rawParams);
    
    if (!result.success) {
      return NextResponse.json(
        { error: 'Invalid query parameters', details: result.error.format() }, 
        { status: 400 }
      );
    }
    
    const { builderId }</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/bookings/route.ts (Line 143:10 - Line 165:25), app/api/scheduling/bookings/[bookingId]/route.ts (Line 99:10 - Line 121:25)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn45" onclick="toggleCodeBlock('cloneGroup45', 'expandBtn45', 'collapseBtn45')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn45" onclick="toggleCodeBlock('cloneGroup45', 'expandBtn45', 'collapseBtn45')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup45"><code class="language-typescript text-sm text-gray-800">,
      duration: `${(performance.now() - startTime).toFixed(2)}ms`
    });

    // Create response with standardized format
    const response = NextResponse.json({
      success: true,
      data: { booking }
    });

    // Add performance metrics to the response
    return addAuthPerformanceMetrics(
      response, 
      startTime, 
      true, 
      path, 
      method, 
      userId
    );
  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : String(error);
    
    logger.error('Error creating booking'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/bookings/route.ts (Line 293:26 - Line 305:26), app/api/scheduling/bookings/route.ts (Line 165:25 - Line 177:25)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn46" onclick="toggleCodeBlock('cloneGroup46', 'expandBtn46', 'collapseBtn46')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn46" onclick="toggleCodeBlock('cloneGroup46', 'expandBtn46', 'collapseBtn46')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup46"><code class="language-typescript text-sm text-gray-800">, {
      error: errorMessage,
      path,
      method,
      userId,
      duration: `${(performance.now() - startTime).toFixed(2)}ms`
    });
    
    Sentry.captureException(error);
    
    return createAuthErrorResponse(
      AuthErrorType.SERVER,
      'Error fetching bookings'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/availability-rules/route.ts (Line 8:1 - Line 19:64), app/api/scheduling/builder-settings/route.ts (Line 6:1 - Line 17:62)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn47" onclick="toggleCodeBlock('cloneGroup47', 'expandBtn47', 'collapseBtn47')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn47" onclick="toggleCodeBlock('cloneGroup47', 'expandBtn47', 'collapseBtn47')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup47"><code class="language-typescript text-sm text-gray-800">} from '@/lib/scheduling/real-data/scheduling-service';
import { withAuth } from '@/lib/auth/clerk/api-auth';
import { AuthUser } from '@/lib/auth/clerk/helpers';
import { UserRole } from '@/lib/auth/types';
import * as Sentry from '@sentry/nextjs';

// Validation schema for query parameters
const querySchema = z.object({
  builderId: z.string().min(1, 'Builder ID is required'),
});

// Validation schema for creating/updating an availability rule</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/availability-rules/route.ts (Line 29:1 - Line 49:4), app/api/scheduling/time-slots/route.ts (Line 12:1 - Line 32:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn48" onclick="toggleCodeBlock('cloneGroup48', 'expandBtn48', 'collapseBtn48')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn48" onclick="toggleCodeBlock('cloneGroup48', 'expandBtn48', 'collapseBtn48')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup48"><code class="language-typescript text-sm text-gray-800">});

/**
 * Helper function to handle service errors with appropriate responses
 */
function handleServiceError(error: any, defaultMessage: string): NextResponse {
  console.error(defaultMessage, error);
  Sentry.captureException(error);
  
  // Extract readable error message if available
  const errorMessage = error.message || defaultMessage;
  
  return NextResponse.json(
    { error: errorMessage }, 
    { status: 500 }
  );
}

/**
 * Helper to check if user has permission to modify a builder's availability
 */</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/availability-rules/route.ts (Line 50:1 - Line 59:4), app/api/scheduling/builder-settings/route.ts (Line 45:1 - Line 54:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn49" onclick="toggleCodeBlock('cloneGroup49', 'expandBtn49', 'collapseBtn49')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn49" onclick="toggleCodeBlock('cloneGroup49', 'expandBtn49', 'collapseBtn49')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup49"><code class="language-typescript text-sm text-gray-800">function hasPermission(user: AuthUser, builderId: string): boolean {
  const isAdmin = user.roles.includes(UserRole.ADMIN);
  const isBuilder = user.roles.includes(UserRole.BUILDER);
  const isOwnProfile = user.id === builderId;
  return isAdmin || (isBuilder &amp;&amp; isOwnProfile);
}

/**
 * GET handler for fetching availability rules for a builder
 */</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/availability-rules/route.ts (Line 60:1 - Line 78:28), app/api/scheduling/time-slots/route.ts (Line 33:1 - Line 73:23)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn50" onclick="toggleCodeBlock('cloneGroup50', 'expandBtn50', 'collapseBtn50')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn50" onclick="toggleCodeBlock('cloneGroup50', 'expandBtn50', 'collapseBtn50')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup50"><code class="language-typescript text-sm text-gray-800">export async function GET(request: NextRequest) {
  try {
    // Get query parameters
    const { searchParams } = new URL(request.url);
    const rawParams = Object.fromEntries(searchParams.entries());
    
    // Parse and validate parameters
    const result = querySchema.safeParse(rawParams);
    
    if (!result.success) {
      return NextResponse.json(
        { error: 'Invalid query parameters', details: result.error.format() }, 
        { status: 400 }
      );
    }
    
    const { builderId } = result.data;
    
    // Fetch availability rules</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/availability-rules/route.ts (Line 178:2 - Line 190:39), app/api/scheduling/availability-rules/route.ts (Line 129:2 - Line 141:22)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn51" onclick="toggleCodeBlock('cloneGroup51', 'expandBtn51', 'collapseBtn51')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn51" onclick="toggleCodeBlock('cloneGroup51', 'expandBtn51', 'collapseBtn51')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup51"><code class="language-typescript text-sm text-gray-800">= withAuth(async (request: NextRequest, user: AuthUser, { params }: { params: { id: string } }) =&gt; {
  try {
    // Get rule ID from URL
    const id = params?.id;
    
    if (!id) {
      return NextResponse.json(
        { error: 'Availability rule ID is required' }, 
        { status: 400 }
      );
    }
    
    // Get the rule to check authorization</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/availability-exceptions/route.ts (Line 9:1 - Line 18:10), app/api/scheduling/builder-settings/route.ts (Line 6:1 - Line 15:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn52" onclick="toggleCodeBlock('cloneGroup52', 'expandBtn52', 'collapseBtn52')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn52" onclick="toggleCodeBlock('cloneGroup52', 'expandBtn52', 'collapseBtn52')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup52"><code class="language-typescript text-sm text-gray-800">} from '@/lib/scheduling/real-data/scheduling-service';
import { withAuth } from '@/lib/auth/clerk/api-auth';
import { AuthUser } from '@/lib/auth/clerk/helpers';
import { UserRole } from '@/lib/auth/types';
import * as Sentry from '@sentry/nextjs';

// Validation schema for query parameters
const querySchema = z.object({
  builderId: z.string().min(1, 'Builder ID is required'),
  startDate</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/availability-exceptions/route.ts (Line 40:8 - Line 71:4), app/api/scheduling/availability-rules/route.ts (Line 28:12 - Line 54:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn53" onclick="toggleCodeBlock('cloneGroup53', 'expandBtn53', 'collapseBtn53')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn53" onclick="toggleCodeBlock('cloneGroup53', 'expandBtn53', 'collapseBtn53')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup53"><code class="language-typescript text-sm text-gray-800">]
});

/**
 * Helper function to handle service errors with appropriate responses
 */
function handleServiceError(error: any, defaultMessage: string): NextResponse {
  console.error(defaultMessage, error);
  Sentry.captureException(error);
  
  // Extract readable error message if available
  const errorMessage = error.message || defaultMessage;
  
  return NextResponse.json(
    { error: errorMessage }, 
    { status: 500 }
  );
}

/**
 * Helper to check if user has permission to modify a builder's availability
 */
function hasPermission(user: AuthUser, builderId: string): boolean {
  const isAdmin = user.roles.includes(UserRole.ADMIN);
  const isBuilder = user.roles.includes(UserRole.BUILDER);
  const isOwnProfile = user.id === builderId;
  return isAdmin || (isBuilder &amp;&amp; isOwnProfile);
}

/**
 * GET handler for fetching availability exceptions for a builder
 */</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/availability-exceptions/route.ts (Line 72:1 - Line 88:2), app/api/scheduling/time-slots/route.ts (Line 33:1 - Line 49:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn54" onclick="toggleCodeBlock('cloneGroup54', 'expandBtn54', 'collapseBtn54')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn54" onclick="toggleCodeBlock('cloneGroup54', 'expandBtn54', 'collapseBtn54')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup54"><code class="language-typescript text-sm text-gray-800">export async function GET(request: NextRequest) {
  try {
    // Get query parameters
    const { searchParams } = new URL(request.url);
    const rawParams = Object.fromEntries(searchParams.entries());
    
    // Parse and validate parameters
    const result = querySchema.safeParse(rawParams);
    
    if (!result.success) {
      return NextResponse.json(
        { error: 'Invalid query parameters', details: result.error.format() }, 
        { status: 400 }
      );
    }
    
    const { builderId, startDate, endDate }</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/availability-exceptions/route.ts (Line 181:2 - Line 193:22), app/api/scheduling/availability-exceptions/route.ts (Line 141:2 - Line 153:21)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn55" onclick="toggleCodeBlock('cloneGroup55', 'expandBtn55', 'collapseBtn55')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn55" onclick="toggleCodeBlock('cloneGroup55', 'expandBtn55', 'collapseBtn55')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup55"><code class="language-typescript text-sm text-gray-800">= withAuth(async (request: NextRequest, user: AuthUser, { params }: { params: { id: string } }) =&gt; {
  try {
    // Get exception ID from URL
    const id = params?.id;
    
    if (!id) {
      return NextResponse.json(
        { error: 'Availability exception ID is required' }, 
        { status: 400 }
      );
    }
    
    // Parse request body</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/availability-exceptions/route.ts (Line 248:2 - Line 260:45), app/api/scheduling/availability-exceptions/route.ts (Line 141:2 - Line 153:21)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn56" onclick="toggleCodeBlock('cloneGroup56', 'expandBtn56', 'collapseBtn56')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn56" onclick="toggleCodeBlock('cloneGroup56', 'expandBtn56', 'collapseBtn56')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup56"><code class="language-typescript text-sm text-gray-800">= withAuth(async (request: NextRequest, user: AuthUser, { params }: { params: { id: string } }) =&gt; {
  try {
    // Get exception ID from URL
    const id = params?.id;
    
    if (!id) {
      return NextResponse.json(
        { error: 'Availability exception ID is required' }, 
        { status: 400 }
      );
    }
    
    // Get the exception for authorization check</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/scheduling/availability-exceptions/route.ts (Line 261:5 - Line 273:55), app/api/scheduling/availability-exceptions/route.ts (Line 154:5 - Line 166:55)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn57" onclick="toggleCodeBlock('cloneGroup57', 'expandBtn57', 'collapseBtn57')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn57" onclick="toggleCodeBlock('cloneGroup57', 'expandBtn57', 'collapseBtn57')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup57"><code class="language-typescript text-sm text-gray-800">const exception = await getAvailabilityExceptionById(id);
    
    if (!exception) {
      return NextResponse.json(
        { error: 'Availability exception not found' }, 
        { status: 404 }
      );
    }
    
    // Authorization check
    if (!hasPermission(user, exception.builderId)) {
      return NextResponse.json(
        { error: 'Not authorized to delete this availability exception'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/profiles/builder/route.ts (Line 137:2 - Line 143:27), app/api/profiles/builder/route.ts (Line 38:2 - Line 44:27)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn58" onclick="toggleCodeBlock('cloneGroup58', 'expandBtn58', 'collapseBtn58')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn58" onclick="toggleCodeBlock('cloneGroup58', 'expandBtn58', 'collapseBtn58')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup58"><code class="language-typescript text-sm text-gray-800">= withBuilder(async (req: NextRequest, userId: string, roles: UserRole[]) =&gt; {
  const startTime = performance.now();
  const path = req.nextUrl.pathname;
  const method = req.method;

  try {
    logger.debug('Updating builder profile'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/admin/session-types/route.ts (Line 27:10 - Line 33:39), app/api/scheduling/bookings/route.ts (Line 31:11 - Line 37:36)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn59" onclick="toggleCodeBlock('cloneGroup59', 'expandBtn59', 'collapseBtn59')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn59" onclick="toggleCodeBlock('cloneGroup59', 'expandBtn59', 'collapseBtn59')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup59"><code class="language-typescript text-sm text-gray-800">(async (req: NextRequest, userId: string, roles: UserRole[]) =&gt; {
  const startTime = performance.now();
  const path = req.nextUrl.pathname;
  const method = req.method;

  try {
    logger.info('Admin session types request received'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/admin/session-types/route.ts (Line 84:31 - Line 96:32), app/api/scheduling/bookings/route.ts (Line 165:25 - Line 177:25)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn60" onclick="toggleCodeBlock('cloneGroup60', 'expandBtn60', 'collapseBtn60')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn60" onclick="toggleCodeBlock('cloneGroup60', 'expandBtn60', 'collapseBtn60')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup60"><code class="language-typescript text-sm text-gray-800">, {
      error: errorMessage,
      path,
      method,
      userId,
      duration: `${(performance.now() - startTime).toFixed(2)}ms`
    });
    
    Sentry.captureException(error);
    
    return createAuthErrorResponse(
      AuthErrorType.SERVER,
      'Failed to fetch session types'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/admin/session-types/route.ts (Line 107:2 - Line 113:47), app/api/admin/session-types/route.ts (Line 27:2 - Line 37:36)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn61" onclick="toggleCodeBlock('cloneGroup61', 'expandBtn61', 'collapseBtn61')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn61" onclick="toggleCodeBlock('cloneGroup61', 'expandBtn61', 'collapseBtn61')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup61"><code class="language-typescript text-sm text-gray-800">= withAdmin(async (req: NextRequest, userId: string, roles: UserRole[]) =&gt; {
  const startTime = performance.now();
  const path = req.nextUrl.pathname;
  const method = req.method;

  try {
    logger.info('Admin session type creation request received'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/admin/session-types/route.ts (Line 195:30 - Line 207:32), app/api/scheduling/bookings/route.ts (Line 165:25 - Line 177:25)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn62" onclick="toggleCodeBlock('cloneGroup62', 'expandBtn62', 'collapseBtn62')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn62" onclick="toggleCodeBlock('cloneGroup62', 'expandBtn62', 'collapseBtn62')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup62"><code class="language-typescript text-sm text-gray-800">, {
      error: errorMessage,
      path,
      method,
      userId,
      duration: `${(performance.now() - startTime).toFixed(2)}ms`
    });
    
    Sentry.captureException(error);
    
    return createAuthErrorResponse(
      AuthErrorType.SERVER,
      'Failed to create session type'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/admin/builders/route.ts (Line 12:1 - Line 19:39), app/api/admin/session-types/route.ts (Line 26:1 - Line 37:36)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn63" onclick="toggleCodeBlock('cloneGroup63', 'expandBtn63', 'collapseBtn63')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn63" onclick="toggleCodeBlock('cloneGroup63', 'expandBtn63', 'collapseBtn63')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup63"><code class="language-typescript text-sm text-gray-800">// Updated to use Express SDK with admin role check
export const GET = withAdmin(async (req: NextRequest, userId: string, roles: UserRole[]) =&gt; {
  const startTime = performance.now();
  const path = req.nextUrl.pathname;
  const method = req.method;

  try {
    logger.info('Admin builders list request received'</code></pre></div><div class="py-4"><p class="text-gray-600">app/api/admin/builders/route.ts (Line 84:26 - Line 96:27), app/api/scheduling/bookings/route.ts (Line 165:25 - Line 177:25)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn64" onclick="toggleCodeBlock('cloneGroup64', 'expandBtn64', 'collapseBtn64')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn64" onclick="toggleCodeBlock('cloneGroup64', 'expandBtn64', 'collapseBtn64')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup64"><code class="language-typescript text-sm text-gray-800">, {
      error: errorMessage,
      path,
      method,
      userId,
      duration: `${(performance.now() - startTime).toFixed(2)}ms`
    });
    
    Sentry.captureException(error);
    
    return createAuthErrorResponse(
      AuthErrorType.SERVER,
      'Failed to fetch builders'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/scheduling/state-machine/state-machine.test.ts (Line 93:15 - Line 105:19), __tests__/unit/scheduling/state-machine/state-machine.test.ts (Line 80:7 - Line 92:30)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn68" onclick="toggleCodeBlock('cloneGroup68', 'expandBtn68', 'collapseBtn68')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn68" onclick="toggleCodeBlock('cloneGroup68', 'expandBtn68', 'collapseBtn68')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup68"><code class="language-typescript text-sm text-gray-800">: {
    info: vi.fn(),
    debug: vi.fn(),
    warn: vi.fn(),
    error: vi.fn(),
    child: vi.fn().mockReturnValue({
      info: vi.fn(),
      debug: vi.fn(),
      warn: vi.fn(),
      error: vi.fn()
    })
  },
  createDomainLogger</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/scheduling/state-machine/security.test.ts (Line 16:2 - Line 114:34), __tests__/unit/scheduling/state-machine/state-machine.test.ts (Line 15:39 - Line 113:24)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn69" onclick="toggleCodeBlock('cloneGroup69', 'expandBtn69', 'collapseBtn69')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn69" onclick="toggleCodeBlock('cloneGroup69', 'expandBtn69', 'collapseBtn69')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup69"><code class="language-typescript text-sm text-gray-800">;

// Mock dependencies
// Mock Datadog config
vi.mock('@/lib/datadog/config', () =&gt; ({
  getDatadogConfig: vi.fn().mockReturnValue({
    enabled: false,
    service: 'test-service',
    env: 'test',
    version: '1.0.0',
    site: 'us1.datadoghq.com',
    logSampleRate: 1.0
  })
}));

// Mock Datadog
vi.mock('dd-trace', () =&gt; ({
  tracer: {
    scope: () =&gt; ({
      active: () =&gt; ({
        context: () =&gt; ({
          toTraceId: () =&gt; 'test-trace-id',
          toSpanId: () =&gt; 'test-span-id'
        })
      })
    })
  }
}));

// Mock Sentry
vi.mock('@sentry/nextjs', () =&gt; ({
  captureMessage: vi.fn(),
  captureException: vi.fn(),
  withScope: vi.fn((callback) =&gt; callback({
    setTag: vi.fn(),
    setExtra: vi.fn(),
    setLevel: vi.fn()
  }))
}));

// Mock db
vi.mock('@/lib/db', () =&gt; ({
  db: {
    booking: {
      findUnique: vi.fn(),
      create: vi.fn(),
      update: vi.fn(),
      delete: vi.fn(),
    },
    $transaction: vi.fn().mockImplementation(async (callback) =&gt; {
      return callback({
        booking: {
          update: vi.fn(),
          create: vi.fn(),
        },
        stateTransitionLog: {
          create: vi.fn(),
        }
      });
    }),
  },
  prisma: vi.fn(),
}));

vi.mock('@/lib/logger', () =&gt; ({
  logger: {
    info: vi.fn(),
    debug: vi.fn(),
    warn: vi.fn(),
    error: vi.fn(),
    child: vi.fn().mockReturnValue({
      info: vi.fn(),
      debug: vi.fn(),
      warn: vi.fn(),
      error: vi.fn()
    })
  },
  // For backward compatibility
  enhancedLogger: {
    info: vi.fn(),
    debug: vi.fn(),
    warn: vi.fn(),
    error: vi.fn(),
    child: vi.fn().mockReturnValue({
      info: vi.fn(),
      debug: vi.fn(),
      warn: vi.fn(),
      error: vi.fn()
    })
  },
  createDomainLogger: vi.fn().mockReturnValue({
    info: vi.fn(),
    debug: vi.fn(),
    warn: vi.fn(),
    error: vi.fn()
  })
}));

describe('State Machine Security Features'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/scheduling/state-machine/error-handling.test.ts (Line 111:2 - Line 210:35), __tests__/unit/scheduling/state-machine/security.test.ts (Line 15:7 - Line 113:9)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn70" onclick="toggleCodeBlock('cloneGroup70', 'expandBtn70', 'collapseBtn70')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn70" onclick="toggleCodeBlock('cloneGroup70', 'expandBtn70', 'collapseBtn70')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup70"><code class="language-typescript text-sm text-gray-800">;
});

// Mock dependencies
// Mock Datadog config
vi.mock('@/lib/datadog/config', () =&gt; ({
  getDatadogConfig: vi.fn().mockReturnValue({
    enabled: false,
    service: 'test-service',
    env: 'test',
    version: '1.0.0',
    site: 'us1.datadoghq.com',
    logSampleRate: 1.0
  })
}));

// Mock Datadog
vi.mock('dd-trace', () =&gt; ({
  tracer: {
    scope: () =&gt; ({
      active: () =&gt; ({
        context: () =&gt; ({
          toTraceId: () =&gt; 'test-trace-id',
          toSpanId: () =&gt; 'test-span-id'
        })
      })
    })
  }
}));

// Mock Sentry
vi.mock('@sentry/nextjs', () =&gt; ({
  captureMessage: vi.fn(),
  captureException: vi.fn(),
  withScope: vi.fn((callback) =&gt; callback({
    setTag: vi.fn(),
    setExtra: vi.fn(),
    setLevel: vi.fn()
  }))
}));

// Mock db
vi.mock('@/lib/db', () =&gt; ({
  db: {
    booking: {
      findUnique: vi.fn(),
      create: vi.fn(),
      update: vi.fn(),
      delete: vi.fn(),
    },
    $transaction: vi.fn().mockImplementation(async (callback) =&gt; {
      return callback({
        booking: {
          update: vi.fn(),
          create: vi.fn(),
        },
        stateTransitionLog: {
          create: vi.fn(),
        }
      });
    }),
  },
  prisma: vi.fn(),
}));

vi.mock('@/lib/logger', () =&gt; ({
  logger: {
    info: vi.fn(),
    debug: vi.fn(),
    warn: vi.fn(),
    error: vi.fn(),
    child: vi.fn().mockReturnValue({
      info: vi.fn(),
      debug: vi.fn(),
      warn: vi.fn(),
      error: vi.fn()
    })
  },
  // For backward compatibility
  enhancedLogger: {
    info: vi.fn(),
    debug: vi.fn(),
    warn: vi.fn(),
    error: vi.fn(),
    child: vi.fn().mockReturnValue({
      info: vi.fn(),
      debug: vi.fn(),
      warn: vi.fn(),
      error: vi.fn()
    })
  },
  createDomainLogger: vi.fn().mockReturnValue({
    info: vi.fn(),
    debug: vi.fn(),
    warn: vi.fn(),
    error: vi.fn()
  })
}));

// Mock state machine dependencies</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/sentry/user-context.test.ts (Line 211:12 - Line 223:60), __tests__/unit/lib/sentry/user-context.test.ts (Line 160:2 - Line 171:44)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn71" onclick="toggleCodeBlock('cloneGroup71', 'expandBtn71', 'collapseBtn71')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn71" onclick="toggleCodeBlock('cloneGroup71', 'expandBtn71', 'collapseBtn71')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup71"><code class="language-typescript text-sm text-gray-800">);
      
      expect(Sentry.configureScope).toHaveBeenCalled();
      
      // Get the scope from the callback
      const scopeCallback = Sentry.configureScope.mock.calls[0][0];
      const mockScope = { 
        setUser: vi.fn(),
        setContext: vi.fn(),
      };
      scopeCallback(mockScope);
      
      // Check request context was set with direct request values</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/sentry/error-classification.test.ts (Line 136:7 - Line 146:4), __tests__/unit/lib/sentry/error-classification.test.ts (Line 91:7 - Line 101:9)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn72" onclick="toggleCodeBlock('cloneGroup72', 'expandBtn72', 'collapseBtn72')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn72" onclick="toggleCodeBlock('cloneGroup72', 'expandBtn72', 'collapseBtn72')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup72"><code class="language-typescript text-sm text-gray-800">const mockScope = {
        setTag: vi.fn(),
        setContext: vi.fn(),
        setLevel: vi.fn(),
      };
      
      // Call the callback with our mock scope
      scopeCallback(mockScope);
      
      // Verify the scope was configured correctly
      expect(mockScope.setTag).toHaveBeenCalledWith('error.severity', ErrorSeverity.LOW</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/sentry/error-classification.test.ts (Line 173:6 - Line 186:52), __tests__/unit/lib/sentry/error-classification.test.ts (Line 132:9 - Line 145:45)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn73" onclick="toggleCodeBlock('cloneGroup73', 'expandBtn73', 'collapseBtn73')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn73" onclick="toggleCodeBlock('cloneGroup73', 'expandBtn73', 'collapseBtn73')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup73"><code class="language-typescript text-sm text-gray-800">);
      
      // Extract the callback function
      const scopeCallback = Sentry.withScope.mock.calls[0][0];
      const mockScope = {
        setTag: vi.fn(),
        setContext: vi.fn(),
        setLevel: vi.fn(),
      };
      
      // Call the callback with our mock scope
      scopeCallback(mockScope);
      
      // Verify that domain metadata was passed correctly</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/sentry/error-classification.test.ts (Line 198:34 - Line 212:7), __tests__/unit/lib/sentry/error-classification.test.ts (Line 132:9 - Line 187:10)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn74" onclick="toggleCodeBlock('cloneGroup74', 'expandBtn74', 'collapseBtn74')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn74" onclick="toggleCodeBlock('cloneGroup74', 'expandBtn74', 'collapseBtn74')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup74"><code class="language-typescript text-sm text-gray-800">);
      
      // Extract the callback function
      const scopeCallback = Sentry.withScope.mock.calls[0][0];
      const mockScope = {
        setTag: vi.fn(),
        setContext: vi.fn(),
        setLevel: vi.fn(),
      };
      
      // Call the callback with our mock scope
      scopeCallback(mockScope);
      
      // Verify that domain metadata was passed correctly
      expect(mockScope.setTag).toHaveBeenCalledWith('error.component', 'auth'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/sentry/client-instrumentation.test.ts (Line 11:27 - Line 24:32), __tests__/unit/lib/sentry/instrumentation.test.ts (Line 14:20 - Line 27:25)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn75" onclick="toggleCodeBlock('cloneGroup75', 'expandBtn75', 'collapseBtn75')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn75" onclick="toggleCodeBlock('cloneGroup75', 'expandBtn75', 'collapseBtn75')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup75"><code class="language-typescript text-sm text-gray-800">: vi.fn(),
}));

// Mock lib/sentry
vi.mock('../../../../lib/sentry', () =&gt; ({
  getInitializationConfig: vi.fn().mockReturnValue({
    dsn: 'https://mock-dsn@ingest.de.sentry.io/123456',
    region: 'eu',
  }),
  configureSentryDataFiltering: vi.fn((config) =&gt; ({ ...config, filtered: true })),
  configureSentryPerformance: vi.fn((config) =&gt; ({ ...config, performanceConfig: true })),
}));

describe('Sentry Client Instrumentation'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/sentry/client-instrumentation.test.ts (Line 59:5 - Line 69:51), __tests__/unit/lib/sentry/instrumentation.test.ts (Line 56:2 - Line 66:53)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn76" onclick="toggleCodeBlock('cloneGroup76', 'expandBtn76', 'collapseBtn76')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn76" onclick="toggleCodeBlock('cloneGroup76', 'expandBtn76', 'collapseBtn76')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup76"><code class="language-typescript text-sm text-gray-800">register();
    
    // Verify Sentry init was called with correct config
    expect(Sentry.init).toHaveBeenCalledTimes(1);
    const initCall = Sentry.init.mock.calls[0][0];
    expect(initCall.region).toBe('eu');
    expect(initCall.filtered).toBe(true);
    expect(initCall.performanceConfig).toBe(true);
  });
  
  it('should integrate with Datadog RUM when available'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/bookings.test.ts (Line 102:7 - Line 108:3), __tests__/unit/lib/auth/express-api-auth.test.ts (Line 127:7 - Line 132:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn77" onclick="toggleCodeBlock('cloneGroup77', 'expandBtn77', 'collapseBtn77')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn77" onclick="toggleCodeBlock('cloneGroup77', 'expandBtn77', 'collapseBtn77')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup77"><code class="language-typescript text-sm text-gray-800">expect(response?.status).toBe(403);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHORIZATION_ERROR');
    });
    
    it</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/bookings.test.ts (Line 145:10 - Line 153:2), __tests__/unit/api/scheduling/bookings.test.ts (Line 122:9 - Line 131:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn78" onclick="toggleCodeBlock('cloneGroup78', 'expandBtn78', 'collapseBtn78')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn78" onclick="toggleCodeBlock('cloneGroup78', 'expandBtn78', 'collapseBtn78')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup78"><code class="language-typescript text-sm text-gray-800">);
      
      expect(response?.status).toBe(200);
      const data = await response?.json();
      expect(data.success).toBe(true);
      expect(data.data).toBeDefined();
      expect(Array.isArray(data.data.bookings)).toBe(true);
    });
  }</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/bookings.test.ts (Line 174:7 - Line 183:41), __tests__/unit/api/scheduling/bookings.test.ts (Line 68:7 - Line 77:66)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn79" onclick="toggleCodeBlock('cloneGroup79', 'expandBtn79', 'collapseBtn79')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn79" onclick="toggleCodeBlock('cloneGroup79', 'expandBtn79', 'collapseBtn79')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup79"><code class="language-typescript text-sm text-gray-800">);
      const response = await tester.withoutAuth();
      
      expect(response?.status).toBe(401);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHENTICATION_ERROR');
    });
    
    it('should return 403 for non-client users'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/bookings.test.ts (Line 190:8 - Line 198:45), __tests__/unit/api/scheduling/bookings.test.ts (Line 100:2 - Line 108:56)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn80" onclick="toggleCodeBlock('cloneGroup80', 'expandBtn80', 'collapseBtn80')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn80" onclick="toggleCodeBlock('cloneGroup80', 'expandBtn80', 'collapseBtn80')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup80"><code class="language-typescript text-sm text-gray-800">);
      
      expect(response?.status).toBe(403);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHORIZATION_ERROR');
    });
    
    it('should return 400 for invalid booking data'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/bookings.test.ts (Line 211:7 - Line 219:63), __tests__/unit/api/scheduling/bookings.test.ts (Line 82:9 - Line 90:62)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn81" onclick="toggleCodeBlock('cloneGroup81', 'expandBtn81', 'collapseBtn81')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn81" onclick="toggleCodeBlock('cloneGroup81', 'expandBtn81', 'collapseBtn81')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup81"><code class="language-typescript text-sm text-gray-800">);
      
      expect(response?.status).toBe(400);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('VALIDATION_ERROR');
    });
    
    it('should return 403 if client tries to book for another client'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/bookings.test.ts (Line 242:7 - Line 250:55), __tests__/unit/api/scheduling/bookings.test.ts (Line 100:2 - Line 108:56)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn82" onclick="toggleCodeBlock('cloneGroup82', 'expandBtn82', 'collapseBtn82')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn82" onclick="toggleCodeBlock('cloneGroup82', 'expandBtn82', 'collapseBtn82')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup82"><code class="language-typescript text-sm text-gray-800">);
      
      expect(response?.status).toBe(403);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHORIZATION_ERROR');
    });
    
    it('should return 200 and create booking for client user'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 10:50 - Line 30:7), __tests__/unit/api/scheduling/bookings.test.ts (Line 10:38 - Line 30:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn83" onclick="toggleCodeBlock('cloneGroup83', 'expandBtn83', 'collapseBtn83')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn83" onclick="toggleCodeBlock('cloneGroup83', 'expandBtn83', 'collapseBtn83')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup83"><code class="language-typescript text-sm text-gray-800">;
import { UserRole } from '@/lib/auth/types';

// Mock scheduling service
vi.mock('@/lib/scheduling/real-data/scheduling-service', () =&gt; {
  const mockBooking = {
    id: 'booking_123',
    sessionTypeId: 'st_123',
    builderId: 'user_builder123',
    clientId: 'user_client123',
    startTime: '2023-12-01T10:00:00Z',
    endTime: '2023-12-01T11:00:00Z',
    status: 'pending',
    paymentStatus: 'unpaid',
    clientTimezone: 'America/New_York',
    builderTimezone: 'America/Los_Angeles',
    createdAt: new Date(),
    updatedAt: new Date()
  };

  return</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 72:2 - Line 82:41), __tests__/unit/api/scheduling/bookings.test.ts (Line 173:2 - Line 77:66)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn84" onclick="toggleCodeBlock('cloneGroup84', 'expandBtn84', 'collapseBtn84')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn84" onclick="toggleCodeBlock('cloneGroup84', 'expandBtn84', 'collapseBtn84')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup84"><code class="language-typescript text-sm text-gray-800">}
      );
      const response = await tester.withoutAuth();
      
      expect(response?.status).toBe(401);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHENTICATION_ERROR');
    });
    
    it('should return 404 if booking not found'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 117:7 - Line 125:39), __tests__/unit/api/scheduling/bookings.test.ts (Line 100:7 - Line 108:56)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn85" onclick="toggleCodeBlock('cloneGroup85', 'expandBtn85', 'collapseBtn85')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn85" onclick="toggleCodeBlock('cloneGroup85', 'expandBtn85', 'collapseBtn85')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup85"><code class="language-typescript text-sm text-gray-800">const response = await tester.withAuth();
      
      expect(response?.status).toBe(403);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHORIZATION_ERROR');
    });
    
    it('should return 200 for booking client'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 140:7 - Line 146:2), __tests__/unit/api/scheduling/bookings.test.ts (Line 121:7 - Line 127:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn86" onclick="toggleCodeBlock('cloneGroup86', 'expandBtn86', 'collapseBtn86')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn86" onclick="toggleCodeBlock('cloneGroup86', 'expandBtn86', 'collapseBtn86')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup86"><code class="language-typescript text-sm text-gray-800">);
      const response = await tester.withAuth('client');
      
      expect(response?.status).toBe(200);
      const data = await response?.json();
      expect(data.success).toBe(true);
      expect(data.data.</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 141:9 - Line 147:14), __tests__/unit/api/scheduling/bookings.test.ts (Line 266:7 - Line 272:14)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn87" onclick="toggleCodeBlock('cloneGroup87', 'expandBtn87', 'collapseBtn87')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn87" onclick="toggleCodeBlock('cloneGroup87', 'expandBtn87', 'collapseBtn87')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup87"><code class="language-typescript text-sm text-gray-800">);
      
      expect(response?.status).toBe(200);
      const data = await response?.json();
      expect(data.success).toBe(true);
      expect(data.data.booking).toBeDefined();
      expect(data.data.booking.id).toBe(testBookingId</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 165:7 - Line 171:2), __tests__/unit/api/scheduling/bookings.test.ts (Line 144:7 - Line 150:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn88" onclick="toggleCodeBlock('cloneGroup88', 'expandBtn88', 'collapseBtn88')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn88" onclick="toggleCodeBlock('cloneGroup88', 'expandBtn88', 'collapseBtn88')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup88"><code class="language-typescript text-sm text-gray-800">);
      const response = await tester.withAuth('builder');
      
      expect(response?.status).toBe(200);
      const data = await response?.json();
      expect(data.success).toBe(true);
      expect(data.data.</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 166:10 - Line 175:35), __tests__/unit/api/scheduling/bookings.test.ts (Line 266:7 - Line 150:40)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn89" onclick="toggleCodeBlock('cloneGroup89', 'expandBtn89', 'collapseBtn89')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn89" onclick="toggleCodeBlock('cloneGroup89', 'expandBtn89', 'collapseBtn89')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup89"><code class="language-typescript text-sm text-gray-800">);
      
      expect(response?.status).toBe(200);
      const data = await response?.json();
      expect(data.success).toBe(true);
      expect(data.data.booking).toBeDefined();
      expect(data.data.booking.id).toBe(testBookingId);
    });
    
    it('should return 200 for admin user'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 182:6 - Line 190:2), __tests__/unit/api/scheduling/bookings.test.ts (Line 266:7 - Line 150:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn90" onclick="toggleCodeBlock('cloneGroup90', 'expandBtn90', 'collapseBtn90')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn90" onclick="toggleCodeBlock('cloneGroup90', 'expandBtn90', 'collapseBtn90')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup90"><code class="language-typescript text-sm text-gray-800">);
      
      expect(response?.status).toBe(200);
      const data = await response?.json();
      expect(data.success).toBe(true);
      expect(data.data.booking).toBeDefined();
      expect(data.data.booking.id).toBe(testBookingId);
    });
  }</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 201:2 - Line 217:6), __tests__/unit/api/scheduling/bookings.test.ts (Line 173:2 - Line 88:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn91" onclick="toggleCodeBlock('cloneGroup91', 'expandBtn91', 'collapseBtn91')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn91" onclick="toggleCodeBlock('cloneGroup91', 'expandBtn91', 'collapseBtn91')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup91"><code class="language-typescript text-sm text-gray-800">}
      );
      const response = await tester.withoutAuth();
      
      expect(response?.status).toBe(401);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHENTICATION_ERROR');
    });
    
    it('should return 404 if booking not found', async () =&gt; {
      // Mock getBookingById to return null for this test
      const { getBookingById } = require('@/lib/scheduling/real-data/scheduling-service');
      getBookingById.mockResolvedValueOnce(null);
      
      const tester = testProtectedRoute(
        PATCH</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 220:2 - Line 230:60), __tests__/unit/api/scheduling/booking-by-id.test.ts (Line 91:2 - Line 101:65)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn92" onclick="toggleCodeBlock('cloneGroup92', 'expandBtn92', 'collapseBtn92')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn92" onclick="toggleCodeBlock('cloneGroup92', 'expandBtn92', 'collapseBtn92')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup92"><code class="language-typescript text-sm text-gray-800">}
      );
      const response = await tester.withAuth();
      
      expect(response?.status).toBe(404);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('RESOURCE_NOT_FOUND');
    });
    
    it('should return 403 if non-builder tries to confirm booking'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 230:60 - Line 241:6), __tests__/unit/api/scheduling/booking-by-id.test.ts (Line 125:39 - Line 136:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn93" onclick="toggleCodeBlock('cloneGroup93', 'expandBtn93', 'collapseBtn93')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn93" onclick="toggleCodeBlock('cloneGroup93', 'expandBtn93', 'collapseBtn93')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup93"><code class="language-typescript text-sm text-gray-800">, async () =&gt; {
      // Set up auth to use the client ID
      const mockGetAuth = vi.spyOn(require('@clerk/express'), 'getAuth');
      mockGetAuth.mockReturnValue({
        userId: 'user_client123',
        sessionClaims: {
          roles: [UserRole.CLIENT]
        }
      });
      
      const tester = testProtectedRoute(
        PATCH</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 244:2 - Line 254:65), __tests__/unit/api/scheduling/bookings.test.ts (Line 240:2 - Line 108:56)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn94" onclick="toggleCodeBlock('cloneGroup94', 'expandBtn94', 'collapseBtn94')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn94" onclick="toggleCodeBlock('cloneGroup94', 'expandBtn94', 'collapseBtn94')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup94"><code class="language-typescript text-sm text-gray-800">}
      );
      const response = await tester.withRole(UserRole.CLIENT);
      
      expect(response?.status).toBe(403);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHORIZATION_ERROR');
    });
    
    it('should return 403 if non-admin/builder tries to update payment'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 254:65 - Line 268:14), __tests__/unit/api/scheduling/booking-by-id.test.ts (Line 125:39 - Line 244:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn95" onclick="toggleCodeBlock('cloneGroup95', 'expandBtn95', 'collapseBtn95')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn95" onclick="toggleCodeBlock('cloneGroup95', 'expandBtn95', 'collapseBtn95')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup95"><code class="language-typescript text-sm text-gray-800">, async () =&gt; {
      // Set up auth to use the client ID
      const mockGetAuth = vi.spyOn(require('@clerk/express'), 'getAuth');
      mockGetAuth.mockReturnValue({
        userId: 'user_client123',
        sessionClaims: {
          roles: [UserRole.CLIENT]
        }
      });
      
      const tester = testProtectedRoute(
        PATCH, 
        `/api/scheduling/bookings/${testBookingId}`, 
        'PATCH',
        { params, body: paymentUpdate</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 268:2 - Line 278:50), __tests__/unit/api/scheduling/bookings.test.ts (Line 240:2 - Line 108:56)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn96" onclick="toggleCodeBlock('cloneGroup96', 'expandBtn96', 'collapseBtn96')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn96" onclick="toggleCodeBlock('cloneGroup96', 'expandBtn96', 'collapseBtn96')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup96"><code class="language-typescript text-sm text-gray-800">}
      );
      const response = await tester.withRole(UserRole.CLIENT);
      
      expect(response?.status).toBe(403);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHORIZATION_ERROR');
    });
    
    it('should return 200 when builder confirms booking'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 278:50 - Line 289:6), __tests__/unit/api/scheduling/booking-by-id.test.ts (Line 150:40 - Line 161:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn97" onclick="toggleCodeBlock('cloneGroup97', 'expandBtn97', 'collapseBtn97')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn97" onclick="toggleCodeBlock('cloneGroup97', 'expandBtn97', 'collapseBtn97')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup97"><code class="language-typescript text-sm text-gray-800">, async () =&gt; {
      // Set up auth to use the builder ID
      const mockGetAuth = vi.spyOn(require('@clerk/express'), 'getAuth');
      mockGetAuth.mockReturnValue({
        userId: 'user_builder123',
        sessionClaims: {
          roles: [UserRole.BUILDER]
        }
      });
      
      const tester = testProtectedRoute(
        PATCH</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 294:8 - Line 300:7), __tests__/unit/api/scheduling/bookings.test.ts (Line 266:7 - Line 272:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn98" onclick="toggleCodeBlock('cloneGroup98', 'expandBtn98', 'collapseBtn98')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn98" onclick="toggleCodeBlock('cloneGroup98', 'expandBtn98', 'collapseBtn98')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup98"><code class="language-typescript text-sm text-gray-800">);
      
      expect(response?.status).toBe(200);
      const data = await response?.json();
      expect(data.success).toBe(true);
      expect(data.data.booking).toBeDefined();
      expect(data.data.booking.status</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 303:56 - Line 317:14), __tests__/unit/api/scheduling/booking-by-id.test.ts (Line 150:40 - Line 292:13)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn99" onclick="toggleCodeBlock('cloneGroup99', 'expandBtn99', 'collapseBtn99')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn99" onclick="toggleCodeBlock('cloneGroup99', 'expandBtn99', 'collapseBtn99')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup99"><code class="language-typescript text-sm text-gray-800">, async () =&gt; {
      // Set up auth to use the builder ID
      const mockGetAuth = vi.spyOn(require('@clerk/express'), 'getAuth');
      mockGetAuth.mockReturnValue({
        userId: 'user_builder123',
        sessionClaims: {
          roles: [UserRole.BUILDER]
        }
      });
      
      const tester = testProtectedRoute(
        PATCH, 
        `/api/scheduling/bookings/${testBookingId}`, 
        'PATCH',
        { params, body: paymentUpdate</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 317:2 - Line 325:14), __tests__/unit/api/scheduling/booking-by-id.test.ts (Line 292:2 - Line 272:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn100" onclick="toggleCodeBlock('cloneGroup100', 'expandBtn100', 'collapseBtn100')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn100" onclick="toggleCodeBlock('cloneGroup100', 'expandBtn100', 'collapseBtn100')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup100"><code class="language-typescript text-sm text-gray-800">}
      );
      const response = await tester.withRole(UserRole.BUILDER);
      
      expect(response?.status).toBe(200);
      const data = await response?.json();
      expect(data.success).toBe(true);
      expect(data.data.booking).toBeDefined();
      expect(data.data.booking.paymentStatus</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/scheduling/booking-by-id.test.ts (Line 341:6 - Line 348:2), __tests__/unit/api/scheduling/bookings.test.ts (Line 82:9 - Line 90:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn101" onclick="toggleCodeBlock('cloneGroup101', 'expandBtn101', 'collapseBtn101')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn101" onclick="toggleCodeBlock('cloneGroup101', 'expandBtn101', 'collapseBtn101')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup101"><code class="language-typescript text-sm text-gray-800">);
      
      expect(response?.status).toBe(400);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('VALIDATION_ERROR');
    });
  }</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-types.test.ts (Line 61:27 - Line 70:40), __tests__/unit/api/scheduling/bookings.test.ts (Line 68:7 - Line 77:66)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn102" onclick="toggleCodeBlock('cloneGroup102', 'expandBtn102', 'collapseBtn102')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn102" onclick="toggleCodeBlock('cloneGroup102', 'expandBtn102', 'collapseBtn102')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup102"><code class="language-typescript text-sm text-gray-800">);
      const response = await tester.withoutAuth();
      
      expect(response?.status).toBe(401);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHENTICATION_ERROR');
    });
    
    it('should return 403 for non-admin users'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-types.test.ts (Line 71:27 - Line 80:54), __tests__/unit/api/scheduling/bookings.test.ts (Line 241:7 - Line 108:56)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn103" onclick="toggleCodeBlock('cloneGroup103', 'expandBtn103', 'collapseBtn103')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn103" onclick="toggleCodeBlock('cloneGroup103', 'expandBtn103', 'collapseBtn103')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup103"><code class="language-typescript text-sm text-gray-800">);
      const response = await tester.withRole(UserRole.CLIENT);
      
      expect(response?.status).toBe(403);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHORIZATION_ERROR');
    });
    
    it('should return 200 and session types for admin users'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-types.test.ts (Line 81:27 - Line 87:6), __tests__/unit/api/scheduling/booking-by-id.test.ts (Line 181:7 - Line 187:5)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn104" onclick="toggleCodeBlock('cloneGroup104', 'expandBtn104', 'collapseBtn104')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn104" onclick="toggleCodeBlock('cloneGroup104', 'expandBtn104', 'collapseBtn104')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup104"><code class="language-typescript text-sm text-gray-800">);
      const response = await tester.withRole(UserRole.ADMIN);
      
      expect(response?.status).toBe(200);
      const data = await response?.json();
      expect(data.success).toBe(true);
      expect(Array</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-types.test.ts (Line 111:2 - Line 123:5), __tests__/unit/api/scheduling/bookings.test.ts (Line 173:2 - Line 71:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn105" onclick="toggleCodeBlock('cloneGroup105', 'expandBtn105', 'collapseBtn105')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn105" onclick="toggleCodeBlock('cloneGroup105', 'expandBtn105', 'collapseBtn105')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup105"><code class="language-typescript text-sm text-gray-800">}
      );
      const response = await tester.withoutAuth();
      
      expect(response?.status).toBe(401);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHENTICATION_ERROR');
    });
    
    it('should return 403 for non-admin users', async () =&gt; {
      const tester = testProtectedRoute(
        POST</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-types.test.ts (Line 126:2 - Line 136:60), __tests__/unit/api/scheduling/bookings.test.ts (Line 188:2 - Line 108:56)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn106" onclick="toggleCodeBlock('cloneGroup106', 'expandBtn106', 'collapseBtn106')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn106" onclick="toggleCodeBlock('cloneGroup106', 'expandBtn106', 'collapseBtn106')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup106"><code class="language-typescript text-sm text-gray-800">}
      );
      const response = await tester.withRole(UserRole.BUILDER);
      
      expect(response?.status).toBe(403);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHORIZATION_ERROR');
    });
    
    it('should return 201 and create session type for admin users'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-types.test.ts (Line 164:2 - Line 174:2), __tests__/unit/api/scheduling/booking-by-id.test.ts (Line 339:2 - Line 349:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn107" onclick="toggleCodeBlock('cloneGroup107', 'expandBtn107', 'collapseBtn107')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn107" onclick="toggleCodeBlock('cloneGroup107', 'expandBtn107', 'collapseBtn107')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup107"><code class="language-typescript text-sm text-gray-800">}
      );
      const response = await tester.withRole(UserRole.ADMIN);
      
      expect(response?.status).toBe(400);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('VALIDATION_ERROR');
    });
  });
});</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-type-by-id.test.ts (Line 10:43 - Line 33:11), __tests__/unit/api/admin/session-types.test.ts (Line 10:38 - Line 33:9)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn108" onclick="toggleCodeBlock('cloneGroup108', 'expandBtn108', 'collapseBtn108')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn108" onclick="toggleCodeBlock('cloneGroup108', 'expandBtn108', 'collapseBtn108')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup108"><code class="language-typescript text-sm text-gray-800">;
import { UserRole } from '@/lib/auth/types';

// Mock PrismaClient
vi.mock('@prisma/client', () =&gt; {
  const mockSessionType = {
    id: 'st_123',
    builderId: 'user_builder123',
    title: 'Test Session',
    description: 'Test session description',
    durationMinutes: 60,
    price: { toNumber: () =&gt; 100 },
    currency: 'USD',
    isActive: true,
    color: '#00FF00',
    maxParticipants: 5,
    createdAt: new Date(),
    updatedAt: new Date()
  };

  return {
    PrismaClient: vi.fn().mockImplementation(() =&gt; ({
      sessionType: {
        findUnique</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-type-by-id.test.ts (Line 67:14 - Line 82:27), __tests__/unit/api/scheduling/booking-by-id.test.ts (Line 70:14 - Line 71:27)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn109" onclick="toggleCodeBlock('cloneGroup109', 'expandBtn109', 'collapseBtn109')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn109" onclick="toggleCodeBlock('cloneGroup109', 'expandBtn109', 'collapseBtn109')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup109"><code class="language-typescript text-sm text-gray-800">}`, 
        'GET',
        { params }
      );
      const response = await tester.withoutAuth();
      
      expect(response?.status).toBe(401);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHENTICATION_ERROR');
    });
    
    it('should return 403 for non-admin users', async () =&gt; {
      const tester = testProtectedRoute(
        GET, 
        `/api/admin/session-types/</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-type-by-id.test.ts (Line 84:2 - Line 94:53), __tests__/unit/api/scheduling/bookings.test.ts (Line 240:2 - Line 108:56)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn110" onclick="toggleCodeBlock('cloneGroup110', 'expandBtn110', 'collapseBtn110')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn110" onclick="toggleCodeBlock('cloneGroup110', 'expandBtn110', 'collapseBtn110')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup110"><code class="language-typescript text-sm text-gray-800">}
      );
      const response = await tester.withRole(UserRole.CLIENT);
      
      expect(response?.status).toBe(403);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHORIZATION_ERROR');
    });
    
    it('should return 200 and session type for admin users'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-type-by-id.test.ts (Line 97:14 - Line 106:2), __tests__/unit/api/scheduling/booking-by-id.test.ts (Line 178:14 - Line 187:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn111" onclick="toggleCodeBlock('cloneGroup111', 'expandBtn111', 'collapseBtn111')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn111" onclick="toggleCodeBlock('cloneGroup111', 'expandBtn111', 'collapseBtn111')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup111"><code class="language-typescript text-sm text-gray-800">}`, 
        'GET',
        { params }
      );
      const response = await tester.withRole(UserRole.ADMIN);
      
      expect(response?.status).toBe(200);
      const data = await response?.json();
      expect(data.success).toBe(true);
      expect(data.data)</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-type-by-id.test.ts (Line 101:6 - Line 107:5), __tests__/unit/api/scheduling/bookings.test.ts (Line 122:9 - Line 128:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn112" onclick="toggleCodeBlock('cloneGroup112', 'expandBtn112', 'collapseBtn112')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn112" onclick="toggleCodeBlock('cloneGroup112', 'expandBtn112', 'collapseBtn112')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup112"><code class="language-typescript text-sm text-gray-800">);
      
      expect(response?.status).toBe(200);
      const data = await response?.json();
      expect(data.success).toBe(true);
      expect(data.data).toBeDefined();
      expect(data</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-type-by-id.test.ts (Line 124:2 - Line 136:4), __tests__/unit/api/scheduling/bookings.test.ts (Line 173:2 - Line 71:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn113" onclick="toggleCodeBlock('cloneGroup113', 'expandBtn113', 'collapseBtn113')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn113" onclick="toggleCodeBlock('cloneGroup113', 'expandBtn113', 'collapseBtn113')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup113"><code class="language-typescript text-sm text-gray-800">}
      );
      const response = await tester.withoutAuth();
      
      expect(response?.status).toBe(401);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHENTICATION_ERROR');
    });
    
    it('should return 403 for non-admin users', async () =&gt; {
      const tester = testProtectedRoute(
        PUT</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-type-by-id.test.ts (Line 139:2 - Line 149:60), __tests__/unit/api/scheduling/bookings.test.ts (Line 188:2 - Line 108:56)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn114" onclick="toggleCodeBlock('cloneGroup114', 'expandBtn114', 'collapseBtn114')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn114" onclick="toggleCodeBlock('cloneGroup114', 'expandBtn114', 'collapseBtn114')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup114"><code class="language-typescript text-sm text-gray-800">}
      );
      const response = await tester.withRole(UserRole.BUILDER);
      
      expect(response?.status).toBe(403);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHORIZATION_ERROR');
    });
    
    it('should return 200 and update session type for admin users'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-type-by-id.test.ts (Line 154:2 - Line 162:6), __tests__/unit/api/scheduling/booking-by-id.test.ts (Line 180:2 - Line 107:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn115" onclick="toggleCodeBlock('cloneGroup115', 'expandBtn115', 'collapseBtn115')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn115" onclick="toggleCodeBlock('cloneGroup115', 'expandBtn115', 'collapseBtn115')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup115"><code class="language-typescript text-sm text-gray-800">}
      );
      const response = await tester.withRole(UserRole.ADMIN);
      
      expect(response?.status).toBe(200);
      const data = await response?.json();
      expect(data.success).toBe(true);
      expect(data.data).toBeDefined();
      expect(data.data.title</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-type-by-id.test.ts (Line 175:2 - Line 186:9), __tests__/unit/api/scheduling/booking-by-id.test.ts (Line 339:2 - Line 349:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn116" onclick="toggleCodeBlock('cloneGroup116', 'expandBtn116', 'collapseBtn116')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn116" onclick="toggleCodeBlock('cloneGroup116', 'expandBtn116', 'collapseBtn116')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup116"><code class="language-typescript text-sm text-gray-800">}
      );
      const response = await tester.withRole(UserRole.ADMIN);
      
      expect(response?.status).toBe(400);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('VALIDATION_ERROR');
    });
  });

  describe</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-type-by-id.test.ts (Line 191:9 - Line 204:7), __tests__/unit/api/scheduling/booking-by-id.test.ts (Line 71:6 - Line 71:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn117" onclick="toggleCodeBlock('cloneGroup117', 'expandBtn117', 'collapseBtn117')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn117" onclick="toggleCodeBlock('cloneGroup117', 'expandBtn117', 'collapseBtn117')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup117"><code class="language-typescript text-sm text-gray-800">,
        { params }
      );
      const response = await tester.withoutAuth();
      
      expect(response?.status).toBe(401);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHENTICATION_ERROR');
    });
    
    it('should return 403 for non-admin users', async () =&gt; {
      const tester = testProtectedRoute(
        DELETE</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-type-by-id.test.ts (Line 207:2 - Line 217:60), __tests__/unit/api/scheduling/bookings.test.ts (Line 188:2 - Line 108:56)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn118" onclick="toggleCodeBlock('cloneGroup118', 'expandBtn118', 'collapseBtn118')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn118" onclick="toggleCodeBlock('cloneGroup118', 'expandBtn118', 'collapseBtn118')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup118"><code class="language-typescript text-sm text-gray-800">}
      );
      const response = await tester.withRole(UserRole.BUILDER);
      
      expect(response?.status).toBe(403);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('AUTHORIZATION_ERROR');
    });
    
    it('should return 200 and delete session type for admin users'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-type-by-id.test.ts (Line 221:9 - Line 229:8), __tests__/unit/api/scheduling/booking-by-id.test.ts (Line 179:6 - Line 187:5)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn119" onclick="toggleCodeBlock('cloneGroup119', 'expandBtn119', 'collapseBtn119')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn119" onclick="toggleCodeBlock('cloneGroup119', 'expandBtn119', 'collapseBtn119')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup119"><code class="language-typescript text-sm text-gray-800">,
        { params }
      );
      const response = await tester.withRole(UserRole.ADMIN);
      
      expect(response?.status).toBe(200);
      const data = await response?.json();
      expect(data.success).toBe(true);
      expect(data.message</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/unit/api/admin/session-type-by-id.test.ts (Line 241:2 - Line 249:7), __tests__/unit/api/scheduling/booking-by-id.test.ts (Line 339:2 - Line 88:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn120" onclick="toggleCodeBlock('cloneGroup120', 'expandBtn120', 'collapseBtn120')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn120" onclick="toggleCodeBlock('cloneGroup120', 'expandBtn120', 'collapseBtn120')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup120"><code class="language-typescript text-sm text-gray-800">}
      );
      const response = await tester.withRole(UserRole.ADMIN);
      
      expect(response?.status).toBe(400);
      const data = await response?.json();
      expect(data.success).toBe(false);
      expect(data.error.type).toBe('VALIDATION_ERROR');
      expect</code></pre></div><div class="py-4"><p class="text-gray-600">lib/scheduling/state-machine/error-handling.ts (Line 298:2 - Line 307:24), lib/scheduling/state-machine/service.ts (Line 118:2 - Line 127:24)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn121" onclick="toggleCodeBlock('cloneGroup121', 'expandBtn121', 'collapseBtn121')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn121" onclick="toggleCodeBlock('cloneGroup121', 'expandBtn121', 'collapseBtn121')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup121"><code class="language-typescript text-sm text-gray-800">{
        success: false,
        previousState: BookingStateEnum.ERROR,
        currentState: BookingStateEnum.ERROR,
        stateData: {
          bookingId,
          error: {
            message: error instanceof Error ? error.message : String(error),
            timestamp: new Date().toISOString(),
            source: 'error-handling-system'</code></pre></div><div class="py-4"><p class="text-gray-600">lib/scheduling/real-data/scheduling-service-ext.ts (Line 113:5 - Line 131:30), lib/scheduling/real-data/scheduling-service-ext.ts (Line 35:5 - Line 53:32)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn122" onclick="toggleCodeBlock('cloneGroup122', 'expandBtn122', 'collapseBtn122')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn122" onclick="toggleCodeBlock('cloneGroup122', 'expandBtn122', 'collapseBtn122')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup122"><code class="language-typescript text-sm text-gray-800">// Transform the database session type to our API type
    return {
      id: sessionType.id,
      builderId: sessionType.builderId,
      title: sessionType.title,
      description: sessionType.description,
      durationMinutes: sessionType.durationMinutes,
      price: sessionType.price.toNumber(),
      currency: sessionType.currency,
      isActive: sessionType.isActive,
      color: sessionType.color || undefined,
      maxParticipants: sessionType.maxParticipants || undefined,
      calendlyEventTypeId: sessionType.calendlyEventTypeId || undefined,
      calendlyEventTypeUri: sessionType.calendlyEventTypeUri || undefined,
      createdAt: sessionType.createdAt.toISOString(),
      updatedAt: sessionType.updatedAt.toISOString(),
    };
  } catch (error) {
    logger.error('Error creating session type'</code></pre></div><div class="py-4"><p class="text-gray-600">lib/scheduling/real-data/scheduling-service-ext.ts (Line 183:7 - Line 204:48), lib/scheduling/real-data/scheduling-service-ext.ts (Line 111:5 - Line 52:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn123" onclick="toggleCodeBlock('cloneGroup123', 'expandBtn123', 'collapseBtn123')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn123" onclick="toggleCodeBlock('cloneGroup123', 'expandBtn123', 'collapseBtn123')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup123"><code class="language-typescript text-sm text-gray-800">});

      // Transform the database session type to our API type
      return {
        id: sessionType.id,
        builderId: sessionType.builderId,
        title: sessionType.title,
        description: sessionType.description,
        durationMinutes: sessionType.durationMinutes,
        price: sessionType.price.toNumber(),
        currency: sessionType.currency,
        isActive: sessionType.isActive,
        color: sessionType.color || undefined,
        maxParticipants: sessionType.maxParticipants || undefined,
        calendlyEventTypeId: sessionType.calendlyEventTypeId || undefined,
        calendlyEventTypeUri: sessionType.calendlyEventTypeUri || undefined,
        createdAt: sessionType.createdAt.toISOString(),
        updatedAt: sessionType.updatedAt.toISOString(),
      };
    }

    // For regular session types, update all fields</code></pre></div><div class="py-4"><p class="text-gray-600">lib/scheduling/real-data/scheduling-service-ext.ts (Line 210:23 - Line 234:30), lib/scheduling/real-data/scheduling-service-ext.ts (Line 107:23 - Line 53:32)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn124" onclick="toggleCodeBlock('cloneGroup124', 'expandBtn124', 'collapseBtn124')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn124" onclick="toggleCodeBlock('cloneGroup124', 'expandBtn124', 'collapseBtn124')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup124"><code class="language-typescript text-sm text-gray-800">, {
      sessionTypeId: sessionType.id,
      builderId: sessionType.builderId,
      title: sessionType.title
    });

    // Transform the database session type to our API type
    return {
      id: sessionType.id,
      builderId: sessionType.builderId,
      title: sessionType.title,
      description: sessionType.description,
      durationMinutes: sessionType.durationMinutes,
      price: sessionType.price.toNumber(),
      currency: sessionType.currency,
      isActive: sessionType.isActive,
      color: sessionType.color || undefined,
      maxParticipants: sessionType.maxParticipants || undefined,
      calendlyEventTypeId: sessionType.calendlyEventTypeId || undefined,
      calendlyEventTypeUri: sessionType.calendlyEventTypeUri || undefined,
      createdAt: sessionType.createdAt.toISOString(),
      updatedAt: sessionType.updatedAt.toISOString(),
    };
  } catch (error) {
    logger.error('Error updating session type'</code></pre></div><div class="py-4"><p class="text-gray-600">lib/scheduling/calendly/types.ts (Line 145:3 - Line 193:13), lib/scheduling/calendly/types.ts (Line 82:3 - Line 130:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn125" onclick="toggleCodeBlock('cloneGroup125', 'expandBtn125', 'collapseBtn125')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn125" onclick="toggleCodeBlock('cloneGroup125', 'expandBtn125', 'collapseBtn125')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup125"><code class="language-typescript text-sm text-gray-800">payload: {
    event_type: {
      uuid: string
      kind: string
      slug: string
      name: string
      duration: number
      owner: {
        type: string
        uuid: string
      }
    }
    event: {
      uuid: string
      start_time: string
      end_time: string
      location: {
        type: string
        location?: string
        join_url?: string
      }
    }
    invitee: {
      uuid: string
      email: string
      name: string
      timezone: string
      created_at: string
      updated_at: string
      questions_and_answers: {
        question: string
        answer: string
      }[]
      tracking: {
        utm_source?: string
        utm_medium?: string
        utm_campaign?: string
        utm_content?: string
        utm_term?: string
        salesforce_uuid?: string
      }
      cancel_url: string
      reschedule_url: string
      status: string
      text_reminder_number: string | null
      no_show: {
        label: string
      } | null
      cancellation</code></pre></div><div class="py-4"><p class="text-gray-600">lib/scheduling/calendly/api-client.ts (Line 513:5 - Line 526:28), lib/scheduling/calendly/api-client.ts (Line 382:5 - Line 395:41)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn126" onclick="toggleCodeBlock('cloneGroup126', 'expandBtn126', 'collapseBtn126')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn126" onclick="toggleCodeBlock('cloneGroup126', 'expandBtn126', 'collapseBtn126')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup126"><code class="language-typescript text-sm text-gray-800">// Determine which scope to use (organization, user, or default to current user)
    let queryParams: Record&lt;string, any&gt; = {}
    
    if (options.organizationUri) {
      queryParams.organization = options.organizationUri
    } else if (options.userUri) {
      queryParams.user = options.userUri
    } else {
      // Default to current user
      const user = await this.getCurrentUser()
      queryParams.user = user.resource.uri
    }
    
    // Add filtering parameters</code></pre></div><div class="py-4"><p class="text-gray-600">lib/scheduling/calendly/api-client.ts (Line 579:5 - Line 586:25), lib/scheduling/calendly/api-client.ts (Line 529:5 - Line 536:23)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn127" onclick="toggleCodeBlock('cloneGroup127', 'expandBtn127', 'collapseBtn127')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn127" onclick="toggleCodeBlock('cloneGroup127', 'expandBtn127', 'collapseBtn127')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup127"><code class="language-typescript text-sm text-gray-800">if (options.status) queryParams.status = options.status
    
    // Add pagination and sorting parameters
    if (options.count) queryParams.count = options.count
    if (options.pageToken) queryParams.page_token = options.pageToken
    if (options.sort) queryParams.sort = options.sort
    
    return this.request&lt;CalendlyInviteesResponse</code></pre></div><div class="py-4"><p class="text-gray-600">lib/marketplace/data/marketplace-service.ts (Line 421:10 - Line 437:5), lib/marketplace/data/marketplace-service.ts (Line 270:12 - Line 286:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn128" onclick="toggleCodeBlock('cloneGroup128', 'expandBtn128', 'collapseBtn128')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn128" onclick="toggleCodeBlock('cloneGroup128', 'expandBtn128', 'collapseBtn128')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup128"><code class="language-typescript text-sm text-gray-800">,
        bio: builder.bio || undefined,
        headline: builder.headline || undefined,
        tagline: builder.tagline || undefined,
        // Only use imageUrl after mapping to ensure consistency
        avatarUrl: mappedUser.imageUrl || undefined,
        validationTier: builder.validationTier,
        skills: builder.skills.map((s) =&gt; s.skill.name),
        topSkills: builder.topSkills || [],
        hourlyRate: builder.hourlyRate ? Number(builder.hourlyRate) : undefined,
        rating: builder.rating || undefined,
        featured: builder.featured,
        availability: (builder.availability as any) || 'available',
        adhd_focus: builder.adhd_focus,
        completedProjects: (builder as any).completedProjects || 0,
        responseRate: (builder as any).responseRate || undefined,
        slug</code></pre></div><div class="py-4"><p class="text-gray-600">lib/marketplace/data/marketplace-service.ts (Line 532:2 - Line 557:33), lib/marketplace/data/marketplace-service.ts (Line 417:2 - Line 291:35)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn129" onclick="toggleCodeBlock('cloneGroup129', 'expandBtn129', 'collapseBtn129')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn129" onclick="toggleCodeBlock('cloneGroup129', 'expandBtn129', 'collapseBtn129')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup129"><code class="language-typescript text-sm text-gray-800">= {
          id: builder.id,
          userId: builder.userId,
          name: builder.displayName || mappedUser.name || 'Unknown Builder',
          displayName: builder.displayName || undefined,
          bio: builder.bio || undefined,
          headline: builder.headline || undefined,
          tagline: builder.tagline || undefined,
          // Only use imageUrl after mapping to ensure consistency
          avatarUrl: mappedUser.imageUrl || undefined,
          validationTier: builder.validationTier,
          skills: builder.skills.map((s) =&gt; s.skill.name),
          topSkills: builder.topSkills || [],
          hourlyRate: builder.hourlyRate ? Number(builder.hourlyRate) : undefined,
          rating: builder.rating || undefined,
          featured: builder.featured,
          availability: (builder.availability as any) || 'available',
          adhd_focus: builder.adhd_focus,
          completedProjects: (builder as any).completedProjects || 0,
          responseRate: (builder as any).responseRate || undefined,
        };
        
        // Add demo status information
        return enhanceWithDemoStatus(baseProfile, mappedUser);
      } catch (error) {
        marketplaceLogger.error('Error mapping featured builder'</code></pre></div><div class="py-4"><p class="text-gray-600">lib/marketplace/data/marketplace-service.ts (Line 557:33 - Line 570:5), lib/marketplace/data/marketplace-service.ts (Line 291:35 - Line 304:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn130" onclick="toggleCodeBlock('cloneGroup130', 'expandBtn130', 'collapseBtn130')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn130" onclick="toggleCodeBlock('cloneGroup130', 'expandBtn130', 'collapseBtn130')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup130"><code class="language-typescript text-sm text-gray-800">, {
          builderId: builder.id,
          error: error instanceof Error ? error.message : String(error)
        });

        // Return a fallback object with required fields to prevent page crashes
        return {
          id: builder.id,
          userId: builder.userId || 'unknown',
          name: builder.displayName || 'Unknown Builder',
          validationTier: builder.validationTier || 1,
          skills: [],
          topSkills: [],
          featured: true</code></pre></div><div class="py-4"><p class="text-gray-600">lib/marketplace/data/marketplace-service.ts (Line 646:7 - Line 653:2), app/api/marketplace/filters/route.ts (Line 29:7 - Line 37:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn131" onclick="toggleCodeBlock('cloneGroup131', 'expandBtn131', 'collapseBtn131')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn131" onclick="toggleCodeBlock('cloneGroup131', 'expandBtn131', 'collapseBtn131')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup131"><code class="language-typescript text-sm text-gray-800">sortOptions: [
        { value: 'featured', label: 'Featured' },
        { value: 'rating', label: 'Highest Rated' },
        { value: 'projects', label: 'Most Projects' },
        { value: 'hourly_rate_asc', label: 'Hourly Rate: Low to High' },
        { value: 'hourly_rate_desc', label: 'Hourly Rate: High to Low' },
        { value: 'validation', label: 'Validation Level' },
        { value: 'recent', label: 'Recently Joined' },</code></pre></div><div class="py-4"><p class="text-gray-600">lib/datadog/client/trace-context.client.ts (Line 33:3 - Line 55:2), lib/datadog/server/trace-context.server.ts (Line 67:3 - Line 89:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn132" onclick="toggleCodeBlock('cloneGroup132', 'expandBtn132', 'collapseBtn132')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn132" onclick="toggleCodeBlock('cloneGroup132', 'expandBtn132', 'collapseBtn132')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup132"><code class="language-typescript text-sm text-gray-800">},

  /**
   * Serializes trace context to a JSON string for client storage
   */
  serializeTraceContext(context: TraceContext | null): string {
    if (!context) return '';
    return JSON.stringify(context);
  },

  /**
   * Deserializes trace context from a JSON string
   */
  deserializeTraceContext(serializedContext: string): TraceContext | null {
    try {
      if (!serializedContext) return null;
      return JSON.parse(serializedContext) as TraceContext;
    } catch (error) {
      console.error('Failed to deserialize trace context:', error);
      return null;
    }
  }
};</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/express/server-auth.ts (Line 13:11 - Line 55:2), libs/auth/src/lib/express/server-auth.ts (Line 22:2 - Line 64:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn133" onclick="toggleCodeBlock('cloneGroup133', 'expandBtn133', 'collapseBtn133')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn133" onclick="toggleCodeBlock('cloneGroup133', 'expandBtn133', 'collapseBtn133')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup133"><code class="language-typescript text-sm text-gray-800">;

/**
 * Authentication information from server context
 */
export interface ServerAuth {
  userId: string | null;
  sessionId: string | null;
  isAuthenticated: boolean;
  roles: UserRole[];
  hasRole: (role: UserRole) =&gt; boolean;
}

/**
 * Get basic auth state in server components and route handlers
 * @returns Authentication information from response headers
 */
export function getServerAuth(): ServerAuth {
  try {
    const headersList = headers();
    const userId = headersList.get('x-clerk-auth-user-id');
    const sessionId = headersList.get('x-clerk-auth-session-id');
    
    // Parse roles from header if available
    let roles: UserRole[] = [];
    const rolesHeader = headersList.get('x-clerk-auth-user-roles');
    
    if (rolesHeader) {
      try {
        // Attempt to parse JSON roles array
        roles = JSON.parse(rolesHeader);
      } catch {
        // Fallback to comma-separated string
        roles = rolesHeader.split(',') as UserRole[];
      }
    }
    
    return {
      userId,
      sessionId,
      isAuthenticated: !!userId,
      roles,
      hasRole: (role:</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/express/server-auth.ts (Line 195:2 - Line 223:8), libs/auth/src/lib/express/server-auth.ts (Line 187:6 - Line 215:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn134" onclick="toggleCodeBlock('cloneGroup134', 'expandBtn134', 'collapseBtn134')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn134" onclick="toggleCodeBlock('cloneGroup134', 'expandBtn134', 'collapseBtn134')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup134"><code class="language-typescript text-sm text-gray-800">);
    return false;
  }
}

/**
 * Require authentication for server component or route handler
 * @throws AuthenticationError if user is not authenticated
 */
export function requireServerAuth(): ServerAuth {
  const auth = getServerAuth();
  
  if (!auth.isAuthenticated) {
    throw new AuthenticationError('Authentication required');
  }
  
  return auth;
}

/**
 * Require specific role for server component or route handler
 * @param role Role to require
 * @throws AuthenticationError if user is not authenticated
 * @throws AuthorizationError if user doesn't have the required role
 */
export function requireServerRole(role: UserRole): ServerAuth {
  const auth = requireServerAuth();
  
  if (!auth.hasRole</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/express/permission-hooks.ts (Line 94:18 - Line 101:6), lib/auth/express/permission-hooks.ts (Line 78:17 - Line 85:5)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn135" onclick="toggleCodeBlock('cloneGroup135', 'expandBtn135', 'collapseBtn135')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn135" onclick="toggleCodeBlock('cloneGroup135', 'expandBtn135', 'collapseBtn135')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup135"><code class="language-typescript text-sm text-gray-800">(requiredPermissions: string[]): boolean {
  const { roles, isLoaded } = useAuth();
  
  return useMemo(() =&gt; {
    if (!isLoaded || !requiredPermissions.length) return false;
    
    const permissions = calculatePermissions(roles);
    return requiredPermissions.every</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/express/errors.ts (Line 13:30 - Line 53:2), libs/auth/src/lib/express/errors.ts (Line 9:14 - Line 48:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn136" onclick="toggleCodeBlock('cloneGroup136', 'expandBtn136', 'collapseBtn136')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn136" onclick="toggleCodeBlock('cloneGroup136', 'expandBtn136', 'collapseBtn136')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup136"><code class="language-typescript text-sm text-gray-800">;

/**
 * Error type definitions for standardized responses
 */
export enum AuthErrorType {
  AUTHENTICATION = 'AUTHENTICATION_ERROR',
  AUTHORIZATION = 'AUTHORIZATION_ERROR',
  CONFIGURATION = 'CONFIGURATION_ERROR',
  RATE_LIMIT = 'RATE_LIMIT_ERROR',
  SESSION = 'SESSION_ERROR',
  TOKEN = 'TOKEN_ERROR',
  SERVER = 'SERVER_ERROR',
  VALIDATION = 'VALIDATION_ERROR',
  RESOURCE_NOT_FOUND = 'RESOURCE_NOT_FOUND',
}

/**
 * Base authentication error class
 */
export class AuthError extends Error {
  statusCode: number;
  code: string;

  constructor(message: string, statusCode: number = 401, code: string = 'auth_error') {
    super(message);
    this.name = 'AuthError';
    this.statusCode = statusCode;
    this.code = code;
  }

  /**
   * Convert to a standardized error response object
   */
  toJSON() {
    return {
      error: {
        message: this.message,
        code: this.code,
        type: this.name
      }</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/express/errors.ts (Line 53:7 - Line 149:4), libs/auth/src/lib/express/errors.ts (Line 50:7 - Line 143:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn137" onclick="toggleCodeBlock('cloneGroup137', 'expandBtn137', 'collapseBtn137')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn137" onclick="toggleCodeBlock('cloneGroup137', 'expandBtn137', 'collapseBtn137')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup137"><code class="language-typescript text-sm text-gray-800">}
    };
  }
}

/**
 * Authentication error for unauthorized access attempts
 */
export class AuthenticationError extends AuthError {
  constructor(message: string = 'Authentication required') {
    super(message, 401, 'auth_required');
    this.name = 'AuthenticationError';
  }
}

/**
 * Authorization error for insufficient permissions
 */
export class AuthorizationError extends AuthError {
  constructor(message: string = 'Insufficient permissions', role?: string) {
    const msg = role ? `Insufficient permissions: ${role} role required` : message;
    super(msg, 403, 'auth_forbidden');
    this.name = 'AuthorizationError';
  }
}

/**
 * Configuration error for auth setup issues
 */
export class AuthConfigurationError extends AuthError {
  constructor(message: string = 'Authentication configuration error') {
    super(message, 500, 'auth_config_error');
    this.name = 'AuthConfigurationError';
  }
}

/**
 * Rate limit error for too many auth attempts
 */
export class AuthRateLimitError extends AuthError {
  constructor(message: string = 'Too many authentication attempts', retryAfter?: number) {
    super(message, 429, 'auth_rate_limited');
    this.name = 'AuthRateLimitError';
  }
}

/**
 * Session error for invalid or expired sessions
 */
export class SessionError extends AuthError {
  constructor(message: string = 'Invalid or expired session') {
    super(message, 401, 'auth_session_error');
    this.name = 'SessionError';
  }
}

/**
 * Token error for invalid or expired tokens
 */
export class TokenError extends AuthError {
  constructor(message: string = 'Invalid or expired token') {
    super(message, 401, 'auth_token_error');
    this.name = 'TokenError';
  }
}

/**
 * Validation error for invalid input data
 */
export class ValidationError extends AuthError {
  constructor(message: string = 'Invalid input data') {
    super(message, 400, 'validation_error');
    this.name = 'ValidationError';
  }
}

/**
 * Resource not found error
 */
export class ResourceNotFoundError extends AuthError {
  constructor(message: string = 'Resource not found') {
    super(message, 404, 'resource_not_found');
    this.name = 'ResourceNotFoundError';
  }
}

/**
 * Create a standardized authentication error response
 *
 * @param type Error type from AuthErrorType enum
 * @param detail Detailed error message
 * @param statusCode HTTP status code (defaults based on error type)
 * @param path Request path for logging (optional)
 * @param method HTTP method for logging (optional)
 * @param userId User ID for logging (optional)
 * @returns NextResponse with standardized error format
 */</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/express/client-auth.ts (Line 167:5 - Line 174:6), lib/auth/express/server-auth.ts (Line 180:5 - Line 187:10)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn138" onclick="toggleCodeBlock('cloneGroup138', 'expandBtn138', 'collapseBtn138')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn138" onclick="toggleCodeBlock('cloneGroup138', 'expandBtn138', 'collapseBtn138')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup138"><code class="language-typescript text-sm text-gray-800">const rolePermissions: Record&lt;string, string[]&gt; = {
      [UserRole.ADMIN]: ['*'], // Admin has all permissions
      [UserRole.BUILDER]: ['profile:edit', 'builder:manage'],
      [UserRole.CLIENT]: ['profile:view', 'booking:create'],
    };

    // Check if any of the user's roles grant the required permission
    return roles</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/express/api-auth.ts (Line 203:7 - Line 210:47), lib/auth/express/api-auth.ts (Line 136:7 - Line 143:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn139" onclick="toggleCodeBlock('cloneGroup139', 'expandBtn139', 'collapseBtn139')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn139" onclick="toggleCodeBlock('cloneGroup139', 'expandBtn139', 'collapseBtn139')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup139"><code class="language-typescript text-sm text-gray-800">const auth = req.auth;
      
      // Extract roles from session claims
      const userRoles = (auth?.sessionClaims?.roles as UserRole[] || 
                       auth?.sessionClaims?.['public_metadata']?.['roles'] as UserRole[] || 
                       []) as UserRole[];

      // Check if user has any of the required roles</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/express/api-auth.ts (Line 244:6 - Line 269:4), lib/auth/express/api-auth.ts (Line 173:5 - Line 198:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn140" onclick="toggleCodeBlock('cloneGroup140', 'expandBtn140', 'collapseBtn140')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn140" onclick="toggleCodeBlock('cloneGroup140', 'expandBtn140', 'collapseBtn140')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup140"><code class="language-typescript text-sm text-gray-800">,
        path: req.nextUrl.pathname,
        method: req.method,
      });
      
      return NextResponse.json(
        {
          success: false,
          message: 'Authorization error',
          error: {
            type: 'SERVER_ERROR',
            detail: 'An error occurred while checking your permissions',
          },
        },
        { status: 500 }
      );
    }
  });
}

/**
 * Middleware for protecting API routes with all required roles (AND logic)
 * @param roles Array of roles, all of which are required
 * @param handler The route handler function
 * @returns A function that checks if the user has all of the required roles
 */</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/express/api-auth.ts (Line 274:7 - Line 281:40), lib/auth/express/api-auth.ts (Line 136:7 - Line 143:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn141" onclick="toggleCodeBlock('cloneGroup141', 'expandBtn141', 'collapseBtn141')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn141" onclick="toggleCodeBlock('cloneGroup141', 'expandBtn141', 'collapseBtn141')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup141"><code class="language-typescript text-sm text-gray-800">const auth = req.auth;
      
      // Extract roles from session claims
      const userRoles = (auth?.sessionClaims?.roles as UserRole[] || 
                       auth?.sessionClaims?.['public_metadata']?.['roles'] as UserRole[] || 
                       []) as UserRole[];

      // Check if user has all required roles</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/express/api-auth.ts (Line 285:20 - Line 305:38), lib/auth/express/api-auth.ts (Line 214:16 - Line 234:45)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn142" onclick="toggleCodeBlock('cloneGroup142', 'expandBtn142', 'collapseBtn142')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn142" onclick="toggleCodeBlock('cloneGroup142', 'expandBtn142', 'collapseBtn142')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup142"><code class="language-typescript text-sm text-gray-800">) {
        return handler(req, userId, userRoles);
      }

      // Log authorization failure
      logger.info('API role check failed', {
        userId,
        requiredRoles: roles,
        userRoles,
        path: req.nextUrl.pathname,
        method: req.method,
      });
      
      // Return standardized error response
      return NextResponse.json(
        {
          success: false,
          message: 'Insufficient permissions',
          error: {
            type: 'AUTHORIZATION_ERROR',
            detail: `You do not have all required roles: </code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/express/api-auth.ts (Line 305:38 - Line 339:4), lib/auth/express/api-auth.ts (Line 234:45 - Line 198:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn143" onclick="toggleCodeBlock('cloneGroup143', 'expandBtn143', 'collapseBtn143')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn143" onclick="toggleCodeBlock('cloneGroup143', 'expandBtn143', 'collapseBtn143')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup143"><code class="language-typescript text-sm text-gray-800">${roles.join(', ')}`,
          },
        },
        { status: 403 }
      );
    } catch (error) {
      // Log error and return 500
      logger.error('API role check error', {
        error: error instanceof Error ? error.message : 'Unknown error',
        userId,
        requiredRoles: roles,
        path: req.nextUrl.pathname,
        method: req.method,
      });
      
      return NextResponse.json(
        {
          success: false,
          message: 'Authorization error',
          error: {
            type: 'SERVER_ERROR',
            detail: 'An error occurred while checking your permissions',
          },
        },
        { status: 500 }
      );
    }
  });
}

/**
 * Middleware for protecting admin-only API routes
 * @param handler The route handler function
 * @returns A function that checks the user is an admin before calling the handler
 */</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/express/api-auth.ts (Line 381:2 - Line 392:6), lib/auth/express/server-auth.ts (Line 176:2 - Line 187:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn144" onclick="toggleCodeBlock('cloneGroup144', 'expandBtn144', 'collapseBtn144')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn144" onclick="toggleCodeBlock('cloneGroup144', 'expandBtn144', 'collapseBtn144')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup144"><code class="language-typescript text-sm text-gray-800">;
      
      // Simple role-based permission mapping
      // Replace with your actual permission mapping logic
      const rolePermissions: Record&lt;string, string[]&gt; = {
        [UserRole.ADMIN]: ['*'], // Admin has all permissions
        [UserRole.BUILDER]: ['profile:edit', 'builder:manage'],
        [UserRole.CLIENT]: ['profile:view', 'booking:create'],
      };
      
      // Check if any of the user's roles grant the required permission
      const</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/express/api-auth.ts (Line 427:11 - Line 445:2), lib/auth/express/api-auth.ts (Line 173:5 - Line 191:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn145" onclick="toggleCodeBlock('cloneGroup145', 'expandBtn145', 'collapseBtn145')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn145" onclick="toggleCodeBlock('cloneGroup145', 'expandBtn145', 'collapseBtn145')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup145"><code class="language-typescript text-sm text-gray-800">,
        path: req.nextUrl.pathname,
        method: req.method,
      });
      
      return NextResponse.json(
        {
          success: false,
          message: 'Authorization error',
          error: {
            type: 'SERVER_ERROR',
            detail: 'An error occurred while checking your permissions',
          },
        },
        { status: 500 }
      );
    }
  });
}</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/express/adapter.ts (Line 13:15 - Line 53:28), libs/auth/src/lib/express/adapter.ts (Line 42:2 - Line 82:39)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn146" onclick="toggleCodeBlock('cloneGroup146', 'expandBtn146', 'collapseBtn146')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn146" onclick="toggleCodeBlock('cloneGroup146', 'expandBtn146', 'collapseBtn146')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup146"><code class="language-typescript text-sm text-gray-800">;

/**
 * Creates a Next.js middleware function that uses Clerk Express SDK
 * @returns Middleware function compatible with Next.js
 */
export function createClerkExpressMiddleware() {
  return async function clerkExpressAdapter(req: NextRequest) {
    // Initialize Express SDK middleware with Next.js adapter
    try {
      // Create Express-compatible request/response objects
      const expressReq = adaptNextRequestToExpress(req);
      const expressRes = createMockExpressResponse();
      let nextCalled = false;

      // Create Express-style next function
      const next = () =&gt; {
        nextCalled = true;
      };

      // Initialize Clerk Express middleware with default cookie settings
      // FIXED: Removed custom cookie name and settings to use Clerk defaults
      const middleware = clerkExpressMiddleware({
        publishableKey: process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY,
        secretKey: process.env.CLERK_SECRET_KEY,
        signInUrl: '/sign-in',
        // REMOVED custom cookie configuration
        // REMOVED apiVersion to use default
        // REMOVED apiKey to use secretKey only
        // Set EU data residency if required
        ...(process.env.CLERK_DATA_RESIDENCY === 'eu' &amp;&amp; { frontendApi: process.env.NEXT_PUBLIC_CLERK_FRONTEND_API }),
        debug: process.env.NODE_ENV === 'development',
      });

      // Apply middleware to the request
      await middleware(expressReq, expressRes, next);

      // Get auth state from request
      const auth = getAuth(expressReq);

      // Check if route is public</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/clerk/verify-auth-migration.ts (Line 176:2 - Line 189:96), lib/auth/clerk/verify-auth-migration.ts (Line 129:7 - Line 142:36)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn147" onclick="toggleCodeBlock('cloneGroup147', 'expandBtn147', 'collapseBtn147')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn147" onclick="toggleCodeBlock('cloneGroup147', 'expandBtn147', 'collapseBtn147')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup147"><code class="language-typescript text-sm text-gray-800">;
          
          // Skip if it's a reference to migration or cleanup
          const isMigrationReference = 
            line.includes('migrate') || 
            line.includes('cleanup') || 
            line.includes('remove') || 
            line.includes('replace') ||
            line.includes('documentation') ||
            line.includes('archive') ||
            line.includes('verification') ||
            line.includes('CLERK_AUTHENTICATION_CLEANUP_LIST.md');
          
          // If we found a Clerk context, it's a valid use. If not, it's potentially a NextAuth reference</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/clerk/api-auth.ts (Line 188:13 - Line 193:47), lib/auth/clerk/api-auth.ts (Line 154:12 - Line 159:47)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn149" onclick="toggleCodeBlock('cloneGroup149', 'expandBtn149', 'collapseBtn149')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn149" onclick="toggleCodeBlock('cloneGroup149', 'expandBtn149', 'collapseBtn149')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup149"><code class="language-typescript text-sm text-gray-800">&lt;T&gt;(
  handler: (req: NextRequest, user: AuthUser) =&gt; Promise&lt;T | NextResponse&gt;,
  roles: UserRole[],
): (req: NextRequest) =&gt; Promise&lt;T | NextResponse&gt; {
  return withAuth(async (req, user) =&gt; {
    // Check if user has all of the required roles</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/utils/seed/base-seed.ts (Line 120:8 - Line 144:2), __tests__/utils/seed/base-seed.ts (Line 92:2 - Line 117:37)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn169" onclick="toggleCodeBlock('cloneGroup169', 'expandBtn169', 'collapseBtn169')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn169" onclick="toggleCodeBlock('cloneGroup169', 'expandBtn169', 'collapseBtn169')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup169"><code class="language-typescript text-sm text-gray-800">);
      
      const user = await prisma.user.create({
        data: {
          id: testUser.id,
          name: testUser.name,
          email: testUser.email,
          clerkId: testUser.clerkId || `user_${Math.random().toString(36).substring(2, 15)}`,
          role: testUser.role,
          emailVerified: testUser.verified ? new Date() : null
        }
      });
      
      createdEntities.users.push(testUser);
      
      // Track IDs by role for later use
      if (user.role === 'BUILDER') {
        createdEntities.builderIds.push(user.id);
      } else if (user.role === 'CLIENT') {
        createdEntities.clientIds.push(user.id);
      } else if (user.role === 'ADMIN') {
        createdEntities.adminIds.push(user.id);
      }
    }
  }</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/utils/seed/base-seed.ts (Line 195:3 - Line 207:2), __tests__/utils/seed/base-seed.ts (Line 174:7 - Line 187:40)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn170" onclick="toggleCodeBlock('cloneGroup170', 'expandBtn170', 'collapseBtn170')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn170" onclick="toggleCodeBlock('cloneGroup170', 'expandBtn170', 'collapseBtn170')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup170"><code class="language-typescript text-sm text-gray-800">,
          bio: testProfile.bio,
          title: testProfile.title,
          skills: testProfile.skills,
          availability: testProfile.availability,
          hourlyRate: testProfile.hourlyRate,
          socialLinks: testProfile.socialLinks as any
        }
      });
      
      createdEntities.profiles.push(testProfile);
    }
  }</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/utils/database/transaction.ts (Line 62:5 - Line 77:2), __tests__/utils/database/transaction.ts (Line 24:5 - Line 39:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn171" onclick="toggleCodeBlock('cloneGroup171', 'expandBtn171', 'collapseBtn171')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn171" onclick="toggleCodeBlock('cloneGroup171', 'expandBtn171', 'collapseBtn171')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup171"><code class="language-typescript text-sm text-gray-800">await prisma.$executeRaw`ROLLBACK`;
    
    return result;
  } catch (error) {
    // Ensure rollback on error
    try {
      await prisma.$executeRaw`ROLLBACK`;
    } catch (rollbackError) {
      console.error('Failed to rollback transaction:', rollbackError);
    }
    
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/mocks/scheduling/mock-calendly-data.ts (Line 90:10 - Line 104:48), __tests__/mocks/scheduling/mock-calendly-data.ts (Line 56:10 - Line 70:45)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn172" onclick="toggleCodeBlock('cloneGroup172', 'expandBtn172', 'collapseBtn172')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn172" onclick="toggleCodeBlock('cloneGroup172', 'expandBtn172', 'collapseBtn172')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup172"><code class="language-typescript text-sm text-gray-800">,
      secret: false,
      type: 'StandardEventType',
      created_at: '2023-01-01T00:00:00Z',
      updated_at: '2023-01-01T00:00:00Z',
      profile: {
        type: 'User',
        name: 'Test Builder',
        owner: mockCalendlyUser.resource.uri
      },
      kind: 'solo',
      internal_note: null,
      custom_questions: [
        {
          name: 'Specific technical areas you want to discuss?'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/mocks/profile/profile-handlers.ts (Line 34:2 - Line 42:58), __tests__/mocks/profile/profile-handlers.ts (Line 18:2 - Line 26:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn173" onclick="toggleCodeBlock('cloneGroup173', 'expandBtn173', 'collapseBtn173')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn173" onclick="toggleCodeBlock('cloneGroup173', 'expandBtn173', 'collapseBtn173')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup173"><code class="language-typescript text-sm text-gray-800">params }) =&gt; {
    const { profileId } = params;
    const profileIndex = mockProfiles.findIndex(p =&gt; p.id === profileId);

    if (profileIndex === -1) {
      return new HttpResponse(null, { status: 404 });
    }

    // In a real implementation we would add the project here</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/integration/webhooks/calendly-webhook.test.ts (Line 43:2 - Line 68:28), __tests__/unit/lib/scheduling/calendly/service.test.ts (Line 193:18 - Line 218:51)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn174" onclick="toggleCodeBlock('cloneGroup174', 'expandBtn174', 'collapseBtn174')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn174" onclick="toggleCodeBlock('cloneGroup174', 'expandBtn174', 'collapseBtn174')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup174"><code class="language-typescript text-sm text-gray-800">;
    
    const webhookPayload = createMockWebhookPayload('invitee.created', eventId, inviteeId, {
      payload: {
        invitee: {
          tracking: {
            utm_source: 'buildappswith',
            utm_medium: 'scheduling',
            utm_campaign: 'booking',
            utm_content: 'session_type_id=session-1&amp;client_id=client-1'
          }
        },
        questions_and_answers: [
          {
            question: 'session_type_id',
            answer: 'session-1'
          },
          {
            question: 'client_id',
            answer: 'client-1'
          }
        ]
      }
    });
    
    // Generate valid signature</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/integration/webhooks/calendly-webhook.test.ts (Line 162:20 - Line 181:19), __tests__/integration/webhooks/calendly-webhook.test.ts (Line 80:5 - Line 99:18)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn175" onclick="toggleCodeBlock('cloneGroup175', 'expandBtn175', 'collapseBtn175')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn175" onclick="toggleCodeBlock('cloneGroup175', 'expandBtn175', 'collapseBtn175')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup175"><code class="language-typescript text-sm text-gray-800">);
    
    // Send request to webhook endpoint
    const response = await testApiHandler(handleWebhook, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Calendly-Webhook-Signature': signature
      },
      body: webhookPayload
    });
    
    // Verify response
    expect(response.status).toBe(200);
    
    const data = await response.json();
    expect(data).toMatchObject({
      success: true,
      message: expect.stringContaining('processed successfully'),
      event: 'invitee.canceled'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/integration/booking-payment/calendly-stripe-flow.test.ts (Line 258:9 - Line 267:12), __tests__/integration/booking-payment/calendly-stripe-flow.test.ts (Line 107:9 - Line 116:5)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn176" onclick="toggleCodeBlock('cloneGroup176', 'expandBtn176', 'collapseBtn176')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn176" onclick="toggleCodeBlock('cloneGroup176', 'expandBtn176', 'collapseBtn176')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup176"><code class="language-typescript text-sm text-gray-800">})
      });
      
      const data = await response.json();
      
      // Verify response
      expect(response.status).toBe(200);
      expect(data.success).toBe(true);
      expect(data.bookingId).toBeDefined();
      expect(data.state).toBeDefined</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/e2e/utils/webhook-simulators.ts (Line 505:2 - Line 519:2), __tests__/e2e/utils/webhook-simulators.ts (Line 433:6 - Line 447:5)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn179" onclick="toggleCodeBlock('cloneGroup179', 'expandBtn179', 'collapseBtn179')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn179" onclick="toggleCodeBlock('cloneGroup179', 'expandBtn179', 'collapseBtn179')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup179"><code class="language-typescript text-sm text-gray-800">,
      application: null,
      application_fee_amount: null,
      automatic_payment_methods: null,
      canceled_at: null,
      cancellation_reason: null,
      capture_method: 'automatic',
      client_secret: `pi_test_secret_${Date.now()}`,
      confirmation_method: 'automatic',
      created: Math.floor(Date.now() / 1000) - 300,
      currency: 'usd',
      customer: `cus_test_${Date.now()}`,
      description: 'Booking payment',
      invoice: null,
      last_payment_error: {</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/e2e/utils/webhook-simulators.ts (Line 536:5 - Line 561:26), __tests__/e2e/utils/webhook-simulators.ts (Line 448:2 - Line 473:12)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn180" onclick="toggleCodeBlock('cloneGroup180', 'expandBtn180', 'collapseBtn180')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn180" onclick="toggleCodeBlock('cloneGroup180', 'expandBtn180', 'collapseBtn180')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup180"><code class="language-typescript text-sm text-gray-800">,
      livemode: false,
      metadata: {
        bookingId: customData.bookingId || `booking_test_${Date.now()}`
      },
      next_action: null,
      on_behalf_of: null,
      payment_method: `pm_test_${Date.now()}`,
      payment_method_options: {
        card: {
          installments: null,
          mandate_options: null,
          network: null,
          request_three_d_secure: 'automatic'
        }
      },
      payment_method_types: ['card'],
      processing: null,
      receipt_email: 'test@example.com',
      review: null,
      setup_future_usage: null,
      shipping: null,
      source: null,
      statement_descriptor: null,
      statement_descriptor_suffix: null,
      status: 'requires_payment_method'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/e2e/utils/database-isolation.ts (Line 161:47 - Line 180:2), __tests__/utils/database/transaction.ts (Line 18:8 - Line 36:8)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn181" onclick="toggleCodeBlock('cloneGroup181', 'expandBtn181', 'collapseBtn181')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn181" onclick="toggleCodeBlock('cloneGroup181', 'expandBtn181', 'collapseBtn181')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup181"><code class="language-typescript text-sm text-gray-800">;
    
    // Execute test with transaction context
    const result = await callback(prisma);
    
    // Always rollback after test
    await prisma.$executeRaw`ROLLBACK`;
    
    return result;
  } catch (error) {
    // Ensure rollback on error
    try {
      await prisma.$executeRaw`ROLLBACK`;
    } catch (rollbackError) {
      console.error('Failed to rollback transaction:', rollbackError);
    }
    
    throw error;
  }
}</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/e2e/marketplace/search-filter.test.ts (Line 217:5 - Line 231:35), __tests__/e2e/marketplace/search-filter.test.ts (Line 176:5 - Line 190:30)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn182" onclick="toggleCodeBlock('cloneGroup182', 'expandBtn182', 'collapseBtn182')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn182" onclick="toggleCodeBlock('cloneGroup182', 'expandBtn182', 'collapseBtn182')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup182"><code class="language-typescript text-sm text-gray-800">const expertiseFilter = page.getByTestId('expertise-filter')
      .or(page.getByText(/expertise|skills|specialties/i).locator('..'));
    
    await expertiseFilter.getByText(/react/i).click();
    
    // Apply filters if needed
    const applyButton = page.getByRole('button', { name: /apply|update|filter/i });
    if (await applyButton.isVisible()) {
      await applyButton.click();
    }
    
    // Wait for results
    await AsyncUtils.waitForNetworkIdle(page);
    
    // Find and click clear all button</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/e2e/marketplace/builder-profile.test.ts (Line 121:2 - Line 128:46), __tests__/e2e/marketplace/builder-profile.test.ts (Line 113:2 - Line 120:20)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn183" onclick="toggleCodeBlock('cloneGroup183', 'expandBtn183', 'collapseBtn183')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn183" onclick="toggleCodeBlock('cloneGroup183', 'expandBtn183', 'collapseBtn183')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup183"><code class="language-typescript text-sm text-gray-800">});
    await AsyncUtils.waitForPageLoad(page);
    
    // Verify essential elements still visible
    await expect(page.getByRole('heading').filter({ hasText: /established builder/i })).toBeVisible();
    await expect(page.getByRole('button', { name: /book|schedule|session/i })).toBeVisible();
    
    // Verify sections stack vertically on mobile</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/e2e/booking/payment-integration.test.ts (Line 57:40 - Line 75:55), __tests__/e2e/booking/payment-integration.test.ts (Line 8:41 - Line 26:58)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn184" onclick="toggleCodeBlock('cloneGroup184', 'expandBtn184', 'collapseBtn184')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn184" onclick="toggleCodeBlock('cloneGroup184', 'expandBtn184', 'collapseBtn184')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup184"><code class="language-typescript text-sm text-gray-800">, async ({ page }) =&gt; {
    // Navigate through booking process to payment
    await page.goto('/book/established-builder');
    
    // Select first session type
    await page.getByTestId('session-type-card').first().click();
    await page.getByRole('button', { name: /continue|next|select date/i }).click();
    
    // Select first available date
    const availableDay = page.locator('.calendar-day:not(.calendar-day-disabled)').first();
    await AsyncUtils.ensureElementInView(availableDay);
    await availableDay.click();
    
    // Select first available time
    await page.getByTestId('time-slot').first().click();
    await page.getByRole('button', { name: /continue|next|booking details/i }).click();
    
    // Fill booking details
    await page.getByLabel(/project description|tell us about your project/i).fill('This is a test booking for declined payment testing.'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/e2e/booking/payment-integration.test.ts (Line 87:19 - Line 95:32), __tests__/e2e/booking/payment-integration.test.ts (Line 38:19 - Line 46:38)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn185" onclick="toggleCodeBlock('cloneGroup185', 'expandBtn185', 'collapseBtn185')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn185" onclick="toggleCodeBlock('cloneGroup185', 'expandBtn185', 'collapseBtn185')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup185"><code class="language-typescript text-sm text-gray-800">);
    await cardFrame.locator('[placeholder*=&quot;MM / YY&quot;]').fill('12/25');
    await cardFrame.locator('[placeholder*=&quot;CVC&quot;]').fill('123');
    await cardFrame.locator('[placeholder*=&quot;ZIP&quot;]').fill('12345');
    
    // Submit payment
    await page.getByRole('button', { name: /pay|submit|confirm/i }).click();
    
    // Verify error message appears</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/e2e/booking/payment-integration.test.ts (Line 102:45 - Line 120:57), __tests__/e2e/booking/payment-integration.test.ts (Line 8:41 - Line 26:58)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn186" onclick="toggleCodeBlock('cloneGroup186', 'expandBtn186', 'collapseBtn186')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn186" onclick="toggleCodeBlock('cloneGroup186', 'expandBtn186', 'collapseBtn186')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup186"><code class="language-typescript text-sm text-gray-800">, async ({ page }) =&gt; {
    // Navigate through booking process to payment
    await page.goto('/book/established-builder');
    
    // Select first session type
    await page.getByTestId('session-type-card').first().click();
    await page.getByRole('button', { name: /continue|next|select date/i }).click();
    
    // Select first available date
    const availableDay = page.locator('.calendar-day:not(.calendar-day-disabled)').first();
    await AsyncUtils.ensureElementInView(availableDay);
    await availableDay.click();
    
    // Select first available time
    await page.getByTestId('time-slot').first().click();
    await page.getByRole('button', { name: /continue|next|booking details/i }).click();
    
    // Fill booking details
    await page.getByLabel(/project description|tell us about your project/i).fill('This is a test booking for insufficient funds testing.'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/e2e/booking/payment-integration.test.ts (Line 132:19 - Line 141:54), __tests__/e2e/booking/payment-integration.test.ts (Line 38:19 - Line 96:45)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn187" onclick="toggleCodeBlock('cloneGroup187', 'expandBtn187', 'collapseBtn187')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn187" onclick="toggleCodeBlock('cloneGroup187', 'expandBtn187', 'collapseBtn187')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup187"><code class="language-typescript text-sm text-gray-800">);
    await cardFrame.locator('[placeholder*=&quot;MM / YY&quot;]').fill('12/25');
    await cardFrame.locator('[placeholder*=&quot;CVC&quot;]').fill('123');
    await cardFrame.locator('[placeholder*=&quot;ZIP&quot;]').fill('12345');
    
    // Submit payment
    await page.getByRole('button', { name: /pay|submit|confirm/i }).click();
    
    // Verify error message appears
    await expect(page.getByText(/insufficient funds|not enough funds|payment failed/i</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/e2e/booking/payment-integration.test.ts (Line 147:59 - Line 165:59), __tests__/e2e/booking/payment-integration.test.ts (Line 8:41 - Line 26:58)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn188" onclick="toggleCodeBlock('cloneGroup188', 'expandBtn188', 'collapseBtn188')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn188" onclick="toggleCodeBlock('cloneGroup188', 'expandBtn188', 'collapseBtn188')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup188"><code class="language-typescript text-sm text-gray-800">, async ({ page }) =&gt; {
    // Navigate through booking process to payment
    await page.goto('/book/established-builder');
    
    // Select first session type
    await page.getByTestId('session-type-card').first().click();
    await page.getByRole('button', { name: /continue|next|select date/i }).click();
    
    // Select first available date
    const availableDay = page.locator('.calendar-day:not(.calendar-day-disabled)').first();
    await AsyncUtils.ensureElementInView(availableDay);
    await availableDay.click();
    
    // Select first available time
    await page.getByTestId('time-slot').first().click();
    await page.getByRole('button', { name: /continue|next|booking details/i }).click();
    
    // Fill booking details
    await page.getByLabel(/project description|tell us about your project/i).fill('This is a test booking for payment cancellation testing.'</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/e2e/booking/booking-flow.test.ts (Line 70:5 - Line 87:2), __tests__/e2e/booking/payment-integration.test.ts (Line 35:5 - Line 53:43)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn189" onclick="toggleCodeBlock('cloneGroup189', 'expandBtn189', 'collapseBtn189')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn189" onclick="toggleCodeBlock('cloneGroup189', 'expandBtn189', 'collapseBtn189')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup189"><code class="language-typescript text-sm text-gray-800">const cardFrame = page.frameLocator('iframe[name*=&quot;card&quot;]').first();
    
    // Fill card details with Stripe test card
    await cardFrame.locator('[placeholder*=&quot;Card number&quot;]').fill('4242424242424242');
    await cardFrame.locator('[placeholder*=&quot;MM / YY&quot;]').fill('12/25');
    await cardFrame.locator('[placeholder*=&quot;CVC&quot;]').fill('123');
    await cardFrame.locator('[placeholder*=&quot;ZIP&quot;]').fill('12345');
    
    // Submit payment
    await page.getByRole('button', { name: /pay|submit|confirm/i }).click();
    
    // Wait for redirect back to our site
    await page.waitForURL(/.*\/booking\/confirmation.*/);
    
    // Verify booking confirmation
    await expect(page.getByText(/booking confirmed|thank you for your booking/i)).toBeVisible();
    await expect(page.getByText(/booking reference|confirmation number/i)).toBeVisible();
  }</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/e2e/booking/booking-flow.test.ts (Line 135:5 - Line 143:47), __tests__/e2e/booking/payment-integration.test.ts (Line 206:5 - Line 211:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn190" onclick="toggleCodeBlock('cloneGroup190', 'expandBtn190', 'collapseBtn190')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn190" onclick="toggleCodeBlock('cloneGroup190', 'expandBtn190', 'collapseBtn190')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup190"><code class="language-typescript text-sm text-gray-800">await page.getByRole('button', { name: /continue|next|select date/i }).click();
    
    const availableDay = page.locator('.calendar-day:not(.calendar-day-disabled)').first();
    await availableDay.click();
    
    await page.getByTestId('time-slot').first().click();
    await page.getByRole('button', { name: /continue|next|booking details/i }).click();
    
    // Submit form without filling required fields</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/e2e/booking/booking-flow.test.ts (Line 168:5 - Line 177:27), __tests__/e2e/booking/booking-flow.test.ts (Line 133:5 - Line 210:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn191" onclick="toggleCodeBlock('cloneGroup191', 'expandBtn191', 'collapseBtn191')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn191" onclick="toggleCodeBlock('cloneGroup191', 'expandBtn191', 'collapseBtn191')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup191"><code class="language-typescript text-sm text-gray-800">await page.goto('/book/established-builder');
    await page.getByTestId('session-type-card').first().click();
    await page.getByRole('button', { name: /continue|next|select date/i }).click();
    
    const availableDay = page.locator('.calendar-day:not(.calendar-day-disabled)').first();
    await availableDay.click();
    
    await page.getByTestId('time-slot').first().click();
    
    // Click the cancel button</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/api/webhooks/webhook-handlers.test.ts (Line 7:1 - Line 41:3), __tests__/unit/scheduling/state-machine/state-machine.test.ts (Line 79:1 - Line 113:9)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn202" onclick="toggleCodeBlock('cloneGroup202', 'expandBtn202', 'collapseBtn202')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn202" onclick="toggleCodeBlock('cloneGroup202', 'expandBtn202', 'collapseBtn202')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup202"><code class="language-typescript text-sm text-gray-800">vi.mock('@/lib/logger', () =&gt; ({
  logger: {
    info: vi.fn(),
    debug: vi.fn(),
    warn: vi.fn(),
    error: vi.fn(),
    child: vi.fn().mockReturnValue({
      info: vi.fn(),
      debug: vi.fn(),
      warn: vi.fn(),
      error: vi.fn()
    })
  },
  // For backward compatibility
  enhancedLogger: {
    info: vi.fn(),
    debug: vi.fn(),
    warn: vi.fn(),
    error: vi.fn(),
    child: vi.fn().mockReturnValue({
      info: vi.fn(),
      debug: vi.fn(),
      warn: vi.fn(),
      error: vi.fn()
    })
  },
  createDomainLogger: vi.fn().mockReturnValue({
    info: vi.fn(),
    debug: vi.fn(),
    warn: vi.fn(),
    error: vi.fn()
  })
}));

vi</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/api/webhooks/webhook-handlers.test.ts (Line 198:9 - Line 213:55), __tests__/api/webhooks/webhook-handlers.test.ts (Line 144:9 - Line 159:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn203" onclick="toggleCodeBlock('cloneGroup203', 'expandBtn203', 'collapseBtn203')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn203" onclick="toggleCodeBlock('cloneGroup203', 'expandBtn203', 'collapseBtn203')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup203"><code class="language-typescript text-sm text-gray-800">}
      };
      
      const payloadString = JSON.stringify(payload);
      const signature = generateCalendlySignature(payloadString, calendlyWebhookSecret);
      
      const response = await fetch('/api/webhooks/calendly', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'calendly-webhook-signature': signature
        },
        body: payloadString
      });
      
      // Should return 200 to prevent Calendly from retrying</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/api/webhooks/webhook-handlers.test.ts (Line 289:19 - Line 299:43), __tests__/api/webhooks/webhook-handlers.test.ts (Line 180:29 - Line 190:46)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn204" onclick="toggleCodeBlock('cloneGroup204', 'expandBtn204', 'collapseBtn204')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn204" onclick="toggleCodeBlock('cloneGroup204', 'expandBtn204', 'collapseBtn204')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup204"><code class="language-typescript text-sm text-gray-800">: 'invalid-signature'
        },
        body: JSON.stringify(payload)
      });
      
      expect(response.status).toBe(401);
      const data = await response.json();
      expect(data.error).toBeDefined();
    });
    
    it('should handle unprocessed webhook events'</code></pre></div><div class="py-4"><p class="text-gray-600">tests/profile/profile-actions.test.ts (Line 190:2 - Line 201:62), tests/profile/profile-actions.test.ts (Line 174:14 - Line 185:82)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn205" onclick="toggleCodeBlock('cloneGroup205', 'expandBtn205', 'collapseBtn205')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn205" onclick="toggleCodeBlock('cloneGroup205', 'expandBtn205', 'collapseBtn205')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup205"><code class="language-typescript text-sm text-gray-800">)
      
      expect(result).toHaveLength(2)
      expect(result[0].id).toBe('session-1')
      expect(result[1].id).toBe('session-2')
      expect(prisma.sessionType.findMany).toHaveBeenCalledWith({
        where: { builderId: mockProfileId },
        orderBy: { durationMinutes: 'asc' }
      })
    })
    
    it('should return an empty array if user has no builder profile'</code></pre></div><div class="py-4"><p class="text-gray-600">tests/calendly/calendly-stripe-integration.test.ts (Line 280:9 - Line 290:5), tests/stripe/stripe-payment.test.ts (Line 121:9 - Line 131:12)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn206" onclick="toggleCodeBlock('cloneGroup206', 'expandBtn206', 'collapseBtn206')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn206" onclick="toggleCodeBlock('cloneGroup206', 'expandBtn206', 'collapseBtn206')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup206"><code class="language-typescript text-sm text-gray-800">},
        returnUrl: 'https://example.com/confirmation'
      };

      // Act
      const result = await createCheckoutSession(request);

      // Assert
      expect(result.success).toBe(true);
      expect(result.data).toBeDefined();
      expect(result.data?.sessionId).toBe</code></pre></div><div class="py-4"><p class="text-gray-600">tests/calendly/calendly-stripe-integration.test.ts (Line 326:11 - Line 340:30), tests/calendly/calendly-stripe-integration.test.ts (Line 278:11 - Line 291:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn207" onclick="toggleCodeBlock('cloneGroup207', 'expandBtn207', 'collapseBtn207')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn207" onclick="toggleCodeBlock('cloneGroup207', 'expandBtn207', 'collapseBtn207')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup207"><code class="language-typescript text-sm text-gray-800">calendlyEventUri: 'https://api.calendly.com/events/cal_evt_123',
          calendlyInviteeUri: 'https://api.calendly.com/invitees/inv_123'
        },
        returnUrl: 'https://example.com/confirmation'
      };

      // Act
      const result = await createCheckoutSession(request);

      // Assert
      expect(result.success).toBe(true);
      expect(result.data).toBeDefined();
      expect(result.data?.sessionId).toBe('cs_test_calendly123');
      
      // Verify booking was created</code></pre></div><div class="py-4"><p class="text-gray-600">tests/calendly/calendly-stripe-integration.test.ts (Line 591:9 - Line 604:17), tests/calendly/calendly-stripe-integration.test.ts (Line 372:23 - Line 385:12)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn208" onclick="toggleCodeBlock('cloneGroup208', 'expandBtn208', 'collapseBtn208')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn208" onclick="toggleCodeBlock('cloneGroup208', 'expandBtn208', 'collapseBtn208')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup208"><code class="language-typescript text-sm text-gray-800">,
          startTime: '2025-05-01T10:00:00Z',
          endTime: '2025-05-01T11:00:00Z',
          calendlyEventId: 'cal_evt_123'
        },
        returnUrl: 'https://example.com/confirmation'
      };

      // Act
      const result = await createCheckoutSession(request);

      // Assert
      expect(result.success).toBe(false);
      expect(result.error?.type).toBe('database_error'</code></pre></div><div class="py-4"><p class="text-gray-600">tests/auth/auth-flow.test.ts (Line 35:5 - Line 46:2), __tests__/e2e/auth/auth-flow.test.ts (Line 34:2 - Line 45:21)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn209" onclick="toggleCodeBlock('cloneGroup209', 'expandBtn209', 'collapseBtn209')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn209" onclick="toggleCodeBlock('cloneGroup209', 'expandBtn209', 'collapseBtn209')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup209"><code class="language-typescript text-sm text-gray-800">)).toContainText('Liam Jons');
    
    // Verify session types are visible
    await expect(page.locator('[data-testid=&quot;session-type-card&quot;]').first()).toBeVisible();
    
    // Verify booking button is visible
    await expect(page.locator('[data-testid=&quot;booking-button&quot;]')).toBeVisible();
  });
  
  test('Authentication required for booking', async ({ page }) =&gt; {
    // Navigate to a builder profile
    await page.goto(`</code></pre></div><div class="py-4"><p class="text-gray-600">tests/auth/auth-flow.test.ts (Line 49:5 - Line 65:2), __tests__/e2e/auth/auth-flow.test.ts (Line 48:2 - Line 64:13)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn210" onclick="toggleCodeBlock('cloneGroup210', 'expandBtn210', 'collapseBtn210')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn210" onclick="toggleCodeBlock('cloneGroup210', 'expandBtn210', 'collapseBtn210')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup210"><code class="language-typescript text-sm text-gray-800">)).toContainText('Liam Jons');
    
    // Click book button
    await page.locator('[data-testid=&quot;booking-button&quot;]').click();
    
    // Verify redirect to login
    await expect(page).toHaveURL(/\/login/);
    
    // Verify return URL is included
    const url = page.url();
    expect(url).toContain('returnUrl');
    expect(url).toContain('book');
  });
  
  test('Protected dashboard redirects to login', async ({ page }) =&gt; {
    // Try to access protected dashboard
    await page.goto(`</code></pre></div><div class="py-4"><p class="text-gray-600">tests/auth/auth-flow.test.ts (Line 81:5 - Line 93:22), tests/auth/auth-flow.test.ts (Line 45:5 - Line 57:33)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn211" onclick="toggleCodeBlock('cloneGroup211', 'expandBtn211', 'collapseBtn211')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn211" onclick="toggleCodeBlock('cloneGroup211', 'expandBtn211', 'collapseBtn211')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup211"><code class="language-typescript text-sm text-gray-800">// Navigate to a builder profile
    await page.goto(`${BASE_URL}/profile/liam-jons`);
    
    // Verify profile loaded correctly
    await expect(page.locator('h1')).toContainText('Liam Jons');
    
    // Click book button
    await page.locator('[data-testid=&quot;booking-button&quot;]').click();
    
    // Verify redirect to login
    await expect(page).toHaveURL(/\/login/);
    
    // Fill in login form</code></pre></div><div class="py-4"><p class="text-gray-600">lib/stripe/schemas.ts (Line 13:2 - Line 21:28), app/api/stripe/checkout/route.ts (Line 24:2 - Line 32:32)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn212" onclick="toggleCodeBlock('cloneGroup212', 'expandBtn212', 'collapseBtn212')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn212" onclick="toggleCodeBlock('cloneGroup212', 'expandBtn212', 'collapseBtn212')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup212"><code class="language-typescript text-sm text-gray-800">z.object({
  id: z.string().optional(),
  builderId: z.string(),
  sessionTypeId: z.string(),
  startTime: z.string(),
  endTime: z.string(),
  clientId: z.string().optional(),
  clientTimezone: z.string().optional(),
  // Calendly specific fields</code></pre></div><div class="py-4"><p class="text-gray-600">lib/stripe/actions.ts (Line 719:2 - Line 736:53), lib/stripe/actions.ts (Line 38:24 - Line 55:58)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn213" onclick="toggleCodeBlock('cloneGroup213', 'expandBtn213', 'collapseBtn213')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn213" onclick="toggleCodeBlock('cloneGroup213', 'expandBtn213', 'collapseBtn213')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup213"><code class="language-typescript text-sm text-gray-800">;
  error?: {
    type: string;
    code?: string;
    detail?: string;
  };
}&gt; {
  try {
    // Check authentication
    const { userId } = auth()
    
    if (!userId) {
      return {
        success: false,
        message: 'Not authenticated',
        error: {
          type: 'authentication_error',
          detail: 'User must be authenticated to check session status'</code></pre></div><div class="py-4"><p class="text-gray-600">lib/sentry/error-classification.ts (Line 163:8 - Line 189:23), lib/sentry/error-classification.ts (Line 111:2 - Line 137:54)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn214" onclick="toggleCodeBlock('cloneGroup214', 'expandBtn214', 'collapseBtn214')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn214" onclick="toggleCodeBlock('cloneGroup214', 'expandBtn214', 'collapseBtn214')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup214"><code class="language-typescript text-sm text-gray-800">: string,
  metadata: Partial&lt;ErrorMetadata&gt; = {}
): string {
  // Merge with default metadata
  const errorMetadata: ErrorMetadata = {
    ...defaultMetadata,
    ...metadata,
  } as ErrorMetadata;

  return Sentry.withScope((scope) =&gt; {
    // Set error metadata as tags
    scope.setTag('error.severity', errorMetadata.severity);
    scope.setTag('error.category', errorMetadata.category);
    scope.setTag('error.source', errorMetadata.source);
    scope.setTag('error.component', errorMetadata.component);
    scope.setTag('error.userImpact', errorMetadata.userImpact);
    scope.setTag('error.affectedFeature', errorMetadata.affectedFeature);
    scope.setTag('error.isRecoverable', String(errorMetadata.isRecoverable));
    scope.setTag('error.retryable', String(errorMetadata.retryable));

    // Set error metadata as context for more detailed info
    scope.setContext('errorMetadata', errorMetadata);

    // Map severity for proper Sentry categorization
    scope.setLevel(mapToSentrySeverity(errorMetadata.severity));

    // Capture the message</code></pre></div><div class="py-4"><p class="text-gray-600">lib/profile/schemas.ts (Line 53:2 - Line 58:13), lib/profile/schemas.ts (Line 40:2 - Line 45:5)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn215" onclick="toggleCodeBlock('cloneGroup215', 'expandBtn215', 'collapseBtn215')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn215" onclick="toggleCodeBlock('cloneGroup215', 'expandBtn215', 'collapseBtn215')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup215"><code class="language-typescript text-sm text-gray-800">= z.object({
  id: z.string().optional(),
  title: z.string().min(1),
  description: z.string().min(1),
  imageUrl: z.string().url().optional(),
  technologies</code></pre></div><div class="py-4"><p class="text-gray-600">lib/profile/api.ts (Line 48:5 - Line 72:4), lib/profile/api.ts (Line 21:3 - Line 45:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn216" onclick="toggleCodeBlock('cloneGroup216', 'expandBtn216', 'collapseBtn216')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn216" onclick="toggleCodeBlock('cloneGroup216', 'expandBtn216', 'collapseBtn216')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup216"><code class="language-typescript text-sm text-gray-800">}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      const error = await response.json();
      return { success: false, error: error.message || 'Failed to fetch profile' };
    }

    const data = await response.json();
    return { success: true, data };
  } catch (error) {
    return { 
      success: false, 
      error: error instanceof Error ? error.message : 'An unexpected error occurred' 
    };
  }
}

/**
 * Get a builder profile by Clerk user ID
 */</code></pre></div><div class="py-4"><p class="text-gray-600">lib/profile/api.ts (Line 75:12 - Line 99:4), lib/profile/api.ts (Line 21:3 - Line 45:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn217" onclick="toggleCodeBlock('cloneGroup217', 'expandBtn217', 'collapseBtn217')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn217" onclick="toggleCodeBlock('cloneGroup217', 'expandBtn217', 'collapseBtn217')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup217"><code class="language-typescript text-sm text-gray-800">}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      const error = await response.json();
      return { success: false, error: error.message || 'Failed to fetch profile' };
    }

    const data = await response.json();
    return { success: true, data };
  } catch (error) {
    return { 
      success: false, 
      error: error instanceof Error ? error.message : 'An unexpected error occurred' 
    };
  }
}

/**
 * Get all builder profiles with optional filtering
 */</code></pre></div><div class="py-4"><p class="text-gray-600">lib/profile/api.ts (Line 184:8 - Line 193:27), lib/profile/api.ts (Line 153:7 - Line 162:27)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn218" onclick="toggleCodeBlock('cloneGroup218', 'expandBtn218', 'collapseBtn218')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn218" onclick="toggleCodeBlock('cloneGroup218', 'expandBtn218', 'collapseBtn218')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup218"><code class="language-typescript text-sm text-gray-800">,
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(profileData),
    });

    if (!response.ok) {
      const error = await response.json();
      return { success: false, error: error.message || 'Failed to update profile'</code></pre></div><div class="py-4"><p class="text-gray-600">lib/profile/actions.ts (Line 272:7 - Line 308:32), lib/profile/actions.ts (Line 201:7 - Line 237:32)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn219" onclick="toggleCodeBlock('cloneGroup219', 'expandBtn219', 'collapseBtn219')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn219" onclick="toggleCodeBlock('cloneGroup219', 'expandBtn219', 'collapseBtn219')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup219"><code class="language-typescript text-sm text-gray-800">}
    })
    
    // Revalidate profile path
    revalidatePath(`/profile/${updatedProfile.slug || user.id}`)
    
    return {
      userId: user.id,
      clerkId: user.clerkId || undefined,
      email: user.email,
      name: user.name || undefined,
      profile: {
        id: updatedProfile.id,
        bio: updatedProfile.bio || undefined,
        headline: updatedProfile.headline || undefined,
        slug: updatedProfile.slug || undefined,
        tagline: updatedProfile.tagline || undefined,
        displayName: updatedProfile.displayName || undefined,
        validationTier: updatedProfile.validationTier,
        domains: updatedProfile.domains,
        badges: updatedProfile.badges,
        completedProjects: updatedProfile.completedProjects,
        responseRate: updatedProfile.responseRate || undefined,
        hourlyRate: updatedProfile.hourlyRate?.toNumber() || undefined,
        availableForHire: updatedProfile.availableForHire,
        adhd_focus: updatedProfile.adhd_focus || false,
        expertiseAreas: updatedProfile.expertiseAreas as Record&lt;string, any&gt; || {},
        socialLinks: updatedProfile.socialLinks as Record&lt;string, string&gt; || {},
        portfolioItems: updatedProfile.portfolioItems as any[] || [],
        featured: updatedProfile.featured,
        searchable: updatedProfile.searchable,
        availability: updatedProfile.availability,
        topSkills: updatedProfile.topSkills
      }
    }
  } catch (error) {
    logger.error('Error in updateExpertiseAreas'</code></pre></div><div class="py-4"><p class="text-gray-600">lib/profile/actions.ts (Line 430:11 - Line 442:19), lib/profile/actions.ts (Line 415:11 - Line 425:5)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn220" onclick="toggleCodeBlock('cloneGroup220', 'expandBtn220', 'collapseBtn220')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn220" onclick="toggleCodeBlock('cloneGroup220', 'expandBtn220', 'collapseBtn220')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup220"><code class="language-typescript text-sm text-gray-800">title: data.title,
          description: data.description,
          durationMinutes: data.durationMinutes,
          price: data.price,
          currency: data.currency,
          isActive: data.isActive,
          color: data.color,
          maxParticipants: data.maxParticipants
        }
      })
    }
    
    // Revalidate path</code></pre></div><div class="py-4"><p class="text-gray-600">lib/profile/actions.ts (Line 446:3 - Line 455:2), lib/scheduling/real-data/scheduling-service-ext.ts (Line 38:10 - Line 46:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn221" onclick="toggleCodeBlock('cloneGroup221', 'expandBtn221', 'collapseBtn221')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn221" onclick="toggleCodeBlock('cloneGroup221', 'expandBtn221', 'collapseBtn221')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup221"><code class="language-typescript text-sm text-gray-800">,
      title: sessionType.title,
      description: sessionType.description,
      durationMinutes: sessionType.durationMinutes,
      price: sessionType.price.toNumber(),
      currency: sessionType.currency,
      isActive: sessionType.isActive,
      color: sessionType.color || undefined,
      maxParticipants: sessionType.maxParticipants || undefined
    }</code></pre></div><div class="py-4"><p class="text-gray-600">lib/middleware/validation.ts (Line 152:18 - Line 162:31), lib/middleware/validation.ts (Line 81:23 - Line 91:50)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn222" onclick="toggleCodeBlock('cloneGroup222', 'expandBtn222', 'collapseBtn222')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn222" onclick="toggleCodeBlock('cloneGroup222', 'expandBtn222', 'collapseBtn222')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup222"><code class="language-typescript text-sm text-gray-800">];
  requiredProperties.forEach(prop =&gt; {
    if (!(prop in config)) {
      errors.push({
        path: `${basePath}.${prop}`,
        message: `Required property '${prop}' is missing`
      });
    }
  });
  
  // Validate CSRF configuration</code></pre></div><div class="py-4"><p class="text-gray-600">lib/marketplace/api.ts (Line 8:10 - Line 40:11), lib/marketplace/data-service.ts (Line 7:10 - Line 39:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn223" onclick="toggleCodeBlock('cloneGroup223', 'expandBtn223', 'collapseBtn223')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn223" onclick="toggleCodeBlock('cloneGroup223', 'expandBtn223', 'collapseBtn223')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup223"><code class="language-typescript text-sm text-gray-800">;

/**
 * Fetch builders from the API with pagination and filtering
 */
export async function fetchBuilders(
  page: number = 1, 
  limit: number = 9,
  filters?: MarketplaceFilters
): Promise&lt;BuildersResponse&gt; {
  try {
    // Build query parameters
    const params = new URLSearchParams();
    params.append('page', page.toString());
    params.append('limit', limit.toString());
    
    if (filters?.searchQuery) {
      params.append('search', filters.searchQuery);
    }
    
    if (filters?.validationTiers &amp;&amp; filters.validationTiers.length &gt; 0) {
      params.append('validationTiers', filters.validationTiers.join(','));
    }
    
    if (filters?.skills &amp;&amp; filters.skills.length &gt; 0) {
      params.append('skills', filters.skills.join(','));
    }
    
    if (filters?.availability &amp;&amp; filters.availability.length &gt; 0) {
      params.append('availability', filters.availability.join(','));
    }
    
    if (filters?.adhd_focus</code></pre></div><div class="py-4"><p class="text-gray-600">lib/marketplace/api.ts (Line 57:2 - Line 99:22), lib/marketplace/data-service.ts (Line 40:7 - Line 82:19)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn224" onclick="toggleCodeBlock('cloneGroup224', 'expandBtn224', 'collapseBtn224')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn224" onclick="toggleCodeBlock('cloneGroup224', 'expandBtn224', 'collapseBtn224')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup224"><code class="language-typescript text-sm text-gray-800">);
    }
    
    // Fetch data from API
    const response = await fetch(`/api/marketplace/builders?${params.toString()}`);
    
    if (!response.ok) {
      throw new Error(`Failed to fetch builders: ${response.status}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error(&quot;Error fetching builders:&quot;, error);
    throw error;
  }
}

/**
 * Fetch a single builder by ID
 */
export async function fetchBuilderById(builderId: string): Promise&lt;BuilderProfileData | null&gt; {
  try {
    const response = await fetch(`/api/marketplace/builders/${builderId}`);
    
    if (response.status === 404) {
      return null;
    }
    
    if (!response.ok) {
      throw new Error(`Failed to fetch builder: ${response.status}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error(`Error fetching builder ${builderId}:`, error);
    throw error;
  }
}

/**
 * Fetch featured builders
 */
export async function fetchFeaturedBuilders(limit: number = 3): Promise&lt;BuilderProfileListing</code></pre></div><div class="py-4"><p class="text-gray-600">lib/marketplace/api.ts (Line 101:48 - Line 132:2), lib/marketplace/data-service.ts (Line 84:34 - Line 115:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn225" onclick="toggleCodeBlock('cloneGroup225', 'expandBtn225', 'collapseBtn225')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn225" onclick="toggleCodeBlock('cloneGroup225', 'expandBtn225', 'collapseBtn225')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup225"><code class="language-typescript text-sm text-gray-800">${limit}`);
    
    if (!response.ok) {
      throw new Error(`Failed to fetch featured builders: ${response.status}`);
    }
    
    const result = await response.json();
    return result.data;
  } catch (error) {
    console.error(&quot;Error fetching featured builders:&quot;, error);
    throw error;
  }
}

/**
 * Fetch available marketplace filter options
 */
export async function fetchMarketplaceFilterOptions(): Promise&lt;MarketplaceFilterOptions&gt; {
  try {
    const response = await fetch('/api/marketplace/filters');
    
    if (!response.ok) {
      throw new Error(`Failed to fetch filter options: ${response.status}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error(&quot;Error fetching marketplace filters:&quot;, error);
    // Return empty filters as fallback
    return { skills: [] };
  }
}</code></pre></div><div class="py-4"><p class="text-gray-600">lib/marketplace/api.ts (Line 137:1 - Line 159:7), lib/marketplace/data/analytics-service.ts (Line 15:1 - Line 43:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn226" onclick="toggleCodeBlock('cloneGroup226', 'expandBtn226', 'collapseBtn226')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn226" onclick="toggleCodeBlock('cloneGroup226', 'expandBtn226', 'collapseBtn226')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup226"><code class="language-typescript text-sm text-gray-800">export interface AnalyticsSummary {
  profileViews: number;
  profileViewsChange: number;
  searchAppearances: number;
  searchAppearancesChange: number;
  bookingRequests: number;
  bookingRequestsChange: number;
  conversionRate: number;
  conversionRateChange: number;
}

export interface AnalyticsTimeseriesPoint {
  date: string;
  value: number;
}

export interface AnalyticsTimeseries {
  profileViews: AnalyticsTimeseriesPoint[];
  searchAppearances: AnalyticsTimeseriesPoint[];
  bookingRequests: AnalyticsTimeseriesPoint[];
}

export</code></pre></div><div class="py-4"><p class="text-gray-600">lib/datadog/rum-config.ts (Line 12:1 - Line 31:4), lib/datadog/interfaces/rum.ts (Line 14:1 - Line 33:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn227" onclick="toggleCodeBlock('cloneGroup227', 'expandBtn227', 'collapseBtn227')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn227" onclick="toggleCodeBlock('cloneGroup227', 'expandBtn227', 'collapseBtn227')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup227"><code class="language-typescript text-sm text-gray-800">export interface RumConfig {
  enabled: boolean;
  applicationId: string;
  clientToken: string;
  site: string;
  service: string;
  env: DatadogEnvironment;
  version: string;
  sessionSampleRate: number;
  sessionReplaySampleRate: number;
  trackInteractions: boolean;
  trackResources: boolean;
  trackLongTasks: boolean;
  defaultPrivacyLevel: 'allow' | 'mask' | 'mask-user-input' | 'forbid';
  actionNameAttribute: string;
}

/**
 * Get the RUM configuration for the current environment
 */</code></pre></div><div class="py-4"><p class="text-gray-600">lib/datadog/rum-config.ts (Line 39:15 - Line 77:4), lib/datadog/config/rum-config.ts (Line 25:5 - Line 63:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn228" onclick="toggleCodeBlock('cloneGroup228', 'expandBtn228', 'collapseBtn228')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn228" onclick="toggleCodeBlock('cloneGroup228', 'expandBtn228', 'collapseBtn228')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup228"><code class="language-typescript text-sm text-gray-800">,
    service: config.service,
    env: config.env,
    version: config.version,
    sessionSampleRate: config.rumSampleRate,
    sessionReplaySampleRate: config.rumSessionReplaySampleRate,
    trackInteractions: true,
    trackResources: true,
    trackLongTasks: true,
    defaultPrivacyLevel: 'mask-user-input',
    actionNameAttribute: 'data-dd-action-name',
  };
}

/**
 * Validates that all required environment variables are set for RUM
 */
export function validateRumEnvironmentVariables(): boolean {
  const missing: string[] = [];
  
  if (!process.env.NEXT_PUBLIC_DATADOG_RUM_APPLICATION_ID) {
    missing.push('NEXT_PUBLIC_DATADOG_RUM_APPLICATION_ID');
  }
  
  if (!process.env.NEXT_PUBLIC_DATADOG_RUM_CLIENT_TOKEN) {
    missing.push('NEXT_PUBLIC_DATADOG_RUM_CLIENT_TOKEN');
  }
  
  if (missing.length &gt; 0) {
    console.warn(`Missing required environment variables for Datadog RUM: ${missing.join(', ')}`);
    return false;
  }
  
  return true;
}

/**
 * User information to associate with RUM sessions
 */</code></pre></div><div class="py-4"><p class="text-gray-600">lib/datadog/rum-config.ts (Line 84:1 - Line 99:2), lib/datadog/config/rum-config.ts (Line 59:1 - Line 74:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn229" onclick="toggleCodeBlock('cloneGroup229', 'expandBtn229', 'collapseBtn229')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn229" onclick="toggleCodeBlock('cloneGroup229', 'expandBtn229', 'collapseBtn229')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup229"><code class="language-typescript text-sm text-gray-800">}

/**
 * Sanitizes user information for RUM to ensure privacy compliance
 */
export function sanitizeRumUserInfo(userInfo: RumUserInfo): RumUserInfo {
  return {
    id: userInfo.id, // Required
    name: userInfo.name,
    email: userInfo.email,
    role: userInfo.role,
    // Add only specific allowed custom properties
    ...(userInfo.plan ? { plan: userInfo.plan } : {}),
    ...(userInfo.accountType ? { accountType: userInfo.accountType } : {}),
  };
}</code></pre></div><div class="py-4"><p class="text-gray-600">lib/datadog/init.ts (Line 100:13 - Line 119:4), lib/datadog/client/rum.client.ts (Line 65:7 - Line 78:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn230" onclick="toggleCodeBlock('cloneGroup230', 'expandBtn230', 'collapseBtn230')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn230" onclick="toggleCodeBlock('cloneGroup230', 'expandBtn230', 'collapseBtn230')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup230"><code class="language-typescript text-sm text-gray-800">.env} environment`);
      } catch (error) {
        console.error(&quot;Failed to initialize Datadog RUM:&quot;, error);
      }
    }).catch(err =&gt; {
      console.warn('Failed to import Datadog browser RUM:', err);
    });
    
    return true;
  } catch (error) {
    console.error('Failed to initialize Datadog RUM:', error);
    return false;
  }
}

/**
 * Sets the current user for RUM tracking
 * 
 * @param user User information or null to clear user
 */</code></pre></div><div class="py-4"><p class="text-gray-600">lib/datadog/init.ts (Line 127:2 - Line 146:4), lib/datadog/client/rum.client.ts (Line 84:2 - Line 97:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn231" onclick="toggleCodeBlock('cloneGroup231', 'expandBtn231', 'collapseBtn231')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn231" onclick="toggleCodeBlock('cloneGroup231', 'expandBtn231', 'collapseBtn231')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup231"><code class="language-typescript text-sm text-gray-800">!rumInitialized) return;
  
  try {
    if (datadogRum) {
      if (user) {
        datadogRum.setUser(user);
      } else {
        datadogRum.removeUser();
      }
    }
  } catch (error) {
    console.error('Failed to set RUM user:', error);
  }
}

/**
 * Sets global context information for RUM
 * 
 * @param context Context object to set
 */</code></pre></div><div class="py-4"><p class="text-gray-600">lib/datadog/init.ts (Line 206:14 - Line 220:2), lib/datadog/client/logs.client.ts (Line 49:11 - Line 63:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn232" onclick="toggleCodeBlock('cloneGroup232', 'expandBtn232', 'collapseBtn232')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn232" onclick="toggleCodeBlock('cloneGroup232', 'expandBtn232', 'collapseBtn232')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup232"><code class="language-typescript text-sm text-gray-800">,
        beforeSend: (log: any) =&gt; {
          // Filter sensitive data
          if (log.http?.url) {
            // Redact potentially sensitive URL parameters
            log.http.url = log.http.url.replace(/([?&amp;](password|token|key|secret|auth)=)[^&amp;]+/gi, '$1[REDACTED]');
          }
          return log;
        },
      });

      // Mark as initialized
      logsInitialized = true;
      console.log(`Datadog logs initialized for ${config.env} environment`);
    })</code></pre></div><div class="py-4"><p class="text-gray-600">lib/datadog/init.ts (Line 342:5 - Line 357:7), lib/datadog/tracer.ts (Line 69:5 - Line 84:17)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn233" onclick="toggleCodeBlock('cloneGroup233', 'expandBtn233', 'collapseBtn233')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn233" onclick="toggleCodeBlock('cloneGroup233', 'expandBtn233', 'collapseBtn233')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup233"><code class="language-typescript text-sm text-gray-800">// Configure Next.js integration
    tracer.use('next', { 
      hooks: true, 
      router: true, 
      server: true 
    });

    // Configure HTTP integration
    tracer.use('http', { 
      client: true, 
      server: true 
    });

    // Configure Prisma integration
    tracer.use('prisma', { 
      service: `${config</code></pre></div><div class="py-4"><p class="text-gray-600">lib/datadog/context-propagation.ts (Line 97:7 - Line 124:4), lib/datadog/server/trace-context.server.ts (Line 46:8 - Line 67:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn234" onclick="toggleCodeBlock('cloneGroup234', 'expandBtn234', 'collapseBtn234')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn234" onclick="toggleCodeBlock('cloneGroup234', 'expandBtn234', 'collapseBtn234')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup234"><code class="language-typescript text-sm text-gray-800">) return null;

    // Extract the trace context from headers
    const context = tracer.extract('http_headers', headers);
    if (!context) return null;

    // Create a new span as a child of the extracted context
    const span = tracer.startSpan(spanName, {
      childOf: context,
      tags: {
        service: config.service,
        version: config.version,
        env: config.env,
      },
    });

    return span;
  } catch (error) {
    console.error('Failed to extract trace context from headers:', error);
    return null;
  }
}

/**
 * Serializes trace context to a JSON string for client storage
 * @param context The trace context to serialize
 * @returns Serialized context as string
 */</code></pre></div><div class="py-4"><p class="text-gray-600">lib/datadog/context-propagation.ts (Line 135:2 - Line 143:2), lib/datadog/server/trace-context.server.ts (Line 80:3 - Line 88:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn235" onclick="toggleCodeBlock('cloneGroup235', 'expandBtn235', 'collapseBtn235')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn235" onclick="toggleCodeBlock('cloneGroup235', 'expandBtn235', 'collapseBtn235')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup235"><code class="language-typescript text-sm text-gray-800">deserializeTraceContext(serializedContext: string): TraceContext | null {
  try {
    if (!serializedContext) return null;
    return JSON.parse(serializedContext) as TraceContext;
  } catch (error) {
    console.error('Failed to deserialize trace context:', error);
    return null;
  }
}</code></pre></div><div class="py-4"><p class="text-gray-600">lib/datadog/config.ts (Line 28:1 - Line 43:6), lib/datadog/config/base-config.ts (Line 37:1 - Line 54:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn236" onclick="toggleCodeBlock('cloneGroup236', 'expandBtn236', 'collapseBtn236')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn236" onclick="toggleCodeBlock('cloneGroup236', 'expandBtn236', 'collapseBtn236')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup236"><code class="language-typescript text-sm text-gray-800">export interface DatadogConfig {
  service: string;
  version: string;
  env: DatadogEnvironment;
  site: string;
  enabled: boolean;
  sampleRate: number;
  logSampleRate: number;
  rumSampleRate: number;
  rumSessionReplaySampleRate: number;
  profiling: boolean;
  debugging: boolean;
  criticalTransactions: string[];
}

const</code></pre></div><div class="py-4"><p class="text-gray-600">lib/datadog/config.ts (Line 48:3 - Line 139:4), lib/datadog/config/base-config.ts (Line 60:3 - Line 152:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn237" onclick="toggleCodeBlock('cloneGroup237', 'expandBtn237', 'collapseBtn237')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn237" onclick="toggleCodeBlock('cloneGroup237', 'expandBtn237', 'collapseBtn237')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup237"><code class="language-typescript text-sm text-gray-800">// Critical transactions to always trace (100% sampling)
  criticalTransactions: [
    'auth.signup',
    'auth.login',
    'auth.verify',
    'auth.refresh',
    'auth.protected',
    'auth.role',
    'auth.permission',
    'payment.process',
    'booking.create',
    'marketplace.search',
  ],

  // Environment-specific configurations
  environments: {
    [DatadogEnvironment.DEVELOPMENT]: {
      enabled: process.env.DATADOG_ENABLE_DEV === 'true',
      sampleRate: 1.0,
      logSampleRate: 1.0,
      rumSampleRate: 1.0,
      rumSessionReplaySampleRate: 1.0,
      profiling: true,
      debugging: true,
    },
    [DatadogEnvironment.TESTING]: {
      enabled: process.env.DATADOG_ENABLE_TEST === 'true',
      sampleRate: 1.0,
      logSampleRate: 1.0,
      rumSampleRate: 1.0,
      rumSessionReplaySampleRate: 0.0, // Disable replay in test
      profiling: false,
      debugging: true,
    },
    [DatadogEnvironment.STAGING]: {
      enabled: true,
      sampleRate: 0.5,
      logSampleRate: 0.5,
      rumSampleRate: 0.5,
      rumSessionReplaySampleRate: 0.3,
      profiling: true,
      debugging: true,
    },
    [DatadogEnvironment.PRODUCTION]: {
      enabled: true,
      sampleRate: 0.1,
      logSampleRate: 0.2,
      rumSampleRate: 0.1,
      rumSessionReplaySampleRate: 0.05,
      profiling: true,
      debugging: false,
    },
  },
};

/**
 * Gets the current environment based on NODE_ENV
 */
export function getCurrentEnvironment(): DatadogEnvironment {
  // Use NEXT_PUBLIC env var for client-side compatibility
  const env = process.env.NEXT_PUBLIC_NODE_ENV || process.env.NODE_ENV;
  return (env as DatadogEnvironment) || DatadogEnvironment.DEVELOPMENT;
}

/**
 * Gets the environment-specific configuration
 */
export function getEnvironmentConfig(): EnvironmentConfig {
  const env = getCurrentEnvironment();
  return datadogConfigBase.environments[env] || datadogConfigBase.environments[DatadogEnvironment.DEVELOPMENT];
}

/**
 * Returns the complete Datadog configuration
 */
export function getDatadogConfig(): DatadogConfig {
  const envConfig = getEnvironmentConfig();
  const env = getCurrentEnvironment();
  
  return {
    service: datadogConfigBase.service,
    version: datadogConfigBase.version,
    env,
    site: datadogConfigBase.site,
    criticalTransactions: datadogConfigBase.criticalTransactions,
    ...envConfig,
  };
}

/**
 * Determines if the specified transaction is critical and should always be traced
 */</code></pre></div><div class="py-4"><p class="text-gray-600">lib/datadog/config.ts (Line 134:2 - Line 154:2), lib/datadog/config/base-config.ts (Line 158:5 - Line 178:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn238" onclick="toggleCodeBlock('cloneGroup238', 'expandBtn238', 'collapseBtn238')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn238" onclick="toggleCodeBlock('cloneGroup238', 'expandBtn238', 'collapseBtn238')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup238"><code class="language-typescript text-sm text-gray-800">;
}

/**
 * Determines if the specified transaction is critical and should always be traced
 */
export function isCriticalTransaction(transactionName: string): boolean {
  return datadogConfigBase.criticalTransactions.includes(transactionName);
}

/**
 * Gets the appropriate sample rate for a transaction
 * - Critical transactions are always sampled (1.0)
 * - Non-critical transactions use the environment's sample rate
 */
export function getTransactionSampleRate(transactionName: string): number {
  if (isCriticalTransaction(transactionName)) {
    return 1.0;
  }
  return getEnvironmentConfig().sampleRate;
}</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/types.ts (Line 1:1 - Line 56:10), libs/auth/src/lib/types.ts (Line 1:1 - Line 56:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn239" onclick="toggleCodeBlock('cloneGroup239', 'expandBtn239', 'collapseBtn239')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn239" onclick="toggleCodeBlock('cloneGroup239', 'expandBtn239', 'collapseBtn239')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup239"><code class="language-typescript text-sm text-gray-800">/**
 * Authentication Types
 * 
 * This file defines the common types used throughout the authentication system.
 * 
 * Version: 1.0.0
 */

/**
 * User roles in the system
 */
export enum UserRole {
  ADMIN = 'ADMIN',
  BUILDER = 'BUILDER',
  CLIENT = 'CLIENT',
}

/**
 * Extended user data with application-specific fields
 */
export interface AuthUser {
  id: string;
  name: string;
  email: string;
  imageUrl: string;
  roles: UserRole[];
  verified: boolean;
  completedOnboarding?: boolean;
  stripeCustomerId?: string;
  builderProfile?: {
    id: string;
    slug: string;
    validationTier: number;
  };
  clientProfile?: {
    id: string;
  };
}

/**
 * Authentication error types
 */
export enum AuthErrorType {
  AUTHENTICATION_ERROR = 'AUTHENTICATION_ERROR',
  AUTHORIZATION_ERROR = 'AUTHORIZATION_ERROR',
  CONFIGURATION_ERROR = 'CONFIGURATION_ERROR',
  VALIDATION_ERROR = 'VALIDATION_ERROR',
  RATE_LIMIT_ERROR = 'RATE_LIMIT_ERROR',
  SERVER_ERROR = 'SERVER_ERROR',
  UNKNOWN_ERROR = 'UNKNOWN_ERROR',
}

/**
 * Standardized authentication error
 */
export interface</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/types.ts (Line 61:1 - Line 102:2), libs/auth/src/lib/types.ts (Line 65:1 - Line 106:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn240" onclick="toggleCodeBlock('cloneGroup240', 'expandBtn240', 'collapseBtn240')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn240" onclick="toggleCodeBlock('cloneGroup240', 'expandBtn240', 'collapseBtn240')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup240"><code class="language-typescript text-sm text-gray-800">}

/**
 * Standardized API response for authentication operations
 */
export interface AuthResponse&lt;T = any&gt; {
  success: boolean;
  message: string;
  data?: T;
  error?: AuthError;
}

/**
 * Authentication options for sign-in and sign-out
 */
export interface AuthOptions {
  callbackUrl?: string;
  redirectUrl?: string;
}

/**
 * Authentication middleware options
 */
export interface AuthMiddlewareOptions {
  requireAuth?: boolean;
  requireRoles?: UserRole[];
}

/**
 * Authentication context type for providers
 */
export interface AuthContextType {
  user: AuthUser | null;
  isLoaded: boolean;
  isSignedIn: boolean;
  roles: UserRole[];
  hasRole: (role: UserRole) =&gt; boolean;
  isAdmin: boolean;
  isBuilder: boolean;
  isClient: boolean;
  signOut: (options?: AuthOptions) =&gt; Promise&lt;void&gt;;
}</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/data-access.ts (Line 148:11 - Line 156:33), lib/auth/data-access.ts (Line 121:8 - Line 129:49)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn241" onclick="toggleCodeBlock('cloneGroup241', 'expandBtn241', 'collapseBtn241')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn241" onclick="toggleCodeBlock('cloneGroup241', 'expandBtn241', 'collapseBtn241')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup241"><code class="language-typescript text-sm text-gray-800">: async (userId: string, role: UserRole) =&gt; {
    const user = await db.user.findUnique({
      where: { id: userId },
      select: { roles: true }
    });
    
    if (!user) throw new Error('User not found');
    
    // Filter out the role to remove</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/clerk-reference.ts (Line 5:2 - Line 32:2), lib/auth/express/middleware.ts (Line 19:2 - Line 46:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn242" onclick="toggleCodeBlock('cloneGroup242', 'expandBtn242', 'collapseBtn242')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn242" onclick="toggleCodeBlock('cloneGroup242', 'expandBtn242', 'collapseBtn242')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup242"><code class="language-typescript text-sm text-gray-800">[
    &quot;/&quot;,
    &quot;/login&quot;,
    &quot;/signup&quot;,
    &quot;/signin&quot;,
    &quot;/sign-in&quot;,
    &quot;/sign-in/(.*)&quot;,
    &quot;/sign-up&quot;,
    &quot;/sign-up/(.*)&quot;,
    &quot;/sso-callback&quot;,
    &quot;/verify&quot;,
    &quot;/api/auth/(.+)&quot;,
    &quot;/api/webhook/(.+)&quot;,
    &quot;/api/marketplace/builders&quot;,
    &quot;/api/marketplace/featured&quot;,
    &quot;/api/marketplace/filters&quot;,
    &quot;/api/timeline/(.+)&quot;,
    &quot;/toolkit&quot;,
    &quot;/how-it-works&quot;,
    &quot;/weekly-sessions&quot;,
    &quot;/about&quot;,
    &quot;/contact&quot;,
    &quot;/privacy&quot;,
    &quot;/terms&quot;,
    &quot;/liam&quot;,
    &quot;/builder-profile/(.+)&quot;,
    &quot;/auth-test&quot;,
  ],</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/clerk-middleware.ts (Line 7:1 - Line 38:4), lib/auth/express/middleware.ts (Line 19:1 - Line 51:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn243" onclick="toggleCodeBlock('cloneGroup243', 'expandBtn243', 'collapseBtn243')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn243" onclick="toggleCodeBlock('cloneGroup243', 'expandBtn243', 'collapseBtn243')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup243"><code class="language-typescript text-sm text-gray-800">export const publicRoutes = [
  &quot;/&quot;,
  &quot;/login&quot;,
  &quot;/signup&quot;,
  &quot;/signin&quot;,
  &quot;/sign-in&quot;,
  &quot;/sign-in/(.*)&quot;,
  &quot;/sign-up&quot;,
  &quot;/sign-up/(.*)&quot;,
  &quot;/sso-callback&quot;,
  &quot;/verify&quot;,
  &quot;/api/auth/(.+)&quot;,
  &quot;/api/webhook/(.+)&quot;,
  &quot;/api/marketplace/builders&quot;,
  &quot;/api/marketplace/featured&quot;,
  &quot;/api/marketplace/filters&quot;,
  &quot;/api/timeline/(.+)&quot;,
  &quot;/toolkit&quot;,
  &quot;/how-it-works&quot;,
  &quot;/weekly-sessions&quot;,
  &quot;/about&quot;,
  &quot;/contact&quot;,
  &quot;/privacy&quot;,
  &quot;/terms&quot;,
  &quot;/liam&quot;,
  &quot;/builder-profile/(.+)&quot;,
  &quot;/auth-test&quot;,
];

/**
 * Routes that should be ignored by the middleware
 */</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/clerk-fix.ts (Line 1:1 - Line 47:2), lib/auth/clerk-reference.ts (Line 1:1 - Line 47:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn244" onclick="toggleCodeBlock('cloneGroup244', 'expandBtn244', 'collapseBtn244')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn244" onclick="toggleCodeBlock('cloneGroup244', 'expandBtn244', 'collapseBtn244')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup244"><code class="language-typescript text-sm text-gray-800">import { authMiddleware } from &quot;@clerk/nextjs&quot;;

// Use Clerk's recommended matcher pattern
export default authMiddleware({
  publicRoutes: [
    &quot;/&quot;,
    &quot;/login&quot;,
    &quot;/signup&quot;,
    &quot;/signin&quot;,
    &quot;/sign-in&quot;,
    &quot;/sign-in/(.*)&quot;,
    &quot;/sign-up&quot;,
    &quot;/sign-up/(.*)&quot;,
    &quot;/sso-callback&quot;,
    &quot;/verify&quot;,
    &quot;/api/auth/(.+)&quot;,
    &quot;/api/webhook/(.+)&quot;,
    &quot;/api/marketplace/builders&quot;,
    &quot;/api/marketplace/featured&quot;,
    &quot;/api/marketplace/filters&quot;,
    &quot;/api/timeline/(.+)&quot;,
    &quot;/toolkit&quot;,
    &quot;/how-it-works&quot;,
    &quot;/weekly-sessions&quot;,
    &quot;/about&quot;,
    &quot;/contact&quot;,
    &quot;/privacy&quot;,
    &quot;/terms&quot;,
    &quot;/liam&quot;,
    &quot;/builder-profile/(.+)&quot;,
    &quot;/auth-test&quot;,
  ],
});

// Configure the middleware for proper patterns
export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * - public folder
     */
    &quot;/((?!_next/static|_next/image|favicon.ico).*)&quot;,
  ],
};</code></pre></div><div class="py-4"><p class="text-gray-600">lib/auth/actions.ts (Line 195:2 - Line 210:23), lib/auth/actions.ts (Line 104:2 - Line 119:42)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn245" onclick="toggleCodeBlock('cloneGroup245', 'expandBtn245', 'collapseBtn245')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn245" onclick="toggleCodeBlock('cloneGroup245', 'expandBtn245', 'collapseBtn245')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup245"><code class="language-typescript text-sm text-gray-800">;
    
    // Update the user in the database
    await db.user.update({
      where: { id: userId },
      data: { roles: newRoles }
    });
    
    // Also update the roles in Clerk's metadata
    if (user.clerkId) {
      await clerkClient.users.updateUser(user.clerkId, {
        publicMetadata: { roles: newRoles }
      });
    }
    
    // Log the role change</code></pre></div><div class="py-4"><p class="text-gray-600">lib/admin/api.ts (Line 70:37 - Line 83:37), lib/admin/api.ts (Line 19:39 - Line 32:39)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn246" onclick="toggleCodeBlock('cloneGroup246', 'expandBtn246', 'collapseBtn246')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn246" onclick="toggleCodeBlock('cloneGroup246', 'expandBtn246', 'collapseBtn246')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup246"><code class="language-typescript text-sm text-gray-800">,
        error: {
          type: AdminErrorType.RETRIEVAL,
          detail: `Server responded with ${response.status}`,
        },
      };
    }

    const data = await response.json();

    if (!data.success) {
      return {
        success: false,
        message: data.message || &quot;Failed to retrieve system settings&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">lib/admin/api.ts (Line 194:40 - Line 207:40), lib/admin/api.ts (Line 19:39 - Line 32:39)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn247" onclick="toggleCodeBlock('cloneGroup247', 'expandBtn247', 'collapseBtn247')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn247" onclick="toggleCodeBlock('cloneGroup247', 'expandBtn247', 'collapseBtn247')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup247"><code class="language-typescript text-sm text-gray-800">,
        error: {
          type: AdminErrorType.RETRIEVAL,
          detail: `Server responded with ${response.status}`,
        },
      };
    }

    const data = await response.json();

    if (!data.success) {
      return {
        success: false,
        message: data.message || &quot;Failed to retrieve verification queue&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">lib/admin/api.ts (Line 256:47 - Line 269:47), lib/admin/api.ts (Line 130:35 - Line 143:35)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn248" onclick="toggleCodeBlock('cloneGroup248', 'expandBtn248', 'collapseBtn248')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn248" onclick="toggleCodeBlock('cloneGroup248', 'expandBtn248', 'collapseBtn248')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup248"><code class="language-typescript text-sm text-gray-800">,
        error: {
          type: AdminErrorType.UPDATE,
          detail: `Server responded with ${response.status}`,
        },
      };
    }

    const data = await response.json();

    if (!data.success) {
      return {
        success: false,
        message: data.message || &quot;Failed to update builder verification status&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">lib/admin/api.ts (Line 391:29 - Line 404:29), lib/admin/api.ts (Line 130:35 - Line 143:35)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn249" onclick="toggleCodeBlock('cloneGroup249', 'expandBtn249', 'collapseBtn249')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn249" onclick="toggleCodeBlock('cloneGroup249', 'expandBtn249', 'collapseBtn249')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup249"><code class="language-typescript text-sm text-gray-800">,
        error: {
          type: AdminErrorType.UPDATE,
          detail: `Server responded with ${response.status}`,
        },
      };
    }

    const data = await response.json();

    if (!data.success) {
      return {
        success: false,
        message: data.message || &quot;Failed to manage user role&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">hooks/scheduling/use-booking-flow.ts (Line 163:2 - Line 178:15), hooks/scheduling/use-booking-flow.ts (Line 97:2 - Line 112:29)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn250" onclick="toggleCodeBlock('cloneGroup250', 'expandBtn250', 'collapseBtn250')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn250" onclick="toggleCodeBlock('cloneGroup250', 'expandBtn250', 'collapseBtn250')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup250"><code class="language-typescript text-sm text-gray-800">} 
      });
      return false;
    }
    
    try {
      dispatch({ type: 'SET_LOADING', payload: true });
      
      // Call API to transition the booking state
      const response = await fetch(`/api/scheduling/bookings/${state.bookingId}/transition`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          event: BookingEventEnum.SCHEDULE_EVENT</code></pre></div><div class="py-4"><p class="text-gray-600">hooks/scheduling/use-booking-flow.ts (Line 432:7 - Line 451:21), hooks/scheduling/use-booking-flow.ts (Line 158:8 - Line 112:29)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn251" onclick="toggleCodeBlock('cloneGroup251', 'expandBtn251', 'collapseBtn251')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn251" onclick="toggleCodeBlock('cloneGroup251', 'expandBtn251', 'collapseBtn251')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup251"><code class="language-typescript text-sm text-gray-800">?: string) =&gt; {
    if (!state.bookingId) {
      dispatch({ 
        type: 'SET_ERROR', 
        payload: { message: 'Missing booking ID' } 
      });
      return false;
    }
    
    try {
      dispatch({ type: 'SET_LOADING', payload: true });
      
      // Call API to transition the booking state
      const response = await fetch(`/api/scheduling/bookings/${state.bookingId}/transition`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          event: BookingEventEnum.REQUEST_CANCELLATION</code></pre></div><div class="py-4"><p class="text-gray-600">docs/middleware-mock-investigation/typed-mock-test.ts (Line 38:23 - Line 46:30), docs/middleware-mock-investigation/typed-mock-test.ts (Line 29:19 - Line 37:59)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn252" onclick="toggleCodeBlock('cloneGroup252', 'expandBtn252', 'collapseBtn252')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn252" onclick="toggleCodeBlock('cloneGroup252', 'expandBtn252', 'collapseBtn252')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup252"><code class="language-typescript text-sm text-gray-800">((options) =&gt; {
      return async (req) =&gt; ({ redirect: true });
    });
    
    const handler = approach1({ publicRoutes: ['/'] });
    expect(typeof handler).toBe('function');
  });
  
  it('should work with Approach 2'</code></pre></div><div class="py-4"><p class="text-gray-600">docs/middleware-mock-investigation/typed-mock-test.ts (Line 56:23 - Line 64:30), docs/middleware-mock-investigation/typed-mock-test.ts (Line 47:19 - Line 55:59)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn253" onclick="toggleCodeBlock('cloneGroup253', 'expandBtn253', 'collapseBtn253')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn253" onclick="toggleCodeBlock('cloneGroup253', 'expandBtn253', 'collapseBtn253')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup253"><code class="language-typescript text-sm text-gray-800">((options) =&gt; {
      return async (req) =&gt; ({ redirect: true });
    });
    
    const handler = approach2({ publicRoutes: ['/'] });
    expect(typeof handler).toBe('function');
  });
  
  it('should work with Approach 3'</code></pre></div><div class="py-4"><p class="text-gray-600">docs/middleware-mock-investigation/typed-mock-test.ts (Line 74:23 - Line 81:2), docs/middleware-mock-investigation/typed-mock-test.ts (Line 65:19 - Line 73:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn254" onclick="toggleCodeBlock('cloneGroup254', 'expandBtn254', 'collapseBtn254')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn254" onclick="toggleCodeBlock('cloneGroup254', 'expandBtn254', 'collapseBtn254')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup254"><code class="language-typescript text-sm text-gray-800">((options) =&gt; {
      return async (req) =&gt; ({ redirect: true });
    });
    
    const handler = approach3({ publicRoutes: ['/'] });
    expect(typeof handler).toBe('function');
  });
}</code></pre></div><div class="py-4"><p class="text-gray-600">docs/middleware-mock-investigation/improved-test-utils.ts (Line 9:1 - Line 58:4), lib/middleware/test-utils.ts (Line 36:1 - Line 83:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn255" onclick="toggleCodeBlock('cloneGroup255', 'expandBtn255', 'collapseBtn255')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn255" onclick="toggleCodeBlock('cloneGroup255', 'expandBtn255', 'collapseBtn255')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup255"><code class="language-typescript text-sm text-gray-800">// Auth state types
export type MockAuthState = {
  userId: string | null;
  isPublicRoute: boolean;
};

/**
 * Create a mock request with consistent headers and structure
 * @param pathname URL pathname
 * @param method HTTP method
 * @param headers Additional headers
 * @returns Mocked NextRequest instance
 */
export function createMockRequest(
  pathname = '/',
  method = 'GET',
  headers: Record&lt;string, string&gt; = {}
): NextRequest {
  const url = new URL(pathname, 'http://localhost');
  const req = new Request(url, { method });
  const nextReq = new NextRequest(req);
  
  // Add headers
  Object.entries(headers).forEach(([key, value]) =&gt; {
    nextReq.headers.set(key, value);
  });
  
  return nextReq;
}

/**
 * Create a mock auth state for testing
 * @param userId User ID or null for unauthenticated
 * @param isPublicRoute Whether the route is public
 * @returns Mock auth state object
 */
export function createMockAuthState(
  userId: string | null = null,
  isPublicRoute: boolean = false
): MockAuthState {
  return { userId, isPublicRoute };
}

/**
 * Configure a mock authMiddleware function for specific auth states
 * This function properly handles type safety for the mock method chaining
 * 
 * @param mockFn The mock function to configure
 * @param authState Authentication state to mock
 */</code></pre></div><div class="py-4"><p class="text-gray-600">docs/middleware-mock-investigation/improved-test-utils.ts (Line 52:1 - Line 79:4), lib/middleware/test-utils.ts (Line 14:1 - Line 36:20)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn256" onclick="toggleCodeBlock('cloneGroup256', 'expandBtn256', 'collapseBtn256')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn256" onclick="toggleCodeBlock('cloneGroup256', 'expandBtn256', 'collapseBtn256')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup256"><code class="language-typescript text-sm text-gray-800">/**
 * Configure a mock authMiddleware function for specific auth states
 * This function properly handles type safety for the mock method chaining
 * 
 * @param mockFn The mock function to configure
 * @param authState Authentication state to mock
 */
export function configureMockAuth&lt;Args extends any[], Return&gt;(
  mockFn: MockInstance&lt;Args, Return&gt;,
  authState: MockAuthState
): void {
  mockFn.mockImplementationOnce((options: any) =&gt; {
    return async (req: NextRequest) =&gt; {
      return options.afterAuth(
        authState,
        req,
        { nextUrl: req.nextUrl }
      );
    };
  });
}

/**
 * Mock NextResponse.json with proper status handling
 * @param body Response body
 * @param options Response options
 * @returns Mocked JSON response with status property
 */</code></pre></div><div class="py-4"><p class="text-gray-600">docs/middleware-mock-investigation/improved-test-utils.ts (Line 63:2 - Line 83:2), lib/middleware/test-utils.ts (Line 85:2 - Line 105:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn257" onclick="toggleCodeBlock('cloneGroup257', 'expandBtn257', 'collapseBtn257')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn257" onclick="toggleCodeBlock('cloneGroup257', 'expandBtn257', 'collapseBtn257')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup257"><code class="language-typescript text-sm text-gray-800">=&gt; {
    return async (req: NextRequest) =&gt; {
      return options.afterAuth(
        authState,
        req,
        { nextUrl: req.nextUrl }
      );
    };
  });
}

/**
 * Mock NextResponse.json with proper status handling
 * @param body Response body
 * @param options Response options
 * @returns Mocked JSON response with status property
 */
export function mockJsonResponse(
  body: Record&lt;string, any&gt;,
  options: { status?: number } = {}
):</code></pre></div><div class="py-4"><p class="text-gray-600">docs/middleware-mock-investigation/improved-test-utils.ts (Line 83:2 - Line 159:2), lib/middleware/test-utils.ts (Line 105:2 - Line 181:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn258" onclick="toggleCodeBlock('cloneGroup258', 'expandBtn258', 'collapseBtn258')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn258" onclick="toggleCodeBlock('cloneGroup258', 'expandBtn258', 'collapseBtn258')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup258"><code class="language-typescript text-sm text-gray-800">{
  const status = options.status || 200;
  const headers = new Headers();
  
  const response = {
    status,
    statusText: getStatusText(status),
    headers,
    json: async () =&gt; body,
    text: async () =&gt; JSON.stringify(body),
    clone: () =&gt; ({ ...response }),
  } as unknown as NextResponse;
  
  return response;
}

/**
 * Get status text for HTTP status code
 * @param status HTTP status code
 * @returns Status text
 */
function getStatusText(status: number): string {
  const statusMap: Record&lt;number, string&gt; = {
    200: 'OK',
    201: 'Created',
    204: 'No Content',
    301: 'Moved Permanently',
    302: 'Found',
    307: 'Temporary Redirect',
    308: 'Permanent Redirect',
    400: 'Bad Request',
    401: 'Unauthorized',
    403: 'Forbidden',
    404: 'Not Found',
    405: 'Method Not Allowed',
    409: 'Conflict',
    422: 'Unprocessable Entity',
    429: 'Too Many Requests',
    500: 'Internal Server Error',
    503: 'Service Unavailable'
  };
  
  return statusMap[status] || 'Unknown';
}

/**
 * Create a consistent mock for the redirectToSignIn function
 * @returns Mocked implementation function
 */
export function mockRedirectToSignIn() {
  return vi.fn(() =&gt; {
    const response = NextResponse.redirect(new URL('/sign-in', 'http://localhost'));
    // Ensure the status is 307 for Next.js 15.3.1 compatibility
    Object.defineProperty(response, 'status', { value: 307 });
    return response;
  });
}

/**
 * Set up common middleware mocks used across multiple test files
 * @returns Object containing mocked dependencies
 */
export function setupMiddlewareMocks() {
  // Mock CSRF protection
  const csrfMock = vi.fn().mockResolvedValue(null);
  
  // Mock rate limiting
  const rateLimitMock = vi.fn().mockImplementation(() =&gt; {
    return async () =&gt; NextResponse.next();
  });
  
  // Return all mocks for use in tests
  return {
    csrfProtection: csrfMock,
    rateLimit: rateLimitMock,
  };
}</code></pre></div><div class="py-4"><p class="text-gray-600">docs/middleware-mock-investigation/improved-solution.ts (Line 6:2 - Line 38:59), docs/middleware-mock-investigation/nextjs-mock-solution.ts (Line 10:2 - Line 42:40)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn259" onclick="toggleCodeBlock('cloneGroup259', 'expandBtn259', 'collapseBtn259')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn259" onclick="toggleCodeBlock('cloneGroup259', 'expandBtn259', 'collapseBtn259')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup259"><code class="language-typescript text-sm text-gray-800">} from 'vitest';
import { NextRequest, NextResponse } from 'next/server';

/**
 * Default unauthorized state used when no specific state is provided
 */
const DEFAULT_AUTH_STATE = {
  userId: null,
  isPublicRoute: false
};

// Type definitions matching Clerk's API
type AuthMiddlewareOptions = {
  publicRoutes?: (string | RegExp)[];
  ignoredRoutes?: (string | RegExp)[];
  afterAuth: (
    auth: { userId: string | null; isPublicRoute: boolean },
    req: NextRequest,
    evt: { nextUrl: URL }
  ) =&gt; NextResponse | Promise&lt;NextResponse&gt; | null | undefined | void;
};

type AuthMiddlewareFunction = (
  options: AuthMiddlewareOptions
) =&gt; (
  req: NextRequest
) =&gt; Promise&lt;NextResponse | null | undefined | void&gt;;

type RedirectToSignInFunction = (
  options?: { returnBackUrl?: string }
) =&gt; NextResponse;

// Create properly typed mock functions using MockInstance</code></pre></div><div class="py-4"><p class="text-gray-600">docs/middleware-mock-investigation/improved-solution.ts (Line 47:2 - Line 94:2), docs/middleware-mock-investigation/nextjs-mock-solution.ts (Line 44:3 - Line 90:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn260" onclick="toggleCodeBlock('cloneGroup260', 'expandBtn260', 'collapseBtn260')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn260" onclick="toggleCodeBlock('cloneGroup260', 'expandBtn260', 'collapseBtn260')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup260"><code class="language-typescript text-sm text-gray-800">;

export const SignedIn = vi.fn();
export const SignedOut = vi.fn();
export const useAuth = vi.fn();
export const useUser = vi.fn();
export const ClerkProvider = vi.fn();

// Set the default implementation for authMiddleware
authMiddleware.mockImplementation((options: AuthMiddlewareOptions) =&gt; {
  return async (req: NextRequest) =&gt; {
    // Default implementation - should be overridden in specific tests
    // Get auth state from headers for backward compatibility with existing tests
    const userId = req.headers.get('x-auth-user-id');
    const isPublicRouteHeader = req.headers.get('x-is-public-route');
    const isPublicRoute = isPublicRouteHeader === 'true' || 
      (options.publicRoutes &amp;&amp; Array.isArray(options.publicRoutes) &amp;&amp; 
        options.publicRoutes.some((route: string | RegExp) =&gt; {
          if (typeof route === 'string') {
            return req.nextUrl.pathname.startsWith(route);
          }
          return route.test(req.nextUrl.pathname);
        }));
    
    // Build auth state from headers or use default
    const authState = userId || isPublicRouteHeader
      ? { userId, isPublicRoute }
      : DEFAULT_AUTH_STATE;
    
    // Call the afterAuth handler with the auth state
    return options.afterAuth(
      authState,
      req,
      { nextUrl: req.nextUrl }
    );
  };
});

// Set the default implementation for redirectToSignIn
redirectToSignIn.mockImplementation((options) =&gt; {
  const redirectUrl = new URL('/sign-in', options?.returnBackUrl || 'http://localhost');
  const response = NextResponse.redirect(redirectUrl);
  
  // Ensure the status is 307 for Next.js 15.3.1 compatibility
  Object.defineProperty(response, 'status', { value: 307 });
  
  return response;
});</code></pre></div><div class="py-4"><p class="text-gray-600">docs/middleware-mock-investigation/factory-test-solution.ts (Line 118:58 - Line 129:33), docs/middleware-mock-investigation/factory-test-solution.ts (Line 90:54 - Line 101:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn261" onclick="toggleCodeBlock('cloneGroup261', 'expandBtn261', 'collapseBtn261')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn261" onclick="toggleCodeBlock('cloneGroup261', 'expandBtn261', 'collapseBtn261')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup261"><code class="language-typescript text-sm text-gray-800">, async () =&gt; {
    const config = createMockConfig();
    
    // Configure auth middleware with unauthorized state
    const unauthorizedState = createMockAuthState(null, false);
    typedAuthMiddleware.mockImplementationOnce((options: any) =&gt; {
      return async (req: NextRequest) =&gt; {
        return options.afterAuth(unauthorizedState, req, { nextUrl: req.nextUrl });
      };
    });
    
    // Create mock redirect response</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/utils/express-auth-test-utils.ts (Line 137:7 - Line 143:40), lib/auth/express/server-auth.ts (Line 180:5 - Line 186:66)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn322" onclick="toggleCodeBlock('cloneGroup322', 'expandBtn322', 'collapseBtn322')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn322" onclick="toggleCodeBlock('cloneGroup322', 'expandBtn322', 'collapseBtn322')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup322"><code class="language-typescript text-sm text-gray-800">const rolePermissions: Record&lt;string, string[]&gt; = {
        [UserRole.ADMIN]: ['*'], // Admin has all permissions
        [UserRole.BUILDER]: ['profile:edit', 'builder:manage'],
        [UserRole.CLIENT]: ['profile:view', 'booking:create'],
      };
      
      // Check if any role has the permission</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/utils/express-auth-test-utils.ts (Line 162:2 - Line 172:23), __tests__/utils/express-auth-test-utils.ts (Line 104:2 - Line 114:25)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn323" onclick="toggleCodeBlock('cloneGroup323', 'expandBtn323', 'collapseBtn323')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn323" onclick="toggleCodeBlock('cloneGroup323', 'expandBtn323', 'collapseBtn323')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup323"><code class="language-typescript text-sm text-gray-800">{
  const mockUser = mockUsers[userType];
  
  // Get user ID and create session ID
  const userId = mockUser.id;
  const sessionId = `sess_${userId.substring(5)}`;
  
  // Get roles from the mock user or custom roles
  const roles = customRoles || (mockUser.publicMetadata?.roles as UserRole[] || []);
  
  // Return auth headers</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/utils/express-auth-test-utils.ts (Line 331:9 - Line 342:2), __tests__/utils/express-auth-test-utils.ts (Line 139:9 - Line 158:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn324" onclick="toggleCodeBlock('cloneGroup324', 'expandBtn324', 'collapseBtn324')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn324" onclick="toggleCodeBlock('cloneGroup324', 'expandBtn324', 'collapseBtn324')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup324"><code class="language-typescript text-sm text-gray-800">[UserRole.BUILDER]: ['profile:edit', 'builder:manage'],
        [UserRole.CLIENT]: ['profile:view', 'booking:create'],
      };
      
      // Check if any role has the permission
      return roles.some(role =&gt; {
        const permissions = rolePermissions[role] || [];
        return permissions.includes('*') || permissions.includes(permission);
      });
    }),
  };
})</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/utils/db-test-utils.ts (Line 25:15 - Line 34:8), __tests__/utils/db-test-utils.ts (Line 16:5 - Line 25:15)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn325" onclick="toggleCodeBlock('cloneGroup325', 'expandBtn325', 'collapseBtn325')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn325" onclick="toggleCodeBlock('cloneGroup325', 'expandBtn325', 'collapseBtn325')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup325"><code class="language-typescript text-sm text-gray-800">: {
      findUnique: vi.fn(),
      findFirst: vi.fn(),
      findMany: vi.fn(),
      create: vi.fn(),
      update: vi.fn(),
      delete: vi.fn(),
      count: vi.fn(),
    },
    booking</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/utils/db-test-utils.ts (Line 34:8 - Line 43:12), __tests__/utils/db-test-utils.ts (Line 16:5 - Line 25:15)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn326" onclick="toggleCodeBlock('cloneGroup326', 'expandBtn326', 'collapseBtn326')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn326" onclick="toggleCodeBlock('cloneGroup326', 'expandBtn326', 'collapseBtn326')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup326"><code class="language-typescript text-sm text-gray-800">: {
      findUnique: vi.fn(),
      findFirst: vi.fn(),
      findMany: vi.fn(),
      create: vi.fn(),
      update: vi.fn(),
      delete: vi.fn(),
      count: vi.fn(),
    },
    sessionType</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/utils/db-test-utils.ts (Line 43:12 - Line 52:13), __tests__/utils/db-test-utils.ts (Line 16:5 - Line 25:15)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn327" onclick="toggleCodeBlock('cloneGroup327', 'expandBtn327', 'collapseBtn327')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn327" onclick="toggleCodeBlock('cloneGroup327', 'expandBtn327', 'collapseBtn327')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup327"><code class="language-typescript text-sm text-gray-800">: {
      findUnique: vi.fn(),
      findFirst: vi.fn(),
      findMany: vi.fn(),
      create: vi.fn(),
      update: vi.fn(),
      delete: vi.fn(),
      count: vi.fn(),
    },
    $transaction</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/utils/auth-test-utils.ts (Line 170:2 - Line 179:37), __tests__/utils/auth-test-utils.ts (Line 145:2 - Line 154:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn328" onclick="toggleCodeBlock('cloneGroup328', 'expandBtn328', 'collapseBtn328')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn328" onclick="toggleCodeBlock('cloneGroup328', 'expandBtn328', 'collapseBtn328')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup328"><code class="language-typescript text-sm text-gray-800">,
      imageUrl: mockUser.avatar || 'https://img.clerk.com/default-avatar.png',
      publicMetadata: {
        roles,
        verified: mockUser.verified,
        ...overrides.metadata,
      },
      createdAt: new Date(Date.now() - 1000 * 60 * 60 * 24 * 30).toISOString(),
      updatedAt: new Date().toISOString(),
      // Add full profile fields if needed</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/utils/auth-test-utils.ts (Line 234:12 - Line 243:9), __tests__/utils/auth-test-utils.ts (Line 159:18 - Line 168:8)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn329" onclick="toggleCodeBlock('cloneGroup329', 'expandBtn329', 'collapseBtn329')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn329" onclick="toggleCodeBlock('cloneGroup329', 'expandBtn329', 'collapseBtn329')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup329"><code class="language-typescript text-sm text-gray-800">,
    user: mockUser ? {
      id: clerkId,
      firstName: mockUser.name.split(' ')[0],
      lastName: mockUser.name.split(' ')[1] || '',
      fullName: mockUser.name,
      primaryEmailAddress: {
        emailAddress: mockUser.email,
        id: `email_${clerkId?.substring(5, 15)}`,
        verified</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/utils/api-test-utils.ts (Line 90:20 - Line 120:6), __tests__/utils/api-test-utils.ts (Line 41:19 - Line 71:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn330" onclick="toggleCodeBlock('cloneGroup330', 'expandBtn330', 'collapseBtn330')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn330" onclick="toggleCodeBlock('cloneGroup330', 'expandBtn330', 'collapseBtn330')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup330"><code class="language-typescript text-sm text-gray-800">${path} → ${status}`);
        return HttpResponse.json(responseData, {
          status,
          headers: options.headers || {},
        });
      });
    }

    mockServer.use(handler);

    return {
      path,
      responseData,
      status,
      options,
      cleanup: () =&gt; {
        activeMocks.delete(mockId);
        mockServer.resetHandlers();
        mockServer.use(...handlers); // Restore default handlers
      }
    };
  },

  /**
   * Mock a PUT request to a specific endpoint
   *
   * @param path The API path to mock
   * @param responseData The data to return
   * @param status HTTP status code (default: 200)
   * @param options Additional options (delay, network error, etc.)
   */</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/utils/api-test-utils.ts (Line 139:19 - Line 169:6), __tests__/utils/api-test-utils.ts (Line 41:19 - Line 71:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn331" onclick="toggleCodeBlock('cloneGroup331', 'expandBtn331', 'collapseBtn331')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn331" onclick="toggleCodeBlock('cloneGroup331', 'expandBtn331', 'collapseBtn331')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup331"><code class="language-typescript text-sm text-gray-800">${path} → ${status}`);
        return HttpResponse.json(responseData, {
          status,
          headers: options.headers || {},
        });
      });
    }

    mockServer.use(handler);

    return {
      path,
      responseData,
      status,
      options,
      cleanup: () =&gt; {
        activeMocks.delete(mockId);
        mockServer.resetHandlers();
        mockServer.use(...handlers); // Restore default handlers
      }
    };
  },

  /**
   * Mock a DELETE request to a specific endpoint
   *
   * @param path The API path to mock
   * @param responseData The data to return (default: { success: true })
   * @param status HTTP status code (default: 200)
   * @param options Additional options (delay, network error, etc.)
   */</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/utils/api-test-utils.ts (Line 188:22 - Line 219:6), __tests__/utils/api-test-utils.ts (Line 41:19 - Line 71:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn332" onclick="toggleCodeBlock('cloneGroup332', 'expandBtn332', 'collapseBtn332')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn332" onclick="toggleCodeBlock('cloneGroup332', 'expandBtn332', 'collapseBtn332')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup332"><code class="language-typescript text-sm text-gray-800">${path} → ${status}`);
        return HttpResponse.json(responseData, {
          status,
          headers: options.headers || {},
        });
      });
    }

    mockServer.use(handler);

    return {
      path,
      responseData,
      status,
      options,
      cleanup: () =&gt; {
        activeMocks.delete(mockId);
        mockServer.resetHandlers();
        mockServer.use(...handlers); // Restore default handlers
      }
    };
  },

  /**
   * Mock an error response for any method
   *
   * @param path The API path to mock
   * @param method The HTTP method to mock
   * @param errorMessage Error message to return
   * @param status HTTP status code (default: 400)
   * @param options Additional options (delay, etc.)
   */</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/utils/api-test-utils.ts (Line 519:13 - Line 540:6), __tests__/utils/api-test-utils.ts (Line 470:6 - Line 492:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn333" onclick="toggleCodeBlock('cloneGroup333', 'expandBtn333', 'collapseBtn333')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn333" onclick="toggleCodeBlock('cloneGroup333', 'expandBtn333', 'collapseBtn333')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup333"><code class="language-typescript text-sm text-gray-800">: error.message
      });

      // Try to include response body in error message if possible
      try {
        const clonedResponse = response.clone();
        const text = await clonedResponse.text();
        console.error(`[API Expect] Response body:`, text);
      } catch (e) {
        console.error(`[API Expect] Could not read response body`);
      }

      throw error;
    }
  },

  /**
   * Test if a fetch response has validation errors
   *
   * @param response Fetch response object
   * @param fieldNames Names of fields expected to have validation errors
   */</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/utils/api-test-utils.ts (Line 559:11 - Line 581:6), __tests__/utils/api-test-utils.ts (Line 518:14 - Line 492:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn334" onclick="toggleCodeBlock('cloneGroup334', 'expandBtn334', 'collapseBtn334')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn334" onclick="toggleCodeBlock('cloneGroup334', 'expandBtn334', 'collapseBtn334')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup334"><code class="language-typescript text-sm text-gray-800">,
        errorMessage: error.message
      });

      // Try to include response body in error message if possible
      try {
        const clonedResponse = response.clone();
        const text = await clonedResponse.text();
        console.error(`[API Expect] Response body:`, text);
      } catch (e) {
        console.error(`[API Expect] Could not read response body`);
      }

      throw error;
    }
  },

  /**
   * Test if a fetch response matches a custom condition
   *
   * @param response Fetch response object
   * @param assertFn Function to perform custom assertions
   */</code></pre></div><div class="py-4"><p class="text-gray-600">tests-examples/demo-todo-app.spec.ts (Line 149:47 - Line 159:6), tests-examples/demo-todo-app.spec.ts (Line 124:44 - Line 134:21)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn335" onclick="toggleCodeBlock('cloneGroup335', 'expandBtn335', 'collapseBtn335')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn335" onclick="toggleCodeBlock('cloneGroup335', 'expandBtn335', 'collapseBtn335')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup335"><code class="language-typescript text-sm text-gray-800">, async ({ page }) =&gt; {
    // create a new todo locator
    const newTodo = page.getByPlaceholder('What needs to be done?');

    // Create two items.
    for (const item of TODO_ITEMS.slice(0, 2)) {
      await newTodo.fill(item);
      await newTodo.press('Enter');
    }

    const</code></pre></div><div class="py-4"><p class="text-gray-600">tests-examples/demo-todo-app.spec.ts (Line 352:33 - Line 358:5), tests-examples/demo-todo-app.spec.ts (Line 342:42 - Line 347:5)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn336" onclick="toggleCodeBlock('cloneGroup336', 'expandBtn336', 'collapseBtn336')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn336" onclick="toggleCodeBlock('cloneGroup336', 'expandBtn336', 'collapseBtn336')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup336"><code class="language-typescript text-sm text-gray-800">, async ({ page }) =&gt; {
    const todoItem = page.getByTestId('todo-item'); 
    await page.getByTestId('todo-item').nth(1).getByRole('checkbox').check();

    await checkNumberOfCompletedTodosInLocalStorage(page, 1);

    await test</code></pre></div><div class="py-4"><p class="text-gray-600">lib/json-utilities.ts (Line 17:1 - Line 49:44), lib/prisma-types.ts (Line 63:1 - Line 95:32)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn337" onclick="toggleCodeBlock('cloneGroup337', 'expandBtn337', 'collapseBtn337')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn337" onclick="toggleCodeBlock('cloneGroup337', 'expandBtn337', 'collapseBtn337')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup337"><code class="language-typescript text-sm text-gray-800">/**
 * Convert SocialLinks to a Prisma-compatible JSON value
 */
export function socialLinksToJson(links?: SocialLinks): Prisma.InputJsonValue | undefined {
  if (!links) return undefined;
  return links as unknown as Prisma.InputJsonValue;
}

/**
 * Convert PortfolioItem[] to a Prisma-compatible JSON array
 */
export function portfolioItemsToJson(items?: PortfolioItem[]): Prisma.InputJsonValue[] | undefined {
  if (!items) return undefined;
  return items as unknown as Prisma.InputJsonValue[];
}

/**
 * Get SocialLinks from a BuilderProfile
 */
export function getSocialLinks(profile: { socialLinks?: Prisma.JsonValue | null }): SocialLinks | undefined {
  if (!profile.socialLinks) return undefined;
  return profile.socialLinks as unknown as SocialLinks;
}

/**
 * Get PortfolioItems from a BuilderProfile
 */
export function getPortfolioItems(profile: { portfolioItems?: Prisma.JsonValue[] }): PortfolioItem[] | undefined {
  if (!profile.portfolioItems || !Array.isArray(profile.portfolioItems)) return undefined;
  return profile.portfolioItems as unknown as PortfolioItem[];
}

// Re-export the types from prisma-types.ts</code></pre></div><div class="py-4"><p class="text-gray-600">lib/enhanced-logger.ts (Line 10:11 - Line 23:47), lib/logger.ts (Line 20:2 - Line 33:57)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn338" onclick="toggleCodeBlock('cloneGroup338', 'expandBtn338', 'collapseBtn338')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn338" onclick="toggleCodeBlock('cloneGroup338', 'expandBtn338', 'collapseBtn338')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup338"><code class="language-typescript text-sm text-gray-800">;

// Define common types
export type LogLevel = 'debug' | 'info' | 'warn' | 'error';

export interface LogMetadata {
  [key: string]: any;
}

export interface LogFunction {
  (message: string, metadata?: LogMetadata, error?: Error): void;
}

// Determine if we're in a browser environment</code></pre></div><div class="py-4"><p class="text-gray-600">lib/enhanced-logger.server.ts (Line 93:5 - Line 106:6), lib/logger.ts (Line 198:5 - Line 211:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn339" onclick="toggleCodeBlock('cloneGroup339', 'expandBtn339', 'collapseBtn339')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn339" onclick="toggleCodeBlock('cloneGroup339', 'expandBtn339', 'collapseBtn339')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup339"><code class="language-typescript text-sm text-gray-800">// Console logging based on level
    switch (level) {
      case 'debug':
        console.debug(JSON.stringify(logObject));
        break;
      case 'info':
        console.info(JSON.stringify(logObject));
        break;
      case 'warn':
        console.warn(JSON.stringify(logObject));
        break;
      case 'error':
        console.error(JSON.stringify(logObject));
        break</code></pre></div><div class="py-4"><p class="text-gray-600">lib/enhanced-logger.client.ts (Line 31:1 - Line 67:6), lib/enhanced-logger.server.ts (Line 31:1 - Line 67:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn340" onclick="toggleCodeBlock('cloneGroup340', 'expandBtn340', 'collapseBtn340')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn340" onclick="toggleCodeBlock('cloneGroup340', 'expandBtn340', 'collapseBtn340')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup340"><code class="language-typescript text-sm text-gray-800">export class EnhancedLogger {
  /**
   * Log a debug message
   * @param message The message to log
   * @param metadata Optional metadata to include
   * @param error Optional error object
   */
  debug: LogFunction = (message, metadata = {}, error) =&gt; {
    this.log('debug', message, metadata, error);
  };

  /**
   * Log an informational message
   * @param message The message to log
   * @param metadata Optional metadata to include
   * @param error Optional error object
   */
  info: LogFunction = (message, metadata = {}, error) =&gt; {
    this.log('info', message, metadata, error);
  };

  /**
   * Log a warning message
   * @param message The message to log
   * @param metadata Optional metadata to include
   * @param error Optional error object
   */
  warn: LogFunction = (message, metadata = {}, error) =&gt; {
    this.log('warn', message, metadata, error);
  };

  /**
   * Log an error message with Sentry integration
   * @param message The message to log
   * @param metadata Optional metadata to include
   * @param error Optional error object
   */</code></pre></div><div class="py-4"><p class="text-gray-600">lib/enhanced-logger.client.ts (Line 68:3 - Line 112:56), lib/enhanced-logger.server.ts (Line 68:3 - Line 112:19)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn341" onclick="toggleCodeBlock('cloneGroup341', 'expandBtn341', 'collapseBtn341')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn341" onclick="toggleCodeBlock('cloneGroup341', 'expandBtn341', 'collapseBtn341')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup341"><code class="language-typescript text-sm text-gray-800">error: LogFunction = (message, metadata = {}, error) =&gt; {
    this.log('error', message, metadata, error);
  };

  /**
   * Internal logging implementation
   * @param level The log level
   * @param message The message to log
   * @param metadata Optional metadata to include
   * @param error Optional error object
   */
  private log(level: LogLevel, message: string, metadata: LogMetadata, error?: Error) {
    const timestamp = new Date().toISOString();
    const logObject = {
      timestamp,
      level,
      message,
      ...metadata,
    };

    // Send to Sentry for errors and warnings
    if (level === 'error' || level === 'warn') {
      this.sendToSentry(level, message, metadata, error);
    }

    // Console logging based on level
    switch (level) {
      case 'debug':
        console.debug(JSON.stringify(logObject));
        break;
      case 'info':
        console.info(JSON.stringify(logObject));
        break;
      case 'warn':
        console.warn(JSON.stringify(logObject));
        break;
      case 'error':
        console.error(JSON.stringify(logObject));
        break;
      default:
        console.log(JSON.stringify(logObject));
    }

    // Datadog logging temporarily disabled
    // this.sendToDatadog(level, message, metadata, error);</code></pre></div><div class="py-4"><p class="text-gray-600">lib/enhanced-logger.client.ts (Line 113:3 - Line 135:9), lib/enhanced-logger.server.ts (Line 115:3 - Line 137:9)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn342" onclick="toggleCodeBlock('cloneGroup342', 'expandBtn342', 'collapseBtn342')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn342" onclick="toggleCodeBlock('cloneGroup342', 'expandBtn342', 'collapseBtn342')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup342"><code class="language-typescript text-sm text-gray-800">}

  /**
   * Send log data to Sentry
   */
  private sendToSentry(level: LogLevel, message: string, metadata: LogMetadata, error?: Error) {
    try {
      if (error) {
        // Map log level to error severity
        const severity = level === 'error'
          ? ErrorSeverity.HIGH
          : ErrorSeverity.MEDIUM;

        // Map log level to error category
        const category = level === 'error'
          ? ErrorCategory.SYSTEM
          : ErrorCategory.SYSTEM;

        // Create a partial error metadata object
        const errorMetadata: Partial&lt;ErrorMetadata&gt; = {
          severity,
          category,
          source: 'client'</code></pre></div><div class="py-4"><p class="text-gray-600">lib/enhanced-logger.client.ts (Line 135:9 - Line 143:66), lib/enhanced-logger.server.ts (Line 137:9 - Line 145:49)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn343" onclick="toggleCodeBlock('cloneGroup343', 'expandBtn343', 'collapseBtn343')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn343" onclick="toggleCodeBlock('cloneGroup343', 'expandBtn343', 'collapseBtn343')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup343"><code class="language-typescript text-sm text-gray-800">,
          component: metadata.component || 'logger',
          userImpact: metadata.userImpact || 'minimal',
          affectedFeature: metadata.affectedFeature || 'unknown',
          isRecoverable: metadata.isRecoverable !== undefined ? metadata.isRecoverable : true,
          retryable: metadata.retryable !== undefined ? metadata.retryable : false,
        };

        // Use the error handling function from the classification system</code></pre></div><div class="py-4"><p class="text-gray-600">lib/enhanced-logger.client.ts (Line 143:9 - Line 156:46), lib/enhanced-logger.server.ts (Line 161:9 - Line 174:49)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn344" onclick="toggleCodeBlock('cloneGroup344', 'expandBtn344', 'collapseBtn344')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn344" onclick="toggleCodeBlock('cloneGroup344', 'expandBtn344', 'collapseBtn344')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup344"><code class="language-typescript text-sm text-gray-800">// Use the error handling function from the classification system
        handleError(error, message, errorMetadata);
      } else {
        // Log message as event with metadata
        Sentry.withScope((scope) =&gt; {
          // Add metadata as extra context
          Object.entries(metadata).forEach(([key, value]) =&gt; {
            scope.setExtra(key, value);
          });

          // Add log level as tag
          scope.setTag('log_level', level);

          // Capture message with safe severity mapping</code></pre></div><div class="py-4"><p class="text-gray-600">lib/enhanced-logger.client.ts (Line 156:11 - Line 182:6), lib/enhanced-logger.server.ts (Line 190:11 - Line 216:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn345" onclick="toggleCodeBlock('cloneGroup345', 'expandBtn345', 'collapseBtn345')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn345" onclick="toggleCodeBlock('cloneGroup345', 'expandBtn345', 'collapseBtn345')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup345"><code class="language-typescript text-sm text-gray-800">// Capture message with safe severity mapping
          const severityMap = {
            'error': 'error',
            'warn': 'warning',
            'info': 'info',
            'debug': 'debug'
          };

          // Use safer approach to set severity
          Sentry.captureMessage(
            message,
            {
              level: severityMap[level] || 'info'
            }
          );
        });
      }
    } catch (sentryError) {
      // Fallback if Sentry logging fails
      console.error('Failed to send to Sentry:', sentryError);
    }
  }

  /**
   * Send log data to Datadog (client-side)
   * NOTE: Temporarily disabled to resolve build issues
   */</code></pre></div><div class="py-4"><p class="text-gray-600">lib/enhanced-logger.client.ts (Line 183:3 - Line 236:2), lib/enhanced-logger.server.ts (Line 217:3 - Line 270:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn346" onclick="toggleCodeBlock('cloneGroup346', 'expandBtn346', 'collapseBtn346')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn346" onclick="toggleCodeBlock('cloneGroup346', 'expandBtn346', 'collapseBtn346')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup346"><code class="language-typescript text-sm text-gray-800">private sendToDatadog(level: LogLevel, message: string, metadata: LogMetadata, error?: Error) {
    // Temporarily disabled
    // Implementation will be restored once build issues are resolved
  }

  /**
   * Log error with code-specific metadata
   * Specialized method for handling coded errors
   */
  logError(code: string, message: string, metadata: LogMetadata = {}, error?: Error) {
    this.error(message, {
      ...metadata,
      error_code: code,
      // Include stack if available and we're not in production
      stack: error?.stack &amp;&amp; process.env.NODE_ENV !== 'production' ? error.stack : undefined,
    }, error);
  }

  /**
   * Log and track exceptions (convenience method)
   */
  exception(error: Error, message?: string, metadata: LogMetadata = {}) {
    this.error(message || error.message, {
      ...metadata,
      name: error.name,
    }, error);
  }

  /**
   * Create a child logger with preset context
   * @param context Context to be added to all log entries
   */
  child(context: LogMetadata) {
    const childLogger = new EnhancedLogger();

    // Override log methods to include context
    childLogger.log = (level, message, metadata, error) =&gt; {
      this.log(level, message, { ...context, ...metadata }, error);
    };

    return childLogger;
  }
}

// Export singleton instance for app-wide usage
export const enhancedLogger = new EnhancedLogger();

// Export utility for domain-specific loggers
export function createDomainLogger(domain: string, defaultMetadata: LogMetadata = {}) {
  return enhancedLogger.child({
    domain,
    ...defaultMetadata,
  });
}</code></pre></div><div class="py-4"><p class="text-gray-600">lib/db-utils.ts (Line 304:7 - Line 314:7), lib/db-utils.ts (Line 223:2 - Line 233:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn347" onclick="toggleCodeBlock('cloneGroup347', 'expandBtn347', 'collapseBtn347')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn347" onclick="toggleCodeBlock('cloneGroup347', 'expandBtn347', 'collapseBtn347')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup347"><code class="language-typescript text-sm text-gray-800">,
  where: Record&lt;string, any&gt;
): Promise&lt;T&gt; {
  const modelAny = (db as any)[model];
  
  if (!modelAny) {
    throw new Error(`Model '${model}' does not exist on the Prisma client`);
  }

  return withDatabaseOperation(
    () =&gt; modelAny.delete</code></pre></div><div class="py-4"><p class="text-gray-600">vitest.setup.ts (Line 42:6 - Line 53:29), __tests__/utils/vitest-utils.ts (Line 71:8 - Line 81:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn350" onclick="toggleCodeBlock('cloneGroup350', 'expandBtn350', 'collapseBtn350')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn350" onclick="toggleCodeBlock('cloneGroup350', 'expandBtn350', 'collapseBtn350')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup350"><code class="language-typescript text-sm text-gray-800">,
    media: query,
    onchange: null,
    addListener: vi.fn(),
    removeListener: vi.fn(),
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn(),
  })),
});

// Mock IntersectionObserver</code></pre></div><div class="py-4"><p class="text-gray-600">playwright.simple.config.ts (Line 7:18 - Line 14:43), playwright.visual.config.ts (Line 5:25 - Line 12:46)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn353" onclick="toggleCodeBlock('cloneGroup353', 'expandBtn353', 'collapseBtn353')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn353" onclick="toggleCodeBlock('cloneGroup353', 'expandBtn353', 'collapseBtn353')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup353"><code class="language-typescript text-sm text-gray-800">,
  timeout: 30000,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: [
    ['html'],
    ['json', { outputFile: 'test-results/e2e/playwright-results.json'</code></pre></div><div class="py-4"><p class="text-gray-600">playwright.project.config.ts (Line 8:7 - Line 20:12), playwright.simple.config.ts (Line 4:19 - Line 16:48)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn354" onclick="toggleCodeBlock('cloneGroup354', 'expandBtn354', 'collapseBtn354')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn354" onclick="toggleCodeBlock('cloneGroup354', 'expandBtn354', 'collapseBtn354')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup354"><code class="language-typescript text-sm text-gray-800">;

export default defineConfig({
  testDir: './__tests__/e2e',
  timeout: 30000,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: [
    ['html'],
    ['json', { outputFile: 'test-results/e2e/playwright-results.json' }],
  ],
  globalSetup</code></pre></div><div class="py-4"><p class="text-gray-600">playwright.project.config.ts (Line 28:5 - Line 49:45), playwright.visual.config.ts (Line 30:5 - Line 50:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn355" onclick="toggleCodeBlock('cloneGroup355', 'expandBtn355', 'collapseBtn355')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn355" onclick="toggleCodeBlock('cloneGroup355', 'expandBtn355', 'collapseBtn355')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup355"><code class="language-typescript text-sm text-gray-800">{
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'mobile-chrome',
      use: { ...devices['Pixel 5'] },
    },
    {
      name: 'mobile-safari',
      use: { ...devices['iPhone 12'] },
    },
    
    // Role-specific authenticated test projects</code></pre></div><div class="py-4"><p class="text-gray-600">playwright.config.ts (Line 2:1 - Line 21:36), playwright.project.config.ts (Line 8:1 - Line 27:48)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn356" onclick="toggleCodeBlock('cloneGroup356', 'expandBtn356', 'collapseBtn356')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn356" onclick="toggleCodeBlock('cloneGroup356', 'expandBtn356', 'collapseBtn356')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup356"><code class="language-typescript text-sm text-gray-800">import path from 'path';

export default defineConfig({
  testDir: './__tests__/e2e',
  timeout: 30000,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: [
    ['html'],
    ['json', { outputFile: 'test-results/e2e/playwright-results.json' }],
  ],
  globalSetup: require.resolve('./__tests__/e2e/global-setup'),
  use: {
    baseURL: process.env.PLAYWRIGHT_TEST_BASE_URL || 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    // Setup project for authentication</code></pre></div><!-- Add more clone groups for .txt format as needed         // Add more clone groups for .txt format as needed--></div><a name="javascript-clones"></a><h2 class="text-2xl font-semibold text-gray-700 mb-4">javascript</h2><div class="divide-y divide-gray-200 border-b-2"><div class="py-4"><p class="text-gray-600">lib/auth/clerk/remove-nextauth-deps.js (Line 61:16 - Line 68:16), lib/auth/clerk/remove-nextauth-deps.js (Line 41:13 - Line 48:13)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn148" onclick="toggleCodeBlock('cloneGroup148', 'expandBtn148', 'collapseBtn148')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn148" onclick="toggleCodeBlock('cloneGroup148', 'expandBtn148', 'collapseBtn148')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup148"><code class="language-javascript text-sm text-gray-800">) {
        for (const nextAuthDep of NEXTAUTH_DEPS) {
          if (nextAuthDep.endsWith('*')) {
            const prefix = nextAuthDep.replace('*', '');
            if (dep.startsWith(prefix)) {
              hasNextAuthDeps = true;
              removedDeps.push(dep);
              delete packageJson.devDependencies</code></pre></div><div class="py-4"><p class="text-gray-600">components/marketing/ui/marketing-stat.tsx (Line 86:11 - Line 102:41), components/marketing/ui/marketing-stat.tsx (Line 59:9 - Line 71:45)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn157" onclick="toggleCodeBlock('cloneGroup157', 'expandBtn157', 'collapseBtn157')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn157" onclick="toggleCodeBlock('cloneGroup157', 'expandBtn157', 'collapseBtn157')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup157"><code class="language-javascript text-sm text-gray-800">)}
        initial={withAnimation ? { opacity: 0, y: 20 } : undefined}
        animate={withAnimation ? { opacity: 1, y: 0 } : undefined}
        transition={{ duration: 0.4 }}
      &gt;
        &lt;p className=&quot;text-sm font-medium text-muted-foreground&quot;&gt;{label}&lt;/p&gt;
        &lt;p className=&quot;text-xl font-semibold&quot;&gt;
          {prefix}{formattedValue}{suffix}
        &lt;/p&gt;
      &lt;/Component&gt;
    );
  }

  // Default variant
  return (
    &lt;Component
      className={cn(&quot;flex flex-col items-center text-center&quot;</code></pre></div><div class="py-4"><p class="text-gray-600">components/marketing/ui/marketing-stat.tsx (Line 102:41 - Line 113:2), components/marketing/ui/marketing-stat.tsx (Line 86:16 - Line 71:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn158" onclick="toggleCodeBlock('cloneGroup158', 'expandBtn158', 'collapseBtn158')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn158" onclick="toggleCodeBlock('cloneGroup158', 'expandBtn158', 'collapseBtn158')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup158"><code class="language-javascript text-sm text-gray-800">, className)}
      initial={withAnimation ? { opacity: 0, y: 20 } : undefined}
      animate={withAnimation ? { opacity: 1, y: 0 } : undefined}
      transition={{ duration: 0.4 }}
    &gt;
      &lt;h3 className=&quot;text-3xl md:text-5xl font-bold mb-2&quot;&gt;
        {prefix}{formattedValue}{suffix}
      &lt;/h3&gt;
      &lt;p className=&quot;text-lg font-medium mb-1&quot;&gt;{label}&lt;/p&gt;
      {description &amp;&amp; &lt;p className=&quot;text-sm text-muted-foreground&quot;&gt;{description}&lt;/p&gt;}
      {trend &amp;&amp; (
        &lt;div className={cn(&quot;flex items-center mt-2 text-sm font-medium&quot;, trendStyles)}</code></pre></div><div class="py-4"><p class="text-gray-600">components/community/ui/discussion-card.tsx (Line 119:2 - Line 161:2), components/community/ui/server-discussion-card.tsx (Line 91:2 - Line 134:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn163" onclick="toggleCodeBlock('cloneGroup163', 'expandBtn163', 'collapseBtn163')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn163" onclick="toggleCodeBlock('cloneGroup163', 'expandBtn163', 'collapseBtn163')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup163"><code class="language-javascript text-sm text-gray-800">}&gt;
                {discussion.title}
              &lt;/CardTitle&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/CardHeader&gt;

        &lt;CardContent className={cn(
          isCompact ? &quot;pb-3&quot; : &quot;pb-4&quot;
        )}&gt;
          {!isCompact &amp;&amp; (
            &lt;p className=&quot;text-muted-foreground text-sm mb-3 line-clamp-2&quot;&gt;
              {discussion.excerpt}
            &lt;/p&gt;
          )}
          
          &lt;div className=&quot;flex flex-wrap gap-2 mt-2&quot;&gt;
            {discussion.topics.map(topic =&gt; (
              &lt;Badge 
                key={topic.id} 
                variant=&quot;secondary&quot;
                className={cn(
                  &quot;text-xs&quot;,
                  topic.color &amp;&amp; `bg-${topic.color}-100 text-${topic.color}-800`
                )}
              &gt;
                {topic.name}
              &lt;/Badge&gt;
            ))}
          &lt;/div&gt;
        &lt;/CardContent&gt;

        &lt;CardFooter className={cn(
          &quot;flex justify-between pt-0&quot;,
          isCompact ? &quot;text-xs&quot; : &quot;text-sm&quot;
        )}&gt;
          &lt;div className=&quot;flex items-center gap-2&quot;&gt;
            &lt;Avatar 
              src={discussion.author.avatarUrl} 
              alt={discussion.author.name}
              className={cn(
                isCompact ? &quot;h-5 w-5&quot; : &quot;h-6 w-6&quot;
              )}</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/components/error-boundaries/api-error-boundary.test.tsx (Line 171:2 - Line 249:2), __tests__/components/error-boundaries/api-error-boundary.test.tsx (Line 167:15 - Line 225:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn197" onclick="toggleCodeBlock('cloneGroup197', 'expandBtn197', 'collapseBtn197')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn197" onclick="toggleCodeBlock('cloneGroup197', 'expandBtn197', 'collapseBtn197')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup197"><code class="language-javascript text-sm text-gray-800">}&gt;Trigger Error&lt;/button&gt;
            &lt;span&gt;No Error&lt;/span&gt;
          &lt;/div&gt;
        )}
      &lt;/ApiErrorBoundary&gt;
    );
    
    // Trigger error
    fireEvent.click(screen.getByText('Trigger Error'));
    
    // Check custom fallback is rendered
    expect(screen.getByTestId('custom-fallback')).toBeInTheDocument();
    expect(screen.getByText('Custom Error: API error')).toBeInTheDocument();
    
    // Reset from custom fallback
    fireEvent.click(screen.getByText('Custom Reset'));
    
    // Check we're back to normal state
    expect(screen.getByText('No Error')).toBeInTheDocument();
  });
  
  it('renders default error UI when no fallback is provided and an error occurs', () =&gt; {
    render(
      &lt;ApiErrorBoundary apiName=&quot;UserData&quot;&gt;
        {({ setError }) =&gt; (
          &lt;div&gt;
            &lt;button onClick={() =&gt; setError(new Error('API error'))}&gt;Trigger Error&lt;/button&gt;
            &lt;span&gt;No Error&lt;/span&gt;
          &lt;/div&gt;
        )}
      &lt;/ApiErrorBoundary&gt;
    );
    
    // Trigger error
    fireEvent.click(screen.getByText('Trigger Error'));
    
    // Check default error UI is rendered
    expect(screen.getByText('Problem loading data')).toBeInTheDocument();
    expect(screen.getByText(/We encountered an error while fetching data from UserData/)).toBeInTheDocument();
    
    // Check buttons are rendered
    expect(screen.getByText('Retry')).toBeInTheDocument();
    expect(screen.getByText('Report Issue')).toBeInTheDocument();
    
    // Check error details are shown in development mode
    // This assumes NODE_ENV !== 'production'
    expect(screen.getByText('Error: API error')).toBeInTheDocument();
  });
  
  it('shows Sentry report dialog when feedback button is clicked', () =&gt; {
    render(
      &lt;ApiErrorBoundary apiName=&quot;UserData&quot;&gt;
        {({ setError }) =&gt; (
          &lt;div&gt;
            &lt;button onClick={() =&gt; setError(new Error('API error'))}&gt;Trigger Error&lt;/button&gt;
            &lt;span&gt;No Error&lt;/span&gt;
          &lt;/div&gt;
        )}
      &lt;/ApiErrorBoundary&gt;
    );
    
    // Trigger error
    fireEvent.click(screen.getByText('Trigger Error'));
    
    // Click the feedback button
    fireEvent.click(screen.getByText('Report Issue'));
    
    // Check Sentry.showReportDialog was called
    expect(Sentry.showReportDialog).toHaveBeenCalledWith({
      eventId: 'mock-event-id',
    });
  });
  
  it('adds API tags to Sentry scope', () =&gt; {
    render(
      &lt;ApiErrorBoundary apiName=&quot;UserData&quot;&gt;
        {({ setError }) =&gt; (
          &lt;div&gt;
            &lt;button onClick={() =&gt; setError(new Error('API error'))}</code></pre></div><div class="py-4"><p class="text-gray-600">components/profile/portfolio-showcase.tsx (Line 92:8 - Line 103:17), components/profile/portfolio-showcase.tsx (Line 83:3 - Line 88:8)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn264" onclick="toggleCodeBlock('cloneGroup264', 'expandBtn264', 'collapseBtn264')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn264" onclick="toggleCodeBlock('cloneGroup264', 'expandBtn264', 'collapseBtn264')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup264"><code class="language-javascript text-sm text-gray-800">} /&gt;
          &lt;/motion.div&gt;
        ))}
        
        {/* Add project card for owners */}
        {isOwner &amp;&amp; (
          &lt;motion.div
            initial={shouldReduceMotion ? { opacity: 0 } : { opacity: 0, y: 20 }}
            animate={shouldReduceMotion ? { opacity: 1 } : { opacity: 1, y: 0 }}
            transition={{ 
              duration: 0.4, 
              delay: shouldReduceMotion ? 0 : displayProjects</code></pre></div><div class="py-4"><p class="text-gray-600">components/profile/portfolio-gallery.tsx (Line 127:5 - Line 137:25), components/profile/portfolio-showcase.tsx (Line 79:11 - Line 87:23)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn265" onclick="toggleCodeBlock('cloneGroup265', 'expandBtn265', 'collapseBtn265')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn265" onclick="toggleCodeBlock('cloneGroup265', 'expandBtn265', 'collapseBtn265')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup265"><code class="language-javascript text-sm text-gray-800">)}&gt;View All Projects&lt;/Button&gt;
        &lt;/div&gt;
      ) : gridView ? (
        &lt;div className=&quot;grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6&quot;&gt;
          {filteredProjects.map((project, index) =&gt; (
            &lt;motion.div
              key={project.id}
              initial={shouldReduceMotion ? { opacity: 0 } : { opacity: 0, y: 20 }}
              animate={shouldReduceMotion ? { opacity: 1 } : { opacity: 1, y: 0 }}
              transition={{ 
                duration</code></pre></div><div class="py-4"><p class="text-gray-600">components/profile/portfolio-gallery.tsx (Line 148:11 - Line 180:2), components/profile/portfolio-showcase.tsx (Line 79:2 - Line 157:8)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn266" onclick="toggleCodeBlock('cloneGroup266', 'expandBtn266', 'collapseBtn266')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn266" onclick="toggleCodeBlock('cloneGroup266', 'expandBtn266', 'collapseBtn266')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup266"><code class="language-javascript text-sm text-gray-800">}
              /&gt;
            &lt;/motion.div&gt;
          ))}
        &lt;/div&gt;
      ) : (
        &lt;div className=&quot;space-y-6&quot;&gt;
          {filteredProjects.map((project, index) =&gt; (
            &lt;motion.div
              key={project.id}
              initial={shouldReduceMotion ? { opacity: 0 } : { opacity: 0, y: 20 }}
              animate={shouldReduceMotion ? { opacity: 1 } : { opacity: 1, y: 0 }}
              transition={{ 
                duration: 0.4, 
                delay: shouldReduceMotion ? 0 : index * 0.1,
                ease: &quot;easeOut&quot; 
              }}
            &gt;
              &lt;ProjectListItem 
                project={project}
                validationTier={validationTier}
                onClick={() =&gt; setSelectedProject(project)}
                isOwner={isOwner}
                onEdit={onEdit ? () =&gt; onEdit(project.id) : undefined}
                onDelete={onDelete ? () =&gt; onDelete(project.id) : undefined}
              /&gt;
            &lt;/motion.div&gt;
          ))}
        &lt;/div&gt;
      )}
      
      {/* Project Detail Dialog */}
      &lt;Dialog open={!</code></pre></div><div class="py-4"><p class="text-gray-600">components/profile/app-showcase.tsx (Line 87:4 - Line 96:4), components/profile/portfolio-showcase.tsx (Line 83:8 - Line 92:8)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn272" onclick="toggleCodeBlock('cloneGroup272', 'expandBtn272', 'collapseBtn272')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn272" onclick="toggleCodeBlock('cloneGroup272', 'expandBtn272', 'collapseBtn272')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup272"><code class="language-javascript text-sm text-gray-800">.id}
            initial={shouldReduceMotion ? { opacity: 0 } : { opacity: 0, y: 20 }}
            animate={shouldReduceMotion ? { opacity: 1 } : { opacity: 1, y: 0 }}
            transition={{ 
              duration: 0.4, 
              delay: shouldReduceMotion ? 0 : index * 0.1,
              ease: &quot;easeOut&quot; 
            }}
          &gt;
            &lt;AppCard app={app</code></pre></div><div class="py-4"><p class="text-gray-600">components/profile/app-showcase.tsx (Line 96:4 - Line 107:13), components/profile/portfolio-showcase.tsx (Line 83:3 - Line 88:8)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn273" onclick="toggleCodeBlock('cloneGroup273', 'expandBtn273', 'collapseBtn273')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn273" onclick="toggleCodeBlock('cloneGroup273', 'expandBtn273', 'collapseBtn273')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup273"><code class="language-javascript text-sm text-gray-800">} /&gt;
          &lt;/motion.div&gt;
        ))}
        
        {/* Add app card for owners */}
        {isOwner &amp;&amp; onAddApp &amp;&amp; (
          &lt;motion.div
            initial={shouldReduceMotion ? { opacity: 0 } : { opacity: 0, y: 20 }}
            animate={shouldReduceMotion ? { opacity: 1 } : { opacity: 1, y: 0 }}
            transition={{ 
              duration: 0.4, 
              delay: shouldReduceMotion ? 0 : displayApps</code></pre></div><div class="py-4"><p class="text-gray-600">components/platform/platform-header.tsx (Line 346:20 - Line 384:16), components/platform/platform-header.tsx (Line 276:20 - Line 310:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn276" onclick="toggleCodeBlock('cloneGroup276', 'expandBtn276', 'collapseBtn276')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn276" onclick="toggleCodeBlock('cloneGroup276', 'expandBtn276', 'collapseBtn276')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup276"><code class="language-javascript text-sm text-gray-800">? &quot;rotate-180&quot; : &quot;&quot;)} /&gt;
              &lt;/button&gt;
              &lt;AnimatePresence&gt;
                {aboutDropdownOpen &amp;&amp; (
                  &lt;motion.div
                    initial={shouldReduceMotion ? { opacity: 1, y: 0 } : { opacity: 0, y: -10 }}
                    animate={shouldReduceMotion ? { opacity: 1, y: 0 } : { opacity: 1, y: 0 }}
                    exit={shouldReduceMotion ? { opacity: 0, y: 0 } : { opacity: 0, y: -10 }}
                    transition={{ duration: 0.15 }}
                    className=&quot;absolute left-0 mt-1 w-64 rounded-md bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-lg overflow-hidden z-50&quot;
                  &gt;
                    &lt;div className=&quot;py-1&quot;&gt;
                      {navigationItems.aboutItems.map((item) =&gt; (
                        &lt;Link
                          key={item.id}
                          href={item.href}
                          className={cn(
                            &quot;block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800&quot;,
                            pathname === item.href ? &quot;bg-slate-100 dark:bg-slate-800&quot; : &quot;&quot;
                          )}
                        &gt;
                          &lt;div className=&quot;font-medium&quot;&gt;{item.label}&lt;/div&gt;
                          &lt;div className=&quot;text-xs text-slate-500 dark:text-slate-400&quot;&gt;{item.description}&lt;/div&gt;
                        &lt;/Link&gt;
                      ))}
                    &lt;/div&gt;
                  &lt;/motion.div&gt;
                )}
              &lt;/AnimatePresence&gt;
            &lt;/div&gt;
          &lt;/nav&gt;

          {/* ViewingPreferences and Auth buttons grouped together */}
          &lt;div className=&quot;ml-auto flex h-full items-center gap-2&quot;&gt;
            {/* ViewingPreferences integrated directly into header */}
            &lt;ViewingPreferences className=&quot;hidden md:block&quot; /&gt;
            
            {isAuthenticated ? (
              &lt;div ref={userDropdownRef</code></pre></div><div class="py-4"><p class="text-gray-600">components/platform/platform-header.tsx (Line 401:19 - Line 422:31), components/platform/platform-header.tsx (Line 276:20 - Line 293:29)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn277" onclick="toggleCodeBlock('cloneGroup277', 'expandBtn277', 'collapseBtn277')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn277" onclick="toggleCodeBlock('cloneGroup277', 'expandBtn277', 'collapseBtn277')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup277"><code class="language-javascript text-sm text-gray-800">? &quot;rotate-180&quot; : &quot;&quot;)} /&gt;
                &lt;/button&gt;
                &lt;AnimatePresence&gt;
                  {userDropdownOpen &amp;&amp; (
                    &lt;motion.div
                      initial={shouldReduceMotion ? { opacity: 1, y: 0 } : { opacity: 0, y: -10 }}
                      animate={shouldReduceMotion ? { opacity: 1, y: 0 } : { opacity: 1, y: 0 }}
                      exit={shouldReduceMotion ? { opacity: 0, y: 0 } : { opacity: 0, y: -10 }}
                      transition={{ duration: 0.15 }}
                      className=&quot;absolute right-0 mt-1 w-64 rounded-md bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-lg overflow-hidden z-50&quot;
                    &gt;
                      &lt;div className=&quot;px-4 py-3 border-b border-slate-200 dark:border-slate-700&quot;&gt;
                        &lt;p className=&quot;text-sm font-medium&quot;&gt;{user?.name || &quot;User&quot;}&lt;/p&gt;
                        &lt;p className=&quot;text-xs text-slate-500 dark:text-slate-400 truncate&quot;&gt;{user?.email}&lt;/p&gt;
                      &lt;/div&gt;
                      &lt;div className=&quot;py-1&quot;&gt;
                        {userMenuItems.map((item) =&gt; (
                          &lt;Link
                            key={item.id}
                            href={item.href}
                            className={cn(
                              </code></pre></div><div class="py-4"><p class="text-gray-600">components/platform/platform-header.tsx (Line 600:14 - Line 641:88), components/platform/platform-header.tsx (Line 502:2 - Line 542:14)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn278" onclick="toggleCodeBlock('cloneGroup278', 'expandBtn278', 'collapseBtn278')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn278" onclick="toggleCodeBlock('cloneGroup278', 'expandBtn278', 'collapseBtn278')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup278"><code class="language-javascript text-sm text-gray-800">}
                  className=&quot;border-b border-slate-200 dark:border-slate-700 last:border-none&quot;
                &gt;
                  &lt;div className=&quot;p-4&quot;&gt;
                    &lt;ViewingPreferences variant=&quot;minimal&quot; /&gt;
                  &lt;/div&gt;
                &lt;/motion.li&gt;
              &lt;/motion.ul&gt;
            &lt;/div&gt;
            
            {/* I would like to... Section */}
            &lt;div className=&quot;mb-6&quot;&gt;
              &lt;h2 className=&quot;text-sm font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 px-2&quot;&gt;I would like to...&lt;/h2&gt;
              &lt;motion.ul
                className={`flex flex-col ease-in rounded-lg overflow-hidden bg-slate-100/50 dark:bg-slate-800/50`}
                variants={containerVariants}
                initial=&quot;initial&quot;
                animate={hamburgerMenuIsOpen ? &quot;open&quot; : &quot;exit&quot;}
              &gt;
                {navigationItems.roleBasedItems.map((item) =&gt; (
                  &lt;motion.li
                    variants={mobileLinkVar}
                    key={item.id}
                    className=&quot;border-b border-slate-200 dark:border-slate-700 last:border-none&quot;
                  &gt;
                    &lt;Link
                      className={`hover:bg-slate-200 dark:hover:bg-slate-700 flex w-full flex-col p-4 transition-colors ${pathname === item.href ? &quot;bg-slate-200 dark:bg-slate-700&quot; : &quot;&quot;}`}
                      href={item.href}
                    &gt;
                      &lt;span className=&quot;font-medium&quot;&gt;{item.label}&lt;/span&gt;
                      &lt;span className=&quot;text-xs mt-1 text-slate-500 dark:text-slate-400&quot;&gt;{item.description}&lt;/span&gt;
                    &lt;/Link&gt;
                  &lt;/motion.li&gt;
                ))}
              &lt;/motion.ul&gt;
            &lt;/div&gt;
            
            {/* About Section */}
            &lt;div&gt;
              &lt;h2 className=&quot;text-sm font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 px-2&quot;&gt;About&lt;/h2&gt;
              &lt;motion.ul
                className={`flex flex-col ease-in rounded-lg overflow-hidden bg-slate-100/50 dark:bg-slate-800/50`</code></pre></div><div class="py-4"><p class="text-gray-600">components/platform/platform-header.tsx (Line 627:5 - Line 668:3), components/platform/platform-header.tsx (Line 502:2 - Line 542:14)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn279" onclick="toggleCodeBlock('cloneGroup279', 'expandBtn279', 'collapseBtn279')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn279" onclick="toggleCodeBlock('cloneGroup279', 'expandBtn279', 'collapseBtn279')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup279"><code class="language-javascript text-sm text-gray-800">}
                    &gt;
                      &lt;span className=&quot;font-medium&quot;&gt;{item.label}&lt;/span&gt;
                      &lt;span className=&quot;text-xs mt-1 text-slate-500 dark:text-slate-400&quot;&gt;{item.description}&lt;/span&gt;
                    &lt;/Link&gt;
                  &lt;/motion.li&gt;
                ))}
              &lt;/motion.ul&gt;
            &lt;/div&gt;
            
            {/* About Section */}
            &lt;div&gt;
              &lt;h2 className=&quot;text-sm font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 px-2&quot;&gt;About&lt;/h2&gt;
              &lt;motion.ul
                className={`flex flex-col ease-in rounded-lg overflow-hidden bg-slate-100/50 dark:bg-slate-800/50`}
                variants={containerVariants}
                initial=&quot;initial&quot;
                animate={hamburgerMenuIsOpen ? &quot;open&quot; : &quot;exit&quot;}
              &gt;
                {navigationItems.aboutItems.map((item) =&gt; (
                  &lt;motion.li
                    variants={mobileLinkVar}
                    key={item.id}
                    className=&quot;border-b border-slate-200 dark:border-slate-700 last:border-none&quot;
                  &gt;
                    &lt;Link
                      className={`hover:bg-slate-200 dark:hover:bg-slate-700 flex w-full flex-col p-4 transition-colors ${pathname === item.href ? &quot;bg-slate-200 dark:bg-slate-700&quot; : &quot;&quot;}`}
                      href={item.href}
                    &gt;
                      &lt;span className=&quot;font-medium&quot;&gt;{item.label}&lt;/span&gt;
                      &lt;span className=&quot;text-xs mt-1 text-slate-500 dark:text-slate-400&quot;&gt;{item.description}&lt;/span&gt;
                    &lt;/Link&gt;
                  &lt;/motion.li&gt;
                ))}
              &lt;/motion.ul&gt;
            &lt;/div&gt;
            
            {/* Login/Signup buttons for non-authenticated users */}
            {!isAuthenticated &amp;&amp; (
              &lt;div className=&quot;mt-6 flex flex-col space-y-4&quot;&gt;
                &lt;Link
                  className={cn</code></pre></div><div class="py-4"><p class="text-gray-600">components/marketplace/fixed-builder-image.tsx (Line 44:8 - Line 58:13), components/marketplace/components/builder-image/builder-image.tsx (Line 46:12 - Line 60:11)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn282" onclick="toggleCodeBlock('cloneGroup282', 'expandBtn282', 'collapseBtn282')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn282" onclick="toggleCodeBlock('cloneGroup282', 'expandBtn282', 'collapseBtn282')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup282"><code class="language-javascript text-sm text-gray-800">[size]} rounded-full border border-muted overflow-hidden bg-muted`,
      className
    )}&gt;
      {hasValidImageSrc ? (
        // Image with fallback rendering
        &lt;Image
          src={src as string}
          alt={alt}
          fill
          className=&quot;object-cover&quot;
          onError={(e) =&gt; {
            // On error, hide the image element
            const imgElement = e.currentTarget as HTMLImageElement;
            imgElement.style.display = 'none';
            </code></pre></div><div class="py-4"><p class="text-gray-600">components/landing/cta-section.tsx (Line 49:3 - Line 82:2), components/landing/skills-tree-section.tsx (Line 93:2 - Line 120:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn301" onclick="toggleCodeBlock('cloneGroup301', 'expandBtn301', 'collapseBtn301')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn301" onclick="toggleCodeBlock('cloneGroup301', 'expandBtn301', 'collapseBtn301')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup301"><code class="language-javascript text-sm text-gray-800">}
                      stroke=&quot;white&quot;
                      strokeWidth=&quot;2&quot;
                      strokeDasharray=&quot;20 20&quot;
                    /&gt;
                  ))}
                &lt;/g&gt;
              &lt;/svg&gt;
            &lt;/div&gt;

            &lt;div className=&quot;relative z-10 text-center max-w-3xl mx-auto&quot;&gt;
              &lt;motion.h2
                className=&quot;text-3xl md:text-5xl font-bold tracking-tight text-white mb-6&quot;
                initial={{ opacity: 0, y: 20 }}
                whileInView={{ opacity: 1, y: 0 }}
                viewport={{ once: true }}
                transition={{ duration: 0.5 }}
              &gt;
                {headline}
              &lt;/motion.h2&gt;

              &lt;motion.p
                className=&quot;text-lg md:text-xl text-white/80 mb-10&quot;
                initial={{ opacity: 0, y: 20 }}
                whileInView={{ opacity: 1, y: 0 }}
                viewport={{ once: true }}
                transition={{ duration: 0.5, delay: 0.1 }}
              &gt;
                {subheadline}
              &lt;/motion.p&gt;

              &lt;motion.div
                className=&quot;flex flex-col sm:flex-row gap-4 justify-center&quot;
                initial={{</code></pre></div><div class="py-4"><p class="text-gray-600">components/landing/cta-section.tsx (Line 75:4 - Line 85:4), components/landing/skills-tree-section.tsx (Line 102:4 - Line 111:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn302" onclick="toggleCodeBlock('cloneGroup302', 'expandBtn302', 'collapseBtn302')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn302" onclick="toggleCodeBlock('cloneGroup302', 'expandBtn302', 'collapseBtn302')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup302"><code class="language-javascript text-sm text-gray-800"> }}
              &gt;
                {subheadline}
              &lt;/motion.p&gt;

              &lt;motion.div
                className=&quot;flex flex-col sm:flex-row gap-4 justify-center&quot;
                initial={{ opacity: 0, y: 20 }}
                whileInView={{ opacity: 1, y: 0 }}
                viewport={{ once: true }}
                transition={{ duration: 0.5, delay: 0.2</code></pre></div><div class="py-4"><p class="text-gray-600">components/landing/ai-capabilities-marquee.tsx (Line 15:11 - Line 52:6), components/landing/skills-tree-section.tsx (Line 93:7 - Line 120:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn306" onclick="toggleCodeBlock('cloneGroup306', 'expandBtn306', 'collapseBtn306')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn306" onclick="toggleCodeBlock('cloneGroup306', 'expandBtn306', 'collapseBtn306')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup306"><code class="language-javascript text-sm text-gray-800">)}&gt;
      &lt;div className=&quot;container mx-auto px-4&quot;&gt;
        &lt;div className=&quot;text-center max-w-3xl mx-auto mb-12&quot;&gt;
          &lt;motion.h2 
            className=&quot;text-3xl md:text-4xl font-bold mb-4&quot;
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.5 }}
          &gt;
            AI can be a powerful companion
          &lt;/motion.h2&gt;
          &lt;motion.p 
            className=&quot;text-lg text-muted-foreground&quot;
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.5, delay: 0.1 }}
          &gt;
            You just need to know what and how to ask
          &lt;/motion.p&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div className=&quot;relative&quot;&gt;
        {/* &quot;What AI Can Do Today&quot; Marquee */}
        &lt;div className=&quot;mb-8&quot;&gt;
          &lt;div className=&quot;flex items-center justify-center mb-4&quot;&gt;
            &lt;div className=&quot;bg-green-100 dark:bg-green-950 text-green-700 dark:text-green-400 px-4 py-1 rounded-full text-sm font-medium inline-flex items-center&quot;&gt;
              &lt;span className=&quot;size-2 bg-green-500 rounded-full mr-2&quot;&gt;&lt;/span&gt;
              What AI Can Do Today
            &lt;/div&gt;
          &lt;/div&gt;
          
          &lt;Marquee 
            className=&quot;py-4&quot; 
            pauseOnHover 
            reverse={false</code></pre></div><div class="py-4"><p class="text-gray-600">components/landing/ai-capabilities-marquee.tsx (Line 86:6 - Line 106:4), components/landing/skills-tree-section.tsx (Line 102:2 - Line 111:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn307" onclick="toggleCodeBlock('cloneGroup307', 'expandBtn307', 'collapseBtn307')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn307" onclick="toggleCodeBlock('cloneGroup307', 'expandBtn307', 'collapseBtn307')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup307"><code class="language-javascript text-sm text-gray-800">}
                className=&quot;flex items-center bg-secondary/40 border border-primary/5 rounded-lg px-5 py-3 mx-3 min-w-52&quot;
              &gt;
                {limitation.icon &amp;&amp; (
                  &lt;div className=&quot;mr-3 text-primary&quot;&gt;
                    {limitation.icon}
                  &lt;/div&gt;
                )}
                &lt;span className=&quot;text-sm font-medium&quot;&gt;{limitation.title}&lt;/span&gt;
              &lt;/div&gt;
            ))}
          &lt;/Marquee&gt;
        &lt;/div&gt;

        {/* Connecting message */}
        &lt;motion.div 
          className=&quot;max-w-2xl mx-auto text-center mt-12 px-4&quot;
          initial={{ opacity: 0, y: 20 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true }}
          transition={{ duration: 0.5, delay: 0.3</code></pre></div><div class="py-4"><p class="text-gray-600">app/onboarding/page.tsx (Line 109:9 - Line 131:2), app/(platform)/profile/profile-settings/page.tsx (Line 114:9 - Line 136:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn312" onclick="toggleCodeBlock('cloneGroup312', 'expandBtn312', 'collapseBtn312')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn312" onclick="toggleCodeBlock('cloneGroup312', 'expandBtn312', 'collapseBtn312')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup312"><code class="language-javascript text-sm text-gray-800">={form.handleSubmit(onSubmit)} className=&quot;space-y-8&quot;&gt;
                &lt;FormField
                  control={form.control}
                  name=&quot;name&quot;
                  render={({ field }) =&gt; (
                    &lt;FormItem&gt;
                      &lt;FormLabel&gt;Name&lt;/FormLabel&gt;
                      &lt;FormControl&gt;
                        &lt;Input placeholder=&quot;Your name&quot; {...field} /&gt;
                      &lt;/FormControl&gt;
                      &lt;FormDescription&gt;
                        This is how you&amp;apos;ll appear on the platform.
                      &lt;/FormDescription&gt;
                      &lt;FormMessage /&gt;
                    &lt;/FormItem&gt;
                  )}
                /&gt;

                &lt;FormField
                  control={form.control}
                  name=&quot;role&quot;
                  render={({ field }) =&gt; (
                    &lt;FormItem </code></pre></div><div class="py-4"><p class="text-gray-600">vitest.config.js (Line 21:2 - Line 31:2), vitest.config.mjs (Line 21:2 - Line 31:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn351" onclick="toggleCodeBlock('cloneGroup351', 'expandBtn351', 'collapseBtn351')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn351" onclick="toggleCodeBlock('cloneGroup351', 'expandBtn351', 'collapseBtn351')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup351"><code class="language-javascript text-sm text-gray-800">,
    include: ['**/*.test.{ts,tsx}', '**/*.vitest.test.{ts,tsx}'],
    exclude: ['**/node_modules/**', '**/.next/**', '**/dist/**'],
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './'),
      'test-utils': path.resolve(__dirname, './__tests__/utils/vitest-utils'),
    },
  },
})</code></pre></div><div class="py-4"><p class="text-gray-600">test-page.js (Line 2:13 - Line 7:8), components/marketplace/components/error-boundaries/simple-marketplace-error-boundary.js (Line 35:2 - Line 40:31)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn352" onclick="toggleCodeBlock('cloneGroup352', 'expandBtn352', 'collapseBtn352')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn352" onclick="toggleCodeBlock('cloneGroup352', 'expandBtn352', 'collapseBtn352')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup352"><code class="language-javascript text-sm text-gray-800">;
var __importDefault = (this &amp;&amp; this.__importDefault) || function (mod) {
    return (mod &amp;&amp; mod.__esModule) ? mod : { &quot;default&quot;: mod };
};
Object.defineProperty(exports, &quot;__esModule&quot;, { value: true });
exports.default</code></pre></div><!-- Add more clone groups for .txt format as needed         // Add more clone groups for .txt format as needed--></div><a name="tsx-clones"></a><h2 class="text-2xl font-semibold text-gray-700 mb-4">tsx</h2><div class="divide-y divide-gray-200 border-b-2"><div class="py-4"><p class="text-gray-600">__tests__/unit/lib/auth/express/client-auth.test.tsx (Line 360:52 - Line 372:2), __tests__/unit/lib/auth/express/client-auth.test.tsx (Line 185:55 - Line 196:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn23" onclick="toggleCodeBlock('cloneGroup23', 'expandBtn23', 'collapseBtn23')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn23" onclick="toggleCodeBlock('cloneGroup23', 'expandBtn23', 'collapseBtn23')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup23"><code class="language-tsx text-sm text-gray-800">, async () =&gt; {
      const { useAuth: useClerkAuth } = require('@clerk/nextjs');
      const mockSignOut = vi.fn().mockResolvedValue({ ok: true });
      
      useClerkAuth.mockReturnValue({
        isLoaded: true,
        isSignedIn: true,
        userId: 'test-user-id',
        getToken: vi.fn().mockResolvedValue('header.eyJyb2xlcyI6WyJDTElFTlQiXX0=.signature'),
        signOut: mockSignOut,
      });
      
      const { result:</code></pre></div><div class="py-4"><p class="text-gray-600">components/scheduling/builder/availability/availability-exceptions.tsx (Line 225:9 - Line 242:34), components/scheduling/builder/availability/weekly-availability.tsx (Line 171:9 - Line 188:35)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn38" onclick="toggleCodeBlock('cloneGroup38', 'expandBtn38', 'collapseBtn38')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn38" onclick="toggleCodeBlock('cloneGroup38', 'expandBtn38', 'collapseBtn38')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup38"><code class="language-tsx text-sm text-gray-800">.
        &lt;/CardDescription&gt;
      &lt;/CardHeader&gt;
      
      &lt;CardContent&gt;
        {error &amp;&amp; (
          &lt;div className=&quot;mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-md&quot;&gt;
            {error}
          &lt;/div&gt;
        )}
        
        {isLoading &amp;&amp; !isAdding ? (
          &lt;div className=&quot;flex justify-center items-center p-8&quot;&gt;
            &lt;div className=&quot;animate-spin rounded-full h-8 w-8 border-b-2 border-primary&quot;&gt;&lt;/div&gt;
          &lt;/div&gt;
        ) : (
          &lt;div className=&quot;space-y-6&quot;&gt;
            {/* Display existing exceptions */</code></pre></div><div class="py-4"><p class="text-gray-600">components/scheduling/builder/availability/availability-exceptions.tsx (Line 411:8 - Line 418:8), components/scheduling/builder/availability/availability-exceptions.tsx (Line 394:10 - Line 401:10)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn39" onclick="toggleCodeBlock('cloneGroup39', 'expandBtn39', 'collapseBtn39')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn39" onclick="toggleCodeBlock('cloneGroup39', 'expandBtn39', 'collapseBtn39')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup39"><code class="language-tsx text-sm text-gray-800">), 'HH:mm')}
                            onChange={(e) =&gt; {
                              const [hours, minutes] = e.target.value.split(':').map(Number);
                              const date = new Date(newException.date);
                              date.setHours(hours, minutes, 0, 0);
                              setNewSlot(prev =&gt; ({
                                ...prev,
                                endTime</code></pre></div><div class="py-4"><p class="text-gray-600">components/scheduling/builder/availability/availability-exceptions.tsx (Line 452:21 - Line 479:10), components/scheduling/builder/availability/weekly-availability.tsx (Line 292:21 - Line 319:13)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn40" onclick="toggleCodeBlock('cloneGroup40', 'expandBtn40', 'collapseBtn40')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn40" onclick="toggleCodeBlock('cloneGroup40', 'expandBtn40', 'collapseBtn40')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup40"><code class="language-tsx text-sm text-gray-800">Cancel
                  &lt;/Button&gt;
                  &lt;Button
                    onClick={handleCreateException}
                    disabled={isLoading}
                  &gt;
                    {isLoading ? (
                      &lt;span className=&quot;flex items-center&quot;&gt;
                        &lt;div className=&quot;animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2&quot;&gt;&lt;/div&gt;
                        Creating...
                      &lt;/span&gt;
                    ) : (
                      &lt;span className=&quot;flex items-center&quot;&gt;
                        &lt;Save className=&quot;h-4 w-4 mr-2&quot; /&gt;
                        Save
                      &lt;/span&gt;
                    )}
                  &lt;/Button&gt;
                &lt;/div&gt;
              &lt;/div&gt;
            ) : (
              &lt;Button
                variant=&quot;outline&quot;
                className=&quot;w-full mt-4&quot;
                onClick={() =&gt; setIsAdding(true)}
              &gt;
                &lt;PlusCircle className=&quot;h-4 w-4 mr-2&quot; /&gt;
                Add Exception</code></pre></div><div class="py-4"><p class="text-gray-600">app/(platform)/profile/edit/page.tsx (Line 3:1 - Line 14:2), app/(platform)/profile/profile-settings/edit/page.tsx (Line 3:1 - Line 14:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn65" onclick="toggleCodeBlock('cloneGroup65', 'expandBtn65', 'collapseBtn65')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn65" onclick="toggleCodeBlock('cloneGroup65', 'expandBtn65', 'collapseBtn65')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup65"><code class="language-tsx text-sm text-gray-800">import ProfileEditPage from &quot;@/components/pages/profile-edit-page&quot;;
import { ProfileProvider } from &quot;@/lib/contexts/profile-context&quot;;
import { Toaster } from &quot;sonner&quot;;

export default function ProfileEditRoute() {
  return (
    &lt;ProfileProvider&gt;
      &lt;Toaster position=&quot;top-right&quot; /&gt;
      &lt;ProfileEditPage /&gt;
    &lt;/ProfileProvider&gt;
  );
}</code></pre></div><div class="py-4"><p class="text-gray-600">app/(platform)/admin/session-types/page.tsx (Line 277:2 - Line 293:2), app/(platform)/admin/session-types/page.tsx (Line 240:2 - Line 256:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn66" onclick="toggleCodeBlock('cloneGroup66', 'expandBtn66', 'collapseBtn66')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn66" onclick="toggleCodeBlock('cloneGroup66', 'expandBtn66', 'collapseBtn66')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup66"><code class="language-tsx text-sm text-gray-800">builder.
                    &lt;/DialogDescription&gt;
                  &lt;/DialogHeader&gt;
                  &lt;SessionTypeForm 
                    onSubmit={(data) =&gt; {
                      if (selectedBuilder) {
                        handleSessionTypeSubmit({
                          ...data,
                          builderId: selectedBuilder
                        }, false);
                      }
                    }}
                  /&gt;
                &lt;/DialogContent&gt;
              &lt;/Dialog&gt;
            &lt;/div&gt;
          )</code></pre></div><div class="py-4"><p class="text-gray-600">app/(auth)/sign-in/[[...sign-in]]/page.tsx (Line 15:11 - Line 55:7), app/(auth)/sign-up/[[...sign-up]]/page.tsx (Line 15:11 - Line 55:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn67" onclick="toggleCodeBlock('cloneGroup67', 'expandBtn67', 'collapseBtn67')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn67" onclick="toggleCodeBlock('cloneGroup67', 'expandBtn67', 'collapseBtn67')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup67"><code class="language-tsx text-sm text-gray-800">() {
  const { theme } = useTheme();
  const searchParams = useSearchParams();
  const [redirectUrl, setRedirectUrl] = useState&lt;string | undefined&gt;();
  
  useEffect(() =&gt; {
    // Check for various redirect parameters that might be set
    const redirect = searchParams?.get('redirect_url') || 
                    searchParams?.get('redirectUrl') ||
                    searchParams?.get('returnUrl') ||
                    searchParams?.get('return_url');
    
    setRedirectUrl(redirect || undefined);
  }, [searchParams]);

  // Clerk appearance customization
  const appearance = {
    baseTheme: theme === &quot;dark&quot; ? dark : undefined,
    elements: {
      formButtonPrimary:
        &quot;bg-primary hover:bg-primary/90 text-primary-foreground&quot;,
      card: &quot;bg-background border border-border shadow-sm&quot;,
      formButtonReset: &quot;text-muted-foreground hover:text-foreground&quot;,
      footerActionLink: &quot;text-primary hover:text-primary/90&quot;,
      headerTitle: &quot;text-foreground&quot;,
      headerSubtitle: &quot;text-muted-foreground&quot;,
      socialButtonsBlockButton:
        &quot;border border-border hover:bg-muted text-foreground&quot;,
      formFieldLabel: &quot;text-foreground&quot;,
      formFieldInput:
        &quot;bg-background border border-input text-foreground rounded-md&quot;,
      identityPreview: &quot;bg-muted-foreground/20&quot;,
      dividerLine: &quot;bg-border&quot;,
      dividerText: &quot;text-muted-foreground&quot;,
    },
  };

  // Pass redirectUrl if provided to ensure proper post-auth redirect
  return (
    &lt;div className=&quot;flex justify-center items-center min-h-screen&quot;&gt;
      &lt;SignIn</code></pre></div><div class="py-4"><p class="text-gray-600">components/scheduling/client/time-slot-selector.tsx (Line 101:10 - Line 115:20), components/scheduling/client/time-slot-selector.tsx (Line 82:8 - Line 96:22)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn150" onclick="toggleCodeBlock('cloneGroup150', 'expandBtn150', 'collapseBtn150')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn150" onclick="toggleCodeBlock('cloneGroup150', 'expandBtn150', 'collapseBtn150')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup150"><code class="language-tsx text-sm text-gray-800">).map((slot) =&gt; (
              &lt;Button
                key={slot.id}
                variant=&quot;outline&quot;
                className=&quot;justify-center&quot;
                onClick={() =&gt; onSelect(slot)}
              &gt;
                {format(parseISO(slot.startTime), 'h:mm a')}
              &lt;/Button&gt;
            ))}
          &lt;/div&gt;
        &lt;/div&gt;
      )}
      
      {/* Evening slots */</code></pre></div><div class="py-4"><p class="text-gray-600">components/scheduling/client/time-slot-selector.tsx (Line 120:8 - Line 133:3), components/scheduling/client/time-slot-selector.tsx (Line 82:8 - Line 96:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn151" onclick="toggleCodeBlock('cloneGroup151', 'expandBtn151', 'collapseBtn151')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn151" onclick="toggleCodeBlock('cloneGroup151', 'expandBtn151', 'collapseBtn151')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup151"><code class="language-tsx text-sm text-gray-800">).map((slot) =&gt; (
              &lt;Button
                key={slot.id}
                variant=&quot;outline&quot;
                className=&quot;justify-center&quot;
                onClick={() =&gt; onSelect(slot)}
              &gt;
                {format(parseISO(slot.startTime), 'h:mm a')}
              &lt;/Button&gt;
            ))}
          &lt;/div&gt;
        &lt;/div&gt;
      )}
    &lt;/</code></pre></div><div class="py-4"><p class="text-gray-600">components/scheduling/calendly/calendly-embed-optimized.tsx (Line 8:2 - Line 27:7), components/scheduling/calendly/calendly-embed.tsx (Line 8:2 - Line 27:10)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn152" onclick="toggleCodeBlock('cloneGroup152', 'expandBtn152', 'collapseBtn152')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn152" onclick="toggleCodeBlock('cloneGroup152', 'expandBtn152', 'collapseBtn152')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup152"><code class="language-tsx text-sm text-gray-800">{
  url: string;
  prefill?: {
    name?: string;
    email?: string;
    timezone?: string;
    customAnswers?: {
      a1?: string; // Booking ID
      pathway?: string; // Selected pathway
      [key: string]: string | undefined;
    };
  };
  utm?: {
    utmSource?: string;
    utmMedium?: string;
    utmCampaign?: string;
    utmContent?: string;
    utmTerm?: string;
  };
  height</code></pre></div><div class="py-4"><p class="text-gray-600">components/scheduling/calendly/calendly-calendar.tsx (Line 135:2 - Line 143:2), components/scheduling/client/time-slot-selector.tsx (Line 25:2 - Line 35:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn153" onclick="toggleCodeBlock('cloneGroup153', 'expandBtn153', 'collapseBtn153')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn153" onclick="toggleCodeBlock('cloneGroup153', 'expandBtn153', 'collapseBtn153')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup153"><code class="language-tsx text-sm text-gray-800">startTime.getHours();
      if (hour &lt; 12) {
        groups.morning.push(slot);
      } else if (hour &lt; 17) {
        groups.afternoon.push(slot);
      } else {
        groups.evening.push(slot);
      }
    }</code></pre></div><div class="py-4"><p class="text-gray-600">components/scheduling/calendly/calendly-calendar.tsx (Line 248:10 - Line 268:8), components/scheduling/calendly/calendly-calendar.tsx (Line 224:8 - Line 244:10)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn154" onclick="toggleCodeBlock('cloneGroup154', 'expandBtn154', 'collapseBtn154')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn154" onclick="toggleCodeBlock('cloneGroup154', 'expandBtn154', 'collapseBtn154')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup154"><code class="language-tsx text-sm text-gray-800">.map((slot, index) =&gt; (
                      &lt;Button
                        key={index}
                        variant=&quot;outline&quot;
                        size=&quot;sm&quot;
                        onClick={() =&gt; onSelectTimeSlot(slot)}
                        className=&quot;justify-between&quot;
                      &gt;
                        &lt;span&gt;{format(slot.startTime, 'h:mm a')}&lt;/span&gt;
                        {slot.inviteesRemaining &lt; 5 &amp;&amp; (
                          &lt;Badge variant=&quot;secondary&quot; className=&quot;ml-2&quot;&gt;
                            {slot.inviteesRemaining} left
                          &lt;/Badge&gt;
                        )}
                      &lt;/Button&gt;
                    ))}
                  &lt;/div&gt;
                &lt;/div&gt;
              )}

              {timeGroups.evening</code></pre></div><div class="py-4"><p class="text-gray-600">components/scheduling/calendly/calendly-calendar.tsx (Line 272:8 - Line 291:3), components/scheduling/calendly/calendly-calendar.tsx (Line 224:8 - Line 244:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn155" onclick="toggleCodeBlock('cloneGroup155', 'expandBtn155', 'collapseBtn155')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn155" onclick="toggleCodeBlock('cloneGroup155', 'expandBtn155', 'collapseBtn155')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup155"><code class="language-tsx text-sm text-gray-800">.map((slot, index) =&gt; (
                      &lt;Button
                        key={index}
                        variant=&quot;outline&quot;
                        size=&quot;sm&quot;
                        onClick={() =&gt; onSelectTimeSlot(slot)}
                        className=&quot;justify-between&quot;
                      &gt;
                        &lt;span&gt;{format(slot.startTime, 'h:mm a')}&lt;/span&gt;
                        {slot.inviteesRemaining &lt; 5 &amp;&amp; (
                          &lt;Badge variant=&quot;secondary&quot; className=&quot;ml-2&quot;&gt;
                            {slot.inviteesRemaining} left
                          &lt;/Badge&gt;
                        )}
                      &lt;/Button&gt;
                    ))}
                  &lt;/div&gt;
                &lt;/div&gt;
              )}
            &lt;/</code></pre></div><div class="py-4"><p class="text-gray-600">components/scheduling/builder/session-type-editor.tsx (Line 143:7 - Line 165:4), components/scheduling/builder/weekly-schedule.tsx (Line 120:7 - Line 142:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn156" onclick="toggleCodeBlock('cloneGroup156', 'expandBtn156', 'collapseBtn156')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn156" onclick="toggleCodeBlock('cloneGroup156', 'expandBtn156', 'collapseBtn156')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup156"><code class="language-tsx text-sm text-gray-800">]: false }));
    }
  };

  if (isLoading) {
    return (
      &lt;Card className=&quot;w-full&quot;&gt;
        &lt;CardContent className=&quot;p-6 flex justify-center&quot;&gt;
          &lt;div className=&quot;animate-pulse space-y-4 w-full&quot;&gt;
            &lt;div className=&quot;h-4 bg-muted rounded w-3/4&quot;&gt;&lt;/div&gt;
            &lt;div className=&quot;h-10 bg-muted rounded w-full&quot;&gt;&lt;/div&gt;
            &lt;div className=&quot;h-32 bg-muted rounded w-full&quot;&gt;&lt;/div&gt;
          &lt;/div&gt;
        &lt;/CardContent&gt;
      &lt;/Card&gt;
    );
  }

  return (
    &lt;Card className=&quot;w-full&quot;&gt;
      &lt;CardContent className=&quot;p-6&quot;&gt;
        &lt;div className=&quot;flex justify-between items-center mb-4&quot;&gt;
          &lt;div</code></pre></div><div class="py-4"><p class="text-gray-600">components/marketing/ui/marketing-stat.tsx (Line 112:7 - Line 120:3), components/marketing/ui/marketing-stat.tsx (Line 70:9 - Line 78:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn159" onclick="toggleCodeBlock('cloneGroup159', 'expandBtn159', 'collapseBtn159')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn159" onclick="toggleCodeBlock('cloneGroup159', 'expandBtn159', 'collapseBtn159')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup159"><code class="language-tsx text-sm text-gray-800">{trend &amp;&amp; (
        &lt;div className={cn(&quot;flex items-center mt-2 text-sm font-medium&quot;, trendStyles)}&gt;
          {trend.direction === &quot;up&quot; &amp;&amp; &quot;↑&quot;}
          {trend.direction === &quot;down&quot; &amp;&amp; &quot;↓&quot;}
          {trend.direction === &quot;neutral&quot; &amp;&amp; &quot;→&quot;}
          &lt;span className=&quot;ml-1&quot;&gt;{formattedTrend}&lt;/span&gt;
        &lt;/div&gt;
      )}
    &lt;/</code></pre></div><div class="py-4"><p class="text-gray-600">components/marketing/ui/feature-card.tsx (Line 108:21 - Line 113:3), components/marketing/ui/feature-card.tsx (Line 74:21 - Line 79:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn160" onclick="toggleCodeBlock('cloneGroup160', 'expandBtn160', 'collapseBtn160')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn160" onclick="toggleCodeBlock('cloneGroup160', 'expandBtn160', 'collapseBtn160')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup160"><code class="language-tsx text-sm text-gray-800">&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;
            &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot; strokeWidth={2} d=&quot;M5 13l4 4L19 7&quot; /&gt;
          &lt;/svg&gt;
        )}
      &lt;/div&gt;
      &lt;h3</code></pre></div><div class="py-4"><p class="text-gray-600">components/landing/ui/testimonial-scroll.tsx (Line 19:5 - Line 39:2), components/marketing/ui/testimonial-card.tsx (Line 24:11 - Line 44:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn161" onclick="toggleCodeBlock('cloneGroup161', 'expandBtn161', 'collapseBtn161')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn161" onclick="toggleCodeBlock('cloneGroup161', 'expandBtn161', 'collapseBtn161')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup161"><code class="language-tsx text-sm text-gray-800">,
  className,
  ...props
}: TestimonialCardProps) =&gt; (
  &lt;div
    className={cn(
      &quot;flex w-full cursor-pointer break-inside-avoid flex-col items-center justify-between gap-6 rounded-xl p-4&quot;,
      &quot;bg-accent&quot;,
      &quot;shadow-[0px_0px_0px_1px_rgba(0,0,0,0.04),0px_8px_12px_-4px_rgba(15,12,12,0.08),0px_1px_2px_0px_rgba(15,12,12,0.10)] dark:shadow-[0px_0px_0px_1px_rgba(250,250,250,0.1),0px_0px_0px_1px_#18181B,0px_8px_12px_-4px_rgba(15,12,12,0.3),0px_1px_2px_0px_rgba(15,12,12,0.3)]&quot;,
      className,
    )}
    {...props}
  &gt;
    &lt;div className=&quot;select-none leading-relaxed font-normal text-primary/90&quot;&gt;
      {description}
    &lt;/div&gt;

    &lt;div className=&quot;flex w-full select-none items-center justify-start gap-3.5&quot;&gt;
      &lt;img src={img} alt={name} className=&quot;size-8 rounded-full&quot; /&gt;

      &lt;div&gt;</code></pre></div><div class="py-4"><p class="text-gray-600">components/landing/ui/testimonial-scroll.tsx (Line 61:2 - Line 89:2), components/marketing/ui/testimonial-card.tsx (Line 80:2 - Line 108:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn162" onclick="toggleCodeBlock('cloneGroup162', 'expandBtn162', 'collapseBtn162')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn162" onclick="toggleCodeBlock('cloneGroup162', 'expandBtn162', 'collapseBtn162')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup162"><code class="language-tsx text-sm text-gray-800">&gt;
      &lt;div className=&quot;px-10&quot;&gt;
        &lt;div className=&quot;relative max-h-[750px] overflow-hidden&quot;&gt;
          &lt;div className=&quot;gap-0 md:columns-2 xl:columns-3&quot;&gt;
            {Array(Math.ceil(testimonials.length / 3))
              .fill(0)
              .map((_, i) =&gt; (
                &lt;Marquee
                  vertical
                  key={i}
                  className={cn({
                    &quot;[--duration:60s]&quot;: i === 1,
                    &quot;[--duration:30s]&quot;: i === 2,
                    &quot;[--duration:70s]&quot;: i === 3,
                  })}
                &gt;
                  {testimonials.slice(i * 3, (i + 1) * 3).map((card, idx) =&gt; (
                    &lt;TestimonialCard {...card} key={idx} /&gt;
                  ))}
                &lt;/Marquee&gt;
              ))}
          &lt;/div&gt;
          &lt;div className=&quot;pointer-events-none absolute inset-x-0 bottom-0 h-1/6 md:h-1/5 w-full bg-gradient-to-t from-background from-20%&quot;&gt;&lt;/div&gt;
          &lt;div className=&quot;pointer-events-none absolute inset-x-0 top-0 h-1/6 md:h-1/5 w-full bg-gradient-to-b from-background from-20%&quot;&gt;&lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}</code></pre></div><div class="py-4"><p class="text-gray-600">components/community/ui/discussion-card.tsx (Line 20:18 - Line 52:8), components/community/ui/server-discussion-card.tsx (Line 4:14 - Line 36:10)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn164" onclick="toggleCodeBlock('cloneGroup164', 'expandBtn164', 'collapseBtn164')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn164" onclick="toggleCodeBlock('cloneGroup164', 'expandBtn164', 'collapseBtn164')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup164"><code class="language-tsx text-sm text-gray-800">;

// Types and interfaces
interface DiscussionTopic {
  id: string;
  name: string;
  color?: string;
}

interface DiscussionAuthor {
  id: string;
  name: string;
  avatarUrl?: string;
  role: string;
}

interface DiscussionData {
  id: string;
  title: string;
  excerpt: string;
  author: DiscussionAuthor;
  replyCount: number;
  upvotes: number;
  lastActivityAt: string;
  topics: DiscussionTopic[];
  isAnswered?: boolean;
  isPinned?: boolean;
}

interface DiscussionCardProps {
  discussion: DiscussionData;
  className?: string;
  onClick</code></pre></div><div class="py-4"><p class="text-gray-600">components/community/ui/discussion-card.tsx (Line 99:2 - Line 120:2), components/community/ui/server-discussion-card.tsx (Line 70:2 - Line 91:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn165" onclick="toggleCodeBlock('cloneGroup165', 'expandBtn165', 'collapseBtn165')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn165" onclick="toggleCodeBlock('cloneGroup165', 'expandBtn165', 'collapseBtn165')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup165"><code class="language-tsx text-sm text-gray-800">
      &gt;
        &lt;CardHeader className=&quot;pb-2&quot;&gt;
          &lt;div className=&quot;flex items-start justify-between&quot;&gt;
            &lt;div className=&quot;flex-1&quot;&gt;
              &lt;div className=&quot;flex gap-2 items-center mb-1&quot;&gt;
                {discussion.isPinned &amp;&amp; (
                  &lt;span className=&quot;text-xs font-medium text-amber-500&quot;&gt;
                    📌 Pinned
                  &lt;/span&gt;
                )}
                {discussion.isAnswered &amp;&amp; (
                  &lt;span className=&quot;text-xs font-medium text-emerald-500&quot;&gt;
                    ✓ Answered
                  &lt;/span&gt;
                )}
              &lt;/div&gt;
              &lt;CardTitle className={cn(
                &quot;font-semibold text-primary&quot;,
                isCompact ? &quot;text-base&quot; : &quot;text-lg&quot;
              )}&gt;
                {</code></pre></div><div class="py-4"><p class="text-gray-600">components/community/ui/discussion-card.tsx (Line 121:15 - Line 178:19), components/community/ui/server-discussion-card.tsx (Line 94:15 - Line 151:25)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn166" onclick="toggleCodeBlock('cloneGroup166', 'expandBtn166', 'collapseBtn166')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn166" onclick="toggleCodeBlock('cloneGroup166', 'expandBtn166', 'collapseBtn166')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup166"><code class="language-tsx text-sm text-gray-800">&lt;/CardTitle&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/CardHeader&gt;

        &lt;CardContent className={cn(
          isCompact ? &quot;pb-3&quot; : &quot;pb-4&quot;
        )}&gt;
          {!isCompact &amp;&amp; (
            &lt;p className=&quot;text-muted-foreground text-sm mb-3 line-clamp-2&quot;&gt;
              {discussion.excerpt}
            &lt;/p&gt;
          )}
          
          &lt;div className=&quot;flex flex-wrap gap-2 mt-2&quot;&gt;
            {discussion.topics.map(topic =&gt; (
              &lt;Badge 
                key={topic.id} 
                variant=&quot;secondary&quot;
                className={cn(
                  &quot;text-xs&quot;,
                  topic.color &amp;&amp; `bg-${topic.color}-100 text-${topic.color}-800`
                )}
              &gt;
                {topic.name}
              &lt;/Badge&gt;
            ))}
          &lt;/div&gt;
        &lt;/CardContent&gt;

        &lt;CardFooter className={cn(
          &quot;flex justify-between pt-0&quot;,
          isCompact ? &quot;text-xs&quot; : &quot;text-sm&quot;
        )}&gt;
          &lt;div className=&quot;flex items-center gap-2&quot;&gt;
            &lt;Avatar 
              src={discussion.author.avatarUrl} 
              alt={discussion.author.name}
              className={cn(
                isCompact ? &quot;h-5 w-5&quot; : &quot;h-6 w-6&quot;
              )}
            /&gt;
            &lt;span className=&quot;text-muted-foreground&quot;&gt;
              {discussion.author.name}
            &lt;/span&gt;
          &lt;/div&gt;
          
          &lt;div className=&quot;flex items-center gap-3 text-muted-foreground&quot;&gt;
            &lt;div className=&quot;flex items-center gap-1&quot;&gt;
              &lt;span className=&quot;text-primary&quot;&gt;▲&lt;/span&gt;
              &lt;span&gt;{discussion.upvotes}&lt;/span&gt;
            &lt;/div&gt;
            &lt;div className=&quot;flex items-center gap-1&quot;&gt;
              &lt;span&gt;💬&lt;/span&gt;
              &lt;span&gt;{discussion.replyCount}&lt;/span&gt;
            &lt;/div&gt;
            &lt;div&gt;
              {formatRelativeTime</code></pre></div><div class="py-4"><p class="text-gray-600">app/booking/confirmation/page.tsx (Line 101:4 - Line 119:8), app/booking/recovery/page.tsx (Line 125:40 - Line 143:9)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn167" onclick="toggleCodeBlock('cloneGroup167', 'expandBtn167', 'collapseBtn167')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn167" onclick="toggleCodeBlock('cloneGroup167', 'expandBtn167', 'collapseBtn167')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup167"><code class="language-tsx text-sm text-gray-800">&quot;&gt;
          &lt;div className=&quot;text-center mb-6&quot;&gt;
            &lt;div className=&quot;w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4&quot;&gt;
              &lt;svg 
                xmlns=&quot;http://www.w3.org/2000/svg&quot; 
                className=&quot;h-8 w-8 text-green-600&quot; 
                fill=&quot;none&quot; 
                viewBox=&quot;0 0 24 24&quot; 
                stroke=&quot;currentColor&quot;
              &gt;
                &lt;path 
                  strokeLinecap=&quot;round&quot; 
                  strokeLinejoin=&quot;round&quot; 
                  strokeWidth={2} 
                  d=&quot;M5 13l4 4L19 7&quot; 
                /&gt;
              &lt;/svg&gt;
            &lt;/div&gt;
            &lt;h1 className=&quot;text-2xl font-bold text-green-700&quot;&gt;Booking</code></pre></div><div class="py-4"><p class="text-gray-600">app/(platform)/learning/page.tsx (Line 56:3 - Line 63:3), app/(platform)/learning/timeline/page.tsx (Line 57:2 - Line 65:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn168" onclick="toggleCodeBlock('cloneGroup168', 'expandBtn168', 'collapseBtn168')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn168" onclick="toggleCodeBlock('cloneGroup168', 'expandBtn168', 'collapseBtn168')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup168"><code class="language-tsx text-sm text-gray-800">&gt;
        &lt;Card className=&quot;p-6&quot;&gt;
          &lt;div className=&quot;p-12 text-center&quot;&gt;
            &lt;p className=&quot;text-xl text-muted-foreground&quot;&gt;Timeline visualization is loading...&lt;/p&gt;
            &lt;p className=&quot;mt-4 text-sm text-muted-foreground&quot;&gt;This feature is under active development&lt;/p&gt;
          &lt;/div&gt;
        &lt;/Card&gt;
      &lt;/</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/integration/booking-payment/calendly-booking-flow.test.tsx (Line 159:5 - Line 170:2), __tests__/integration/booking-payment/calendly-booking-flow.test.tsx (Line 107:5 - Line 117:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn177" onclick="toggleCodeBlock('cloneGroup177', 'expandBtn177', 'collapseBtn177')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn177" onclick="toggleCodeBlock('cloneGroup177', 'expandBtn177', 'collapseBtn177')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup177"><code class="language-tsx text-sm text-gray-800">const mockBooking = {
      id: 'booking-123',
      builderId: mockBuilder.id,
      clientId: 'client-123',
      sessionTypeId: 'session-1',
      title: 'Initial Consultation',
      description: 'A brief intro call to discuss your project needs',
      startTime: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
      endTime: new Date(Date.now() + 24 * 60 * 60 * 1000 + 30 * 60 * 1000).toISOString(),
      status: 'PENDING',
      paymentStatus: 'UNPAID'
    }</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/integration/auth-marketplace/booking-integration.test.tsx (Line 123:7 - Line 141:75), __tests__/integration/auth-marketplace/booking-integration.test.tsx (Line 61:7 - Line 79:62)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn178" onclick="toggleCodeBlock('cloneGroup178', 'expandBtn178', 'collapseBtn178')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn178" onclick="toggleCodeBlock('cloneGroup178', 'expandBtn178', 'collapseBtn178')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup178"><code class="language-tsx text-sm text-gray-800">// Setup unauthenticated state
      (useAuth as any).mockReturnValue({
        isSignedIn: false,
        isLoaded: true
      });
      
      render(
        &lt;IntegratedBooking
          builderId=&quot;test-builder-id&quot;
          sessionTypes={[]}
          buttonText=&quot;Book Now&quot;
        /&gt;
      );
      
      // Find and click the booking button
      const bookButton = screen.getByText('Book Now');
      fireEvent.click(bookButton);
      
      // Verify the URL format matches what we expect the sign-in page to handle</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/components/error-boundaries/global-error-boundary.test.tsx (Line 96:50 - Line 105:15), __tests__/components/error-boundaries/global-error-boundary.test.tsx (Line 47:40 - Line 56:9)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn192" onclick="toggleCodeBlock('cloneGroup192', 'expandBtn192', 'collapseBtn192')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn192" onclick="toggleCodeBlock('cloneGroup192', 'expandBtn192', 'collapseBtn192')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup192"><code class="language-tsx text-sm text-gray-800">, () =&gt; {
    // Mock window.addEventListener to trigger the error handler
    const originalAddEventListener = window.addEventListener;
    window.addEventListener = vi.fn((event, handler) =&gt; {
      if (event === 'error') {
        // Trigger the error handler immediately
        handler({
          error: new Error('Test error'),
          message: 'Test error message',
          preventDefault</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/components/error-boundaries/global-error-boundary.test.tsx (Line 135:2 - Line 151:39), __tests__/components/error-boundaries/global-error-boundary.test.tsx (Line 58:3 - Line 73:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn193" onclick="toggleCodeBlock('cloneGroup193', 'expandBtn193', 'collapseBtn193')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn193" onclick="toggleCodeBlock('cloneGroup193', 'expandBtn193', 'collapseBtn193')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup193"><code class="language-tsx text-sm text-gray-800">,
          preventDefault: vi.fn(),
        });
      }
      return originalAddEventListener(event, handler);
    });
    
    render(
      &lt;GlobalErrorBoundary&gt;
        &lt;div&gt;Test Content&lt;/div&gt;
      &lt;/GlobalErrorBoundary&gt;
    );
    
    // Check error UI is rendered
    expect(screen.getByText('Something went wrong')).toBeInTheDocument();
    
    // Check logger and Sentry were called</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/components/error-boundaries/global-error-boundary.test.tsx (Line 163:61 - Line 178:7), __tests__/components/error-boundaries/global-error-boundary.test.tsx (Line 47:40 - Line 111:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn194" onclick="toggleCodeBlock('cloneGroup194', 'expandBtn194', 'collapseBtn194')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn194" onclick="toggleCodeBlock('cloneGroup194', 'expandBtn194', 'collapseBtn194')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup194"><code class="language-tsx text-sm text-gray-800">, () =&gt; {
    // Mock window.addEventListener to trigger the error handler
    const originalAddEventListener = window.addEventListener;
    window.addEventListener = vi.fn((event, handler) =&gt; {
      if (event === 'error') {
        // Trigger the error handler immediately
        handler({
          error: new Error('Test error'),
          message: 'Test error message',
          preventDefault: vi.fn(),
        });
      }
      return originalAddEventListener(event, handler);
    });
    
    render</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/components/error-boundaries/global-error-boundary.test.tsx (Line 193:49 - Line 208:31), __tests__/components/error-boundaries/global-error-boundary.test.tsx (Line 47:40 - Line 111:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn195" onclick="toggleCodeBlock('cloneGroup195', 'expandBtn195', 'collapseBtn195')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn195" onclick="toggleCodeBlock('cloneGroup195', 'expandBtn195', 'collapseBtn195')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup195"><code class="language-tsx text-sm text-gray-800">, () =&gt; {
    // Mock window.addEventListener to trigger the error handler
    const originalAddEventListener = window.addEventListener;
    window.addEventListener = vi.fn((event, handler) =&gt; {
      if (event === 'error') {
        // Trigger the error handler immediately
        handler({
          error: new Error('Test error'),
          message: 'Test error message',
          preventDefault: vi.fn(),
        });
      }
      return originalAddEventListener(event, handler);
    });
    
    // Mock window.location.reload</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/components/error-boundaries/feature-error-boundary.test.tsx (Line 9:15 - Line 19:2), __tests__/integration/error-handling/error-boundary-sentry.test.tsx (Line 10:15 - Line 20:11)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn196" onclick="toggleCodeBlock('cloneGroup196', 'expandBtn196', 'collapseBtn196')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn196" onclick="toggleCodeBlock('cloneGroup196', 'expandBtn196', 'collapseBtn196')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup196"><code class="language-tsx text-sm text-gray-800">;

// Mock Sentry
vi.mock('@sentry/nextjs', () =&gt; ({
  captureException: vi.fn(() =&gt; 'mock-event-id'),
  showReportDialog: vi.fn(),
  withScope: vi.fn((callback) =&gt; {
    const mockScope = {
      setTag: vi.fn(),
      setExtra: vi.fn(),
    }</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/components/error-boundaries/api-error-boundary.test.tsx (Line 10:8 - Line 33:9), __tests__/integration/error-handling/error-boundary-sentry.test.tsx (Line 10:15 - Line 32:40)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn198" onclick="toggleCodeBlock('cloneGroup198', 'expandBtn198', 'collapseBtn198')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn198" onclick="toggleCodeBlock('cloneGroup198', 'expandBtn198', 'collapseBtn198')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup198"><code class="language-tsx text-sm text-gray-800">;

// Mock Sentry
vi.mock('@sentry/nextjs', () =&gt; ({
  captureException: vi.fn(() =&gt; 'mock-event-id'),
  showReportDialog: vi.fn(),
  withScope: vi.fn((callback) =&gt; {
    const mockScope = {
      setTag: vi.fn(),
      setExtra: vi.fn(),
    };
    callback(mockScope);
    return 'mock-event-id';
  }),
}));

// Mock logger
vi.mock('@/lib/logger', () =&gt; ({
  logger: {
    error: vi.fn(),
  },
}));

describe</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/components/error-boundaries/api-error-boundary.test.tsx (Line 194:2 - Line 207:38), __tests__/components/error-boundaries/api-error-boundary.test.tsx (Line 168:7 - Line 181:37)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn199" onclick="toggleCodeBlock('cloneGroup199', 'expandBtn199', 'collapseBtn199')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn199" onclick="toggleCodeBlock('cloneGroup199', 'expandBtn199', 'collapseBtn199')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup199"><code class="language-tsx text-sm text-gray-800">&gt;
        {({ setError }) =&gt; (
          &lt;div&gt;
            &lt;button onClick={() =&gt; setError(new Error('API error'))}&gt;Trigger Error&lt;/button&gt;
            &lt;span&gt;No Error&lt;/span&gt;
          &lt;/div&gt;
        )}
      &lt;/ApiErrorBoundary&gt;
    );
    
    // Trigger error
    fireEvent.click(screen.getByText('Trigger Error'));
    
    // Check default error UI is rendered</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/components/error-boundaries/api-error-boundary.test.tsx (Line 220:61 - Line 235:29), __tests__/components/error-boundaries/api-error-boundary.test.tsx (Line 192:76 - Line 181:37)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn200" onclick="toggleCodeBlock('cloneGroup200', 'expandBtn200', 'collapseBtn200')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn200" onclick="toggleCodeBlock('cloneGroup200', 'expandBtn200', 'collapseBtn200')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup200"><code class="language-tsx text-sm text-gray-800">, () =&gt; {
    render(
      &lt;ApiErrorBoundary apiName=&quot;UserData&quot;&gt;
        {({ setError }) =&gt; (
          &lt;div&gt;
            &lt;button onClick={() =&gt; setError(new Error('API error'))}&gt;Trigger Error&lt;/button&gt;
            &lt;span&gt;No Error&lt;/span&gt;
          &lt;/div&gt;
        )}
      &lt;/ApiErrorBoundary&gt;
    );
    
    // Trigger error
    fireEvent.click(screen.getByText('Trigger Error'));
    
    // Click the feedback button</code></pre></div><div class="py-4"><p class="text-gray-600">__tests__/components/error-boundaries/api-error-boundary.test.tsx (Line 256:5 - Line 267:27), __tests__/integration/error-handling/error-boundary-sentry.test.tsx (Line 156:7 - Line 167:48)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn201" onclick="toggleCodeBlock('cloneGroup201', 'expandBtn201', 'collapseBtn201')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn201" onclick="toggleCodeBlock('cloneGroup201', 'expandBtn201', 'collapseBtn201')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup201"><code class="language-tsx text-sm text-gray-800">fireEvent.click(screen.getByText('Trigger Error'));
    
    // Get the scope callback
    const scopeCallback = Sentry.withScope.mock.calls[0][0];
    const mockScope = {
      setTag: vi.fn(),
    };
    
    // Call the callback
    scopeCallback(mockScope);
    
    // Check API tags were set</code></pre></div><div class="py-4"><p class="text-gray-600">components/scheduling/session-type-list.tsx (Line 42:9 - Line 53:9), components/scheduling/calendly/calendly-session-type-list.tsx (Line 136:13 - Line 147:16)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn262" onclick="toggleCodeBlock('cloneGroup262', 'expandBtn262', 'collapseBtn262')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn262" onclick="toggleCodeBlock('cloneGroup262', 'expandBtn262', 'collapseBtn262')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup262"><code class="language-tsx text-sm text-gray-800">.map((session) =&gt; (
        &lt;Card key={session.id} className=&quot;overflow-hidden&quot;&gt;
          &lt;CardContent className=&quot;p-0&quot;&gt;
            &lt;div className=&quot;flex items-center p-6&quot;&gt;
              &lt;div className=&quot;flex-grow&quot;&gt;
                &lt;h4 className=&quot;font-medium text-base&quot;&gt;{session.title}&lt;/h4&gt;
                &lt;p className=&quot;text-muted-foreground text-sm mt-1&quot;&gt;{session.description}&lt;/p&gt;
                
                &lt;div className=&quot;flex mt-3&quot;&gt;
                  &lt;div className=&quot;flex items-center text-sm text-muted-foreground&quot;&gt;
                    &lt;Clock className=&quot;h-4 w-4 mr-1&quot; /&gt;
                    {session.duration</code></pre></div><div class="py-4"><p class="text-gray-600">components/providers/enhanced-clerk-provider.tsx (Line 105:2 - Line 124:2), app/(auth)/sign-up/[[...sign-up]]/page.tsx (Line 31:2 - Line 50:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn263" onclick="toggleCodeBlock('cloneGroup263', 'expandBtn263', 'collapseBtn263')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn263" onclick="toggleCodeBlock('cloneGroup263', 'expandBtn263', 'collapseBtn263')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup263"><code class="language-tsx text-sm text-gray-800">{
        baseTheme: theme === &quot;dark&quot; ? dark : undefined,
        elements: {
          formButtonPrimary:
            &quot;bg-primary hover:bg-primary/90 text-primary-foreground&quot;,
          card: &quot;bg-background border border-border shadow-sm&quot;,
          formButtonReset: &quot;text-muted-foreground hover:text-foreground&quot;,
          footerActionLink: &quot;text-primary hover:text-primary/90&quot;,
          headerTitle: &quot;text-foreground&quot;,
          headerSubtitle: &quot;text-muted-foreground&quot;,
          socialButtonsBlockButton:
            &quot;border border-border hover:bg-muted text-foreground&quot;,
          formFieldLabel: &quot;text-foreground&quot;,
          formFieldInput:
            &quot;bg-background border border-input text-foreground rounded-md&quot;,
          identityPreview: &quot;bg-muted-foreground/20&quot;,
          dividerLine: &quot;bg-border&quot;,
          dividerText: &quot;text-muted-foreground&quot;,
        },
      }}</code></pre></div><div class="py-4"><p class="text-gray-600">components/profile/portfolio-gallery.tsx (Line 362:11 - Line 376:23), components/profile/portfolio-showcase.tsx (Line 155:11 - Line 169:15)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn267" onclick="toggleCodeBlock('cloneGroup267', 'expandBtn267', 'collapseBtn267')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn267" onclick="toggleCodeBlock('cloneGroup267', 'expandBtn267', 'collapseBtn267')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup267"><code class="language-tsx text-sm text-gray-800">&lt;/&gt;
        ) : (
          &lt;div className=&quot;absolute inset-0 flex items-center justify-center bg-muted&quot;&gt;
            &lt;span className=&quot;text-lg font-medium&quot;&gt;{project.title}&lt;/span&gt;
          &lt;/div&gt;
        )}
      &lt;/div&gt;
      
      &lt;CardHeader className=&quot;pb-2&quot;&gt;
        &lt;CardTitle className=&quot;line-clamp-1&quot;&gt;{project.title}&lt;/CardTitle&gt;
        &lt;CardDescription className=&quot;line-clamp-2&quot;&gt;{project.description}&lt;/CardDescription&gt;
      &lt;/CardHeader&gt;
      
      &lt;CardContent className=&quot;flex-grow&quot;&gt;
        {/* Featured Outcome */</code></pre></div><div class="py-4"><p class="text-gray-600">components/profile/builder-profile.tsx (Line 546:12 - Line 554:12), components/profile/builder-profile.tsx (Line 508:18 - Line 516:18)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn268" onclick="toggleCodeBlock('cloneGroup268', 'expandBtn268', 'collapseBtn268')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn268" onclick="toggleCodeBlock('cloneGroup268', 'expandBtn268', 'collapseBtn268')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup268"><code class="language-tsx text-sm text-gray-800">].bulletPoints.map((point, i) =&gt; (
                          &lt;li key={i} className=&quot;flex items-start gap-2&quot;&gt;
                            &lt;CheckIcon className=&quot;h-5 w-5 text-green-500 mt-0.5 flex-shrink-0&quot; /&gt;
                            &lt;span&gt;{point}&lt;/span&gt;
                          &lt;/li&gt;
                        ))}
                      &lt;/ul&gt;
                      
                      {profile.expertiseAreas[SpecializationArea.AI_LITERACY</code></pre></div><div class="py-4"><p class="text-gray-600">components/profile/builder-profile.tsx (Line 584:17 - Line 592:17), components/profile/builder-profile.tsx (Line 508:18 - Line 516:18)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn269" onclick="toggleCodeBlock('cloneGroup269', 'expandBtn269', 'collapseBtn269')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn269" onclick="toggleCodeBlock('cloneGroup269', 'expandBtn269', 'collapseBtn269')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup269"><code class="language-tsx text-sm text-gray-800">].bulletPoints.map((point, i) =&gt; (
                          &lt;li key={i} className=&quot;flex items-start gap-2&quot;&gt;
                            &lt;CheckIcon className=&quot;h-5 w-5 text-green-500 mt-0.5 flex-shrink-0&quot; /&gt;
                            &lt;span&gt;{point}&lt;/span&gt;
                          &lt;/li&gt;
                        ))}
                      &lt;/ul&gt;
                      
                      {profile.expertiseAreas[SpecializationArea.BUILDING_WITH_AI</code></pre></div><div class="py-4"><p class="text-gray-600">components/profile/builder-profile.tsx (Line 622:15 - Line 630:15), components/profile/builder-profile.tsx (Line 508:18 - Line 516:18)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn270" onclick="toggleCodeBlock('cloneGroup270', 'expandBtn270', 'collapseBtn270')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn270" onclick="toggleCodeBlock('cloneGroup270', 'expandBtn270', 'collapseBtn270')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup270"><code class="language-tsx text-sm text-gray-800">].bulletPoints.map((point, i) =&gt; (
                          &lt;li key={i} className=&quot;flex items-start gap-2&quot;&gt;
                            &lt;CheckIcon className=&quot;h-5 w-5 text-green-500 mt-0.5 flex-shrink-0&quot; /&gt;
                            &lt;span&gt;{point}&lt;/span&gt;
                          &lt;/li&gt;
                        ))}
                      &lt;/ul&gt;
                      
                      {profile.expertiseAreas[SpecializationArea.BUSINESS_VALUE</code></pre></div><div class="py-4"><p class="text-gray-600">components/profile/builder-profile-client-wrapper.tsx (Line 102:13 - Line 117:2), components/profile/ui/session-booking-card.tsx (Line 184:13 - Line 199:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn271" onclick="toggleCodeBlock('cloneGroup271', 'expandBtn271', 'collapseBtn271')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn271" onclick="toggleCodeBlock('cloneGroup271', 'expandBtn271', 'collapseBtn271')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup271"><code class="language-tsx text-sm text-gray-800">&lt;/DialogDescription&gt;
          &lt;/DialogHeader&gt;
          
          &lt;DialogFooter className=&quot;flex space-x-2 pt-4&quot;&gt;
            &lt;Button variant=&quot;outline&quot; onClick={() =&gt; setShowAuthDialog(false)}&gt;
              Cancel
            &lt;/Button&gt;
            &lt;Button onClick={handleSignIn}&gt;
              Sign In
            &lt;/Button&gt;
          &lt;/DialogFooter&gt;
        &lt;/DialogContent&gt;
      &lt;/Dialog&gt;
    &lt;/&gt;
  );
}</code></pre></div><div class="py-4"><p class="text-gray-600">components/profile/app-showcase.tsx (Line 101:2 - Line 115:4), components/profile/portfolio-showcase.tsx (Line 97:2 - Line 111:8)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn274" onclick="toggleCodeBlock('cloneGroup274', 'expandBtn274', 'collapseBtn274')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn274" onclick="toggleCodeBlock('cloneGroup274', 'expandBtn274', 'collapseBtn274')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup274"><code class="language-tsx text-sm text-gray-800">&amp;&amp; (
          &lt;motion.div
            initial={shouldReduceMotion ? { opacity: 0 } : { opacity: 0, y: 20 }}
            animate={shouldReduceMotion ? { opacity: 1 } : { opacity: 1, y: 0 }}
            transition={{ 
              duration: 0.4, 
              delay: shouldReduceMotion ? 0 : displayApps.length * 0.1,
              ease: &quot;easeOut&quot; 
            }}
          &gt;
            &lt;Card className=&quot;h-full border border-dashed flex flex-col justify-center items-center p-8 hover:border-primary/50 transition-colors duration-200 cursor-pointer&quot; onClick={onAddApp}&gt;
              &lt;div className=&quot;rounded-full bg-primary/10 p-4 mb-4&quot;&gt;
                &lt;PlusIcon className=&quot;h-6 w-6 text-primary&quot; /&gt;
              &lt;/div&gt;
              &lt;h3 className=&quot;text-xl font-medium&quot;&gt;Add New App</code></pre></div><div class="py-4"><p class="text-gray-600">components/profile/app-showcase.tsx (Line 162:4 - Line 178:18), components/profile/portfolio-showcase.tsx (Line 142:8 - Line 158:20)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn275" onclick="toggleCodeBlock('cloneGroup275', 'expandBtn275', 'collapseBtn275')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn275" onclick="toggleCodeBlock('cloneGroup275', 'expandBtn275', 'collapseBtn275')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup275"><code class="language-tsx text-sm text-gray-800">.imageUrl ? (
          &lt;&gt;
            &lt;div className={cn(
              &quot;absolute inset-0 bg-muted/80 backdrop-blur-sm transition-opacity duration-300&quot;,
              imageLoaded ? &quot;opacity-0&quot; : &quot;opacity-100&quot;
            )} /&gt;
            &lt;Image
              src={app.imageUrl}
              alt={app.title}
              fill
              className=&quot;object-cover&quot;
              onLoad={() =&gt; setImageLoaded(true)}
            /&gt;
          &lt;/&gt;
        ) : (
          &lt;div className=&quot;absolute inset-0 flex items-center justify-center bg-muted&quot;&gt;
            &lt;span className=&quot;text-lg font-bold</code></pre></div><div class="py-4"><p class="text-gray-600">components/platform/platform-header.tsx (Line 358:11 - Line 376:3), components/platform/platform-header.tsx (Line 288:15 - Line 307:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn280" onclick="toggleCodeBlock('cloneGroup280', 'expandBtn280', 'collapseBtn280')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn280" onclick="toggleCodeBlock('cloneGroup280', 'expandBtn280', 'collapseBtn280')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup280"><code class="language-tsx text-sm text-gray-800">.map((item) =&gt; (
                        &lt;Link
                          key={item.id}
                          href={item.href}
                          className={cn(
                            &quot;block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800&quot;,
                            pathname === item.href ? &quot;bg-slate-100 dark:bg-slate-800&quot; : &quot;&quot;
                          )}
                        &gt;
                          &lt;div className=&quot;font-medium&quot;&gt;{item.label}&lt;/div&gt;
                          &lt;div className=&quot;text-xs text-slate-500 dark:text-slate-400&quot;&gt;{item.description}&lt;/div&gt;
                        &lt;/Link&gt;
                      ))}
                    &lt;/div&gt;
                  &lt;/motion.div&gt;
                )}
              &lt;/AnimatePresence&gt;
            &lt;/div&gt;
          &lt;/</code></pre></div><div class="py-4"><p class="text-gray-600">components/platform/platform-header.tsx (Line 646:11 - Line 664:55), components/platform/platform-header.tsx (Line 619:15 - Line 637:20)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn281" onclick="toggleCodeBlock('cloneGroup281', 'expandBtn281', 'collapseBtn281')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn281" onclick="toggleCodeBlock('cloneGroup281', 'expandBtn281', 'collapseBtn281')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup281"><code class="language-tsx text-sm text-gray-800">.map((item) =&gt; (
                  &lt;motion.li
                    variants={mobileLinkVar}
                    key={item.id}
                    className=&quot;border-b border-slate-200 dark:border-slate-700 last:border-none&quot;
                  &gt;
                    &lt;Link
                      className={`hover:bg-slate-200 dark:hover:bg-slate-700 flex w-full flex-col p-4 transition-colors ${pathname === item.href ? &quot;bg-slate-200 dark:bg-slate-700&quot; : &quot;&quot;}`}
                      href={item.href}
                    &gt;
                      &lt;span className=&quot;font-medium&quot;&gt;{item.label}&lt;/span&gt;
                      &lt;span className=&quot;text-xs mt-1 text-slate-500 dark:text-slate-400&quot;&gt;{item.description}&lt;/span&gt;
                    &lt;/Link&gt;
                  &lt;/motion.li&gt;
                ))}
              &lt;/motion.ul&gt;
            &lt;/div&gt;
            
            {/* Login/Signup buttons for non-authenticated users */</code></pre></div><div class="py-4"><p class="text-gray-600">components/marketplace/builder-list-client.tsx (Line 61:7 - Line 74:3), components/marketplace/builder-list.tsx (Line 72:7 - Line 85:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn283" onclick="toggleCodeBlock('cloneGroup283', 'expandBtn283', 'collapseBtn283')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn283" onclick="toggleCodeBlock('cloneGroup283', 'expandBtn283', 'collapseBtn283')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup283"><code class="language-tsx text-sm text-gray-800">{Array.from({ length: count }).map((_, index) =&gt; (
        &lt;div 
          key={index}
          className=&quot;rounded-lg border bg-card text-card-foreground shadow-sm animate-pulse&quot;
        &gt;
          &lt;div className=&quot;h-48 bg-muted rounded-t-lg&quot; /&gt;
          &lt;div className=&quot;p-6 space-y-4&quot;&gt;
            &lt;div className=&quot;h-4 bg-muted rounded w-3/4&quot; /&gt;
            &lt;div className=&quot;h-3 bg-muted rounded w-1/2&quot; /&gt;
            &lt;div className=&quot;h-3 bg-muted rounded w-5/6&quot; /&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      ))}
    &lt;/</code></pre></div><div class="py-4"><p class="text-gray-600">components/marketplace/builder-dashboard.tsx (Line 465:7 - Line 473:7), components/marketplace/builder-dashboard.tsx (Line 429:6 - Line 437:6)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn284" onclick="toggleCodeBlock('cloneGroup284', 'expandBtn284', 'collapseBtn284')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn284" onclick="toggleCodeBlock('cloneGroup284', 'expandBtn284', 'collapseBtn284')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup284"><code class="language-tsx text-sm text-gray-800">}&lt;/span&gt;
                        &lt;button className=&quot;ml-2 text-secondary-foreground/70 hover:text-secondary-foreground&quot;&gt;
                          &lt;X className=&quot;h-3 w-3&quot; /&gt;
                        &lt;/button&gt;
                      &lt;/div&gt;
                    ))}
                    &lt;button className=&quot;flex items-center rounded-full border border-dashed px-3 py-1 text-sm text-muted-foreground hover:border-primary hover:text-primary&quot;&gt;
                      &lt;Plus className=&quot;mr-1 h-3 w-3&quot; /&gt;
                      Add Domain</code></pre></div><div class="py-4"><p class="text-gray-600">components/marketplace/builder-card.tsx (Line 27:3 - Line 50:4), components/marketplace/components/builder-card/builder-card.tsx (Line 30:3 - Line 53:25)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn285" onclick="toggleCodeBlock('cloneGroup285', 'expandBtn285', 'collapseBtn285')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn285" onclick="toggleCodeBlock('cloneGroup285', 'expandBtn285', 'collapseBtn285')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup285"><code class="language-tsx text-sm text-gray-800">// Determine the validation tier string
  const getTierString = (tier: number): 'basic' | 'verified' | 'expert' =&gt; {
    switch (tier) {
      case 3:
        return 'expert';
      case 2:
        return 'verified';
      case 1:
      default:
        return 'basic';
    }
  };

  // Format hourly rate with currency symbol
  const formatHourlyRate = (rate?: number) =&gt; {
    if (!rate) return null;
    return `$${rate.toFixed(0)}/hr`;
  };

  // Get tier string for display
  const tierString = getTierString(builder.validationTier);

  return (
    &lt;div</code></pre></div><div class="py-4"><p class="text-gray-600">components/marketplace/builder-card.tsx (Line 91:13 - Line 106:2), components/marketplace/components/builder-card/builder-card.tsx (Line 69:15 - Line 84:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn286" onclick="toggleCodeBlock('cloneGroup286', 'expandBtn286', 'collapseBtn286')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn286" onclick="toggleCodeBlock('cloneGroup286', 'expandBtn286', 'collapseBtn286')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup286"><code class="language-tsx text-sm text-gray-800">&lt;/div&gt;
            &lt;p className=&quot;text-sm text-muted-foreground&quot;&gt;
              {builder.headline || builder.tagline || formatHourlyRate(builder.hourlyRate)}
            &lt;/p&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/CardHeader&gt;
      &lt;CardContent className=&quot;flex-grow&quot;&gt;
        &lt;p className=&quot;text-sm line-clamp-3 mb-3&quot;&gt;
          {builder.bio || &quot;This builder hasn't added a bio yet.&quot;}
        &lt;/p&gt;
        
        {/* Skills */}
        &lt;div className=&quot;flex flex-wrap gap-1.5 mt-2&quot;&gt;
          {(builder.topSkills?.length &gt; 0 ? builder.topSkills : builder.skills)
            ?.slice(0, 5).map((skill: string)</code></pre></div><div class="py-4"><p class="text-gray-600">components/marketplace/builder-card.tsx (Line 110:13 - Line 125:15), components/marketplace/components/builder-card/builder-card.tsx (Line 88:15 - Line 103:17)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn287" onclick="toggleCodeBlock('cloneGroup287', 'expandBtn287', 'collapseBtn287')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn287" onclick="toggleCodeBlock('cloneGroup287', 'expandBtn287', 'collapseBtn287')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup287"><code class="language-tsx text-sm text-gray-800">&gt;
              {skill}
            &lt;/span&gt;
          ))}
          {(builder.skills?.length || 0) &gt; 5 &amp;&amp; (
            &lt;span className=&quot;px-2 py-0.5 bg-muted text-xs rounded-full&quot;&gt;
              +{(builder.skills?.length || 0) - 5} more
            &lt;/span&gt;
          )}
        &lt;/div&gt;

        {/* Availability indicator */}
        {builder.availability &amp;&amp; (
          &lt;div className=&quot;mt-3 flex items-center&quot;&gt;
            &lt;span 
              </code></pre></div><div class="py-4"><p class="text-gray-600">components/marketing/feature-showcase.tsx (Line 71:2 - Line 78:6), components/marketing/ui/feature-card.tsx (Line 107:2 - Line 114:13)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn288" onclick="toggleCodeBlock('cloneGroup288', 'expandBtn288', 'collapseBtn288')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn288" onclick="toggleCodeBlock('cloneGroup288', 'expandBtn288', 'collapseBtn288')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup288"><code class="language-tsx text-sm text-gray-800">icon || (
          &lt;svg className=&quot;w-8 h-8 text-primary&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;
            &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot; strokeWidth={2} d=&quot;M5 13l4 4L19 7&quot; /&gt;
          &lt;/svg&gt;
        )}
      &lt;/div&gt;
      &lt;h3 className=&quot;text-xl font-semibold mb-2&quot;&gt;
        {index</code></pre></div><div class="py-4"><p class="text-gray-600">components/marketing/feature-showcase.tsx (Line 161:3 - Line 169:2), components/marketing/feature-showcase.tsx (Line 139:5 - Line 147:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn289" onclick="toggleCodeBlock('cloneGroup289', 'expandBtn289', 'collapseBtn289')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn289" onclick="toggleCodeBlock('cloneGroup289', 'expandBtn289', 'collapseBtn289')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup289"><code class="language-tsx text-sm text-gray-800">return (
    &lt;section id={id} className={cn(&quot;container px-4 sm:px-10 py-20&quot;, className)}&gt;
      &lt;div className=&quot;text-center mb-12&quot;&gt;
        &lt;h2 className=&quot;text-3xl md:text-4xl font-medium tracking-tighter mb-4&quot;&gt;{title}&lt;/h2&gt;
        &lt;p className=&quot;text-muted-foreground font-medium max-w-2xl mx-auto&quot;&gt;{subtitle}&lt;/p&gt;
      &lt;/div&gt;

      &lt;div className=&quot;grid grid-cols-1 md:grid-cols-3 gap-8 mx-auto&quot;&gt;
        {features.map((feature, index) =&gt; {</code></pre></div><div class="py-4"><p class="text-gray-600">components/marketing/feature-grid.tsx (Line 45:9 - Line 59:2), components/marketing/feature-showcase.tsx (Line 95:9 - Line 109:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn290" onclick="toggleCodeBlock('cloneGroup290', 'expandBtn290', 'collapseBtn290')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn290" onclick="toggleCodeBlock('cloneGroup290', 'expandBtn290', 'collapseBtn290')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup290"><code class="language-tsx text-sm text-gray-800">&lt;div className=&quot;border-x mx-5 md:mx-10 relative max-w-7xl w-full&quot;&gt;
          &lt;div className=&quot;absolute top-0 -left-4 md:-left-14 h-full w-4 md:w-14 text-primary/5 bg-[size:10px_10px] [background-image:repeating-linear-gradient(315deg,currentColor_0_1px,#0000_0_50%)]&quot;&gt;&lt;/div&gt;
          &lt;div className=&quot;absolute top-0 -right-4 md:-right-14 h-full w-4 md:w-14 text-primary/5 bg-[size:10px_10px] [background-image:repeating-linear-gradient(315deg,currentColor_0_1px,#0000_0_50%)]&quot;&gt;&lt;/div&gt;

          &lt;div className=&quot;text-center mb-12&quot;&gt;
            &lt;h2 className=&quot;text-3xl md:text-4xl font-medium tracking-tighter mb-4 text-balance&quot;&gt;
              {title}
            &lt;/h2&gt;
            &lt;p className=&quot;text-muted-foreground text-center text-balance font-medium max-w-2xl mx-auto&quot;&gt;
              {subtitle}
            &lt;/p&gt;
          &lt;/div&gt;

          &lt;div className=&quot;grid grid-cols-1 md:grid-cols-2 overflow-hidden&quot;&gt;
            {features.map((feature,</code></pre></div><div class="py-4"><p class="text-gray-600">components/magicui/word-rotate-with-fonts.tsx (Line 20:20 - Line 30:25), components/magicui/word-rotate.tsx (Line 15:11 - Line 25:16)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn291" onclick="toggleCodeBlock('cloneGroup291', 'expandBtn291', 'collapseBtn291')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn291" onclick="toggleCodeBlock('cloneGroup291', 'expandBtn291', 'collapseBtn291')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup291"><code class="language-tsx text-sm text-gray-800">({
  words,
  duration = 2500,
  motionProps = {
    initial: { opacity: 0, y: -50 },
    animate: { opacity: 1, y: 0 },
    exit: { opacity: 0, y: 50 },
    transition: { duration: 0.25, ease: &quot;easeOut&quot; },
  },
  className,
}: WordRotateWithFontsProps</code></pre></div><div class="py-4"><p class="text-gray-600">components/magicui/text-animate.tsx (Line 278:4 - Line 292:4), components/magicui/text-animate.tsx (Line 255:4 - Line 269:4)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn292" onclick="toggleCodeBlock('cloneGroup292', 'expandBtn292', 'collapseBtn292')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn292" onclick="toggleCodeBlock('cloneGroup292', 'expandBtn292', 'collapseBtn292')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup292"><code class="language-tsx text-sm text-gray-800">, opacity: 0 },
      show: {
        scale: 1,
        opacity: 1,
        transition: {
          duration: 0.3,
          scale: {
            type: &quot;spring&quot;,
            damping: 15,
            stiffness: 300,
          },
        },
      },
      exit: {
        scale: 1.5</code></pre></div><div class="py-4"><p class="text-gray-600">components/magicui/terminal.tsx (Line 50:3 - Line 59:6), components/magicui/typing-animation.tsx (Line 25:3 - Line 34:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn293" onclick="toggleCodeBlock('cloneGroup293', 'expandBtn293', 'collapseBtn293')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn293" onclick="toggleCodeBlock('cloneGroup293', 'expandBtn293', 'collapseBtn293')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup293"><code class="language-tsx text-sm text-gray-800">const MotionComponent = motion.create(Component, {
    forwardMotionProps: true,
  });

  const [displayedText, setDisplayedText] = useState&lt;string&gt;(&quot;&quot;);
  const [started, setStarted] = useState(false);
  const elementRef = useRef&lt;HTMLElement | null&gt;(null);

  useEffect(() =&gt; {
    const</code></pre></div><div class="py-4"><p class="text-gray-600">components/magicui/terminal.tsx (Line 63:6 - Line 92:2), components/magicui/typing-animation.tsx (Line 58:12 - Line 90:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn294" onclick="toggleCodeBlock('cloneGroup294', 'expandBtn294', 'collapseBtn294')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn294" onclick="toggleCodeBlock('cloneGroup294', 'expandBtn294', 'collapseBtn294')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup294"><code class="language-tsx text-sm text-gray-800">]);

  useEffect(() =&gt; {
    if (!started) return;

    let i = 0;
    const typingEffect = setInterval(() =&gt; {
      if (i &lt; children.length) {
        setDisplayedText(children.substring(0, i + 1));
        i++;
      } else {
        clearInterval(typingEffect);
      }
    }, duration);

    return () =&gt; {
      clearInterval(typingEffect);
    };
  }, [children, duration, started]);

  return (
    &lt;MotionComponent
      ref={elementRef}
      className={cn(&quot;text-sm font-mono tracking-tight&quot;, className)}
      {...props}
    &gt;
      {displayedText}
    &lt;/MotionComponent&gt;
  );
}</code></pre></div><div class="py-4"><p class="text-gray-600">components/magicui/particles.tsx (Line 306:3 - Line 356:7), components/magicui/particles.tsx (Line 103:3 - Line 153:10)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn295" onclick="toggleCodeBlock('cloneGroup295', 'expandBtn295', 'collapseBtn295')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn295" onclick="toggleCodeBlock('cloneGroup295', 'expandBtn295', 'collapseBtn295')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup295"><code class="language-tsx text-sm text-gray-800">const animate = () =&gt; {
    clearContext();
    circles.current.forEach((circle: Circle, i: number) =&gt; {
      // Handle the alpha value
      const edge = [
        circle.x + circle.translateX - circle.size, // distance from left edge
        canvasSize.current.w - circle.x - circle.translateX - circle.size, // distance from right edge
        circle.y + circle.translateY - circle.size, // distance from top edge
        canvasSize.current.h - circle.y - circle.translateY - circle.size, // distance from bottom edge
      ];
      const closestEdge = edge.reduce((a, b) =&gt; Math.min(a, b));
      const remapClosestEdge = parseFloat(
        remapValue(closestEdge, 0, 20, 0, 1).toFixed(2),
      );
      if (remapClosestEdge &gt; 1) {
        circle.alpha += 0.02;
        if (circle.alpha &gt; circle.targetAlpha) {
          circle.alpha = circle.targetAlpha;
        }
      } else {
        circle.alpha = circle.targetAlpha * remapClosestEdge;
      }
      circle.x += circle.dx + vx;
      circle.y += circle.dy + vy;
      circle.translateX +=
        (mouse.current.x / (staticity / circle.magnetism) - circle.translateX) /
        ease;
      circle.translateY +=
        (mouse.current.y / (staticity / circle.magnetism) - circle.translateY) /
        ease;

      drawCircle(circle, true);

      // circle gets out of the canvas
      if (
        circle.x &lt; -circle.size ||
        circle.x &gt; canvasSize.current.w + circle.size ||
        circle.y &lt; -circle.size ||
        circle.y &gt; canvasSize.current.h + circle.size
      ) {
        // remove the circle from the array
        circles.current.splice(i, 1);
        // create a new circle
        const newCircle = circleParams();
        drawCircle(newCircle);
      }
    });
    rafID.current = window.requestAnimationFrame(animate);
  };

  return</code></pre></div><div class="py-4"><p class="text-gray-600">components/landing/navbar.tsx (Line 260:2 - Line 278:3), components/landing/navbar.tsx (Line 198:2 - Line 217:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn296" onclick="toggleCodeBlock('cloneGroup296', 'expandBtn296', 'collapseBtn296')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn296" onclick="toggleCodeBlock('cloneGroup296', 'expandBtn296', 'collapseBtn296')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup296"><code class="language-tsx text-sm text-gray-800">].items?.map((subItem) =&gt; (
                          &lt;Link
                            key={subItem.title}
                            href={subItem.href}
                            onClick={() =&gt; setActiveDropdown(null)}
                            className=&quot;block px-4 py-3 rounded-md text-sm hover:bg-secondary/30 transition-colors&quot;
                          &gt;
                            &lt;div className=&quot;font-medium&quot;&gt;{subItem.title}&lt;/div&gt;
                            {subItem.description &amp;&amp; (
                              &lt;div className=&quot;text-muted-foreground text-xs mt-1&quot;&gt;{subItem.description}&lt;/div&gt;
                            )}
                          &lt;/Link&gt;
                        ))}
                      &lt;/div&gt;
                    &lt;/motion.div&gt;
                  )}
                &lt;/AnimatePresence&gt;
              &lt;/div&gt;
            &lt;/</code></pre></div><div class="py-4"><p class="text-gray-600">components/landing/navbar.tsx (Line 428:13 - Line 436:2), components/landing/navbar.tsx (Line 204:27 - Line 212:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn297" onclick="toggleCodeBlock('cloneGroup297', 'expandBtn297', 'collapseBtn297')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn297" onclick="toggleCodeBlock('cloneGroup297', 'expandBtn297', 'collapseBtn297')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup297"><code class="language-tsx text-sm text-gray-800">&gt;
              &lt;div className=&quot;font-medium&quot;&gt;{subItem.title}&lt;/div&gt;
              {subItem.description &amp;&amp; (
                &lt;div className=&quot;text-muted-foreground text-xs mt-1&quot;&gt;{subItem.description}&lt;/div&gt;
              )}
            &lt;/Link&gt;
          ))}
        &lt;/div&gt;
      )</code></pre></div><div class="py-4"><p class="text-gray-600">components/landing/feature-scroll.tsx (Line 10:2 - Line 37:7), components/marketing/feature-showcase.tsx (Line 40:2 - Line 67:31)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn298" onclick="toggleCodeBlock('cloneGroup298', 'expandBtn298', 'collapseBtn298')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn298" onclick="toggleCodeBlock('cloneGroup298', 'expandBtn298', 'collapseBtn298')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup298"><code class="language-tsx text-sm text-gray-800">;

  const { scrollYProgress: scrollYProgress1 } = useScroll({
    target: feature1Ref,
    offset: [&quot;start end&quot;, &quot;end start&quot;],
  });

  const { scrollYProgress: scrollYProgress2 } = useScroll({
    target: feature2Ref,
    offset: [&quot;start end&quot;, &quot;end start&quot;],
  });

  const { scrollYProgress: scrollYProgress3 } = useScroll({
    target: feature3Ref,
    offset: [&quot;start end&quot;, &quot;end start&quot;],
  });

  const y1 = useTransform(scrollYProgress1, [0, 0.3], [150, 0], {
    ease: easeOutCubic,
  });
  const y2 = useTransform(scrollYProgress2, [0.1, 0.4], [200, 0], {
    ease: easeOutCubic,
  });
  const y3 = useTransform(scrollYProgress3, [0.2, 0.5], [250, 0], {
    ease: easeOutCubic,
  });

  return</code></pre></div><div class="py-4"><p class="text-gray-600">components/landing/feature-scroll.tsx (Line 60:11 - Line 69:87), components/landing/feature-scroll.tsx (Line 47:2 - Line 109:15)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn299" onclick="toggleCodeBlock('cloneGroup299', 'expandBtn299', 'collapseBtn299')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn299" onclick="toggleCodeBlock('cloneGroup299', 'expandBtn299', 'collapseBtn299')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup299"><code class="language-tsx text-sm text-gray-800">&gt;

        &lt;motion.div
          ref={feature2Ref}
          className=&quot;bg-card border border-border rounded-lg p-6 shadow-sm flex flex-col items-center text-center&quot;
          style={{ y: y2 }}
        &gt;
          &lt;div className=&quot;bg-primary/10 rounded-full p-4 mb-4&quot;&gt;
            &lt;svg className=&quot;w-8 h-8 text-primary&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;
              &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot; strokeWidth={2} d=&quot;M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z</code></pre></div><div class="py-4"><p class="text-gray-600">components/landing/feature-scroll.tsx (Line 73:6 - Line 85:3), components/landing/feature-scroll.tsx (Line 59:8 - Line 77:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn300" onclick="toggleCodeBlock('cloneGroup300', 'expandBtn300', 'collapseBtn300')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn300" onclick="toggleCodeBlock('cloneGroup300', 'expandBtn300', 'collapseBtn300')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup300"><code class="language-tsx text-sm text-gray-800">.&lt;/p&gt;
        &lt;/motion.div&gt;

        &lt;motion.div
          ref={feature3Ref}
          className=&quot;bg-card border border-border rounded-lg p-6 shadow-sm flex flex-col items-center text-center&quot;
          style={{ y: y3 }}
        &gt;
          &lt;div className=&quot;bg-primary/10 rounded-full p-4 mb-4&quot;&gt;
            &lt;svg className=&quot;w-8 h-8 text-primary&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;
              &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot; strokeWidth={2} d=&quot;M5 13l4 4L19 7&quot; /&gt;
            &lt;/svg&gt;
          &lt;/</code></pre></div><div class="py-4"><p class="text-gray-600">components/landing/brand-word-rotate.tsx (Line 43:16 - Line 53:21), components/magicui/word-rotate.tsx (Line 15:11 - Line 25:16)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn303" onclick="toggleCodeBlock('cloneGroup303', 'expandBtn303', 'collapseBtn303')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn303" onclick="toggleCodeBlock('cloneGroup303', 'expandBtn303', 'collapseBtn303')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup303"><code class="language-tsx text-sm text-gray-800">({
  words,
  duration = 2500,
  motionProps = {
    initial: { opacity: 0, y: -50 },
    animate: { opacity: 1, y: 0 },
    exit: { opacity: 0, y: 50 },
    transition: { duration: 0.25, ease: &quot;easeOut&quot; },
  },
  className,
}: BrandWordRotateProps</code></pre></div><div class="py-4"><p class="text-gray-600">components/landing/brand-word-rotate.tsx (Line 53:21 - Line 61:7), components/magicui/word-rotate.tsx (Line 25:16 - Line 33:32)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn304" onclick="toggleCodeBlock('cloneGroup304', 'expandBtn304', 'collapseBtn304')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn304" onclick="toggleCodeBlock('cloneGroup304', 'expandBtn304', 'collapseBtn304')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup304"><code class="language-tsx text-sm text-gray-800">) {
  const [index, setIndex] = useState(0);

  useEffect(() =&gt; {
    const interval = setInterval(() =&gt; {
      setIndex((prevIndex) =&gt; (prevIndex + 1) % words.length);
    }, duration);

    return</code></pre></div><div class="py-4"><p class="text-gray-600">components/landing/bento-section.tsx (Line 57:5 - Line 64:4), components/marketing/feature-showcase.tsx (Line 94:2 - Line 101:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn305" onclick="toggleCodeBlock('cloneGroup305', 'expandBtn305', 'collapseBtn305')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn305" onclick="toggleCodeBlock('cloneGroup305', 'expandBtn305', 'collapseBtn305')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup305"><code class="language-tsx text-sm text-gray-800">&gt;
      &lt;div className=&quot;border-x mx-5 md:mx-10 relative max-w-7xl w-full&quot;&gt;
        &lt;div className=&quot;absolute top-0 -left-4 md:-left-14 h-full w-4 md:w-14 text-primary/5 bg-[size:10px_10px] [background-image:repeating-linear-gradient(315deg,currentColor_0_1px,#0000_0_50%)]&quot;&gt;&lt;/div&gt;
        &lt;div className=&quot;absolute top-0 -right-4 md:-right-14 h-full w-4 md:w-14 text-primary/5 bg-[size:10px_10px] [background-image:repeating-linear-gradient(315deg,currentColor_0_1px,#0000_0_50%)]&quot;&gt;&lt;/div&gt;

        &lt;div className=&quot;text-center mb-12&quot;&gt;
          &lt;h2 className=&quot;text-3xl md:text-4xl font-medium tracking-tighter mb-4 text-balance&quot;&gt;
            Key</code></pre></div><div class="py-4"><p class="text-gray-600">components/error-boundaries/api-error-boundary.tsx (Line 108:2 - Line 114:2), components/error-boundaries/feature-error-boundary.tsx (Line 124:2 - Line 130:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn308" onclick="toggleCodeBlock('cloneGroup308', 'expandBtn308', 'collapseBtn308')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn308" onclick="toggleCodeBlock('cloneGroup308', 'expandBtn308', 'collapseBtn308')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup308"><code class="language-tsx text-sm text-gray-800">process.env.NODE_ENV !== 'production' &amp;&amp; (
            &lt;div className=&quot;text-xs p-2 mt-2 bg-muted rounded overflow-auto max-h-[200px]&quot;&gt;
              &lt;p className=&quot;font-mono&quot;&gt;{error.toString()}&lt;/p&gt;
            &lt;/div&gt;
          )}
          &lt;div className=&quot;flex flex-col xs:flex-row gap-2 mt-4&quot;&gt;
            &lt;</code></pre></div><div class="py-4"><p class="text-gray-600">components/auth/clerk-auth-form.tsx (Line 33:2 - Line 54:33), app/(auth)/sign-up/[[...sign-up]]/page.tsx (Line 31:2 - Line 52:68)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn309" onclick="toggleCodeBlock('cloneGroup309', 'expandBtn309', 'collapseBtn309')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn309" onclick="toggleCodeBlock('cloneGroup309', 'expandBtn309', 'collapseBtn309')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup309"><code class="language-tsx text-sm text-gray-800">= {
    baseTheme: theme === &quot;dark&quot; ? dark : undefined,
    elements: {
      formButtonPrimary:
        &quot;bg-primary hover:bg-primary/90 text-primary-foreground&quot;,
      card: &quot;bg-background border border-border shadow-sm&quot;,
      formButtonReset: &quot;text-muted-foreground hover:text-foreground&quot;,
      footerActionLink: &quot;text-primary hover:text-primary/90&quot;,
      headerTitle: &quot;text-foreground&quot;,
      headerSubtitle: &quot;text-muted-foreground&quot;,
      socialButtonsBlockButton:
        &quot;border border-border hover:bg-muted text-foreground&quot;,
      formFieldLabel: &quot;text-foreground&quot;,
      formFieldInput:
        &quot;bg-background border border-input text-foreground rounded-md&quot;,
      identityPreview: &quot;bg-muted-foreground/20&quot;,
      dividerLine: &quot;bg-border&quot;,
      dividerText: &quot;text-muted-foreground&quot;,
    },
  };

  // Default paths if not provided</code></pre></div><div class="py-4"><p class="text-gray-600">components/auth/auth-status.tsx (Line 238:2 - Line 251:2), components/auth/auth-status.tsx (Line 76:2 - Line 91:33)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn310" onclick="toggleCodeBlock('cloneGroup310', 'expandBtn310', 'collapseBtn310')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn310" onclick="toggleCodeBlock('cloneGroup310', 'expandBtn310', 'collapseBtn310')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup310"><code class="language-tsx text-sm text-gray-800">&gt;
        &lt;span className=&quot;text-sm font-medium&quot;&gt;
          {user?.name || 'Authenticated User'}
        &lt;/span&gt;
        &lt;Button
          variant=&quot;ghost&quot;
          size=&quot;sm&quot;
          onClick={() =&gt; signOut({ callbackUrl: '/' })}
        &gt;
          Sign out
        &lt;/Button&gt;
      &lt;/div&gt;
    );
  },</code></pre></div><div class="py-4"><p class="text-gray-600">components/auth/auth-error-boundary.tsx (Line 193:33 - Line 199:3), components/providers/enhanced-clerk-provider.tsx (Line 81:58 - Line 87:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn311" onclick="toggleCodeBlock('cloneGroup311', 'expandBtn311', 'collapseBtn311')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn311" onclick="toggleCodeBlock('cloneGroup311', 'expandBtn311', 'collapseBtn311')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup311"><code class="language-tsx text-sm text-gray-800">&quot;&gt;
          &lt;div className=&quot;bg-red-100 p-3 rounded-full&quot;&gt;
            &lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; className=&quot;h-6 w-6 text-red-600&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot;&gt;
              &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot; strokeWidth={2} d=&quot;M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z&quot; /&gt;
            &lt;/svg&gt;
          &lt;/div&gt;
        &lt;/</code></pre></div><div class="py-4"><p class="text-gray-600">app/onboarding/page.tsx (Line 1:1 - Line 31:17), app/(platform)/profile/profile-settings/page.tsx (Line 1:1 - Line 31:14)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn313" onclick="toggleCodeBlock('cloneGroup313', 'expandBtn313', 'collapseBtn313')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn313" onclick="toggleCodeBlock('cloneGroup313', 'expandBtn313', 'collapseBtn313')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup313"><code class="language-tsx text-sm text-gray-800">&quot;use client&quot;;





import { PlatformHeader } from &quot;@/components/ui&quot;;
import { useAuth } from &quot;@/lib/auth/hooks&quot;;
import { UserRole } from &quot;@/lib/auth/types&quot;;
import { zodResolver } from &quot;@hookform/resolvers/zod&quot;;
import { Loader2 } from &quot;lucide-react&quot;;
import { redirect } from &quot;next/navigation&quot;;
import { useEffect } from &quot;react&quot;;
import { useForm } from &quot;react-hook-form&quot;;
import { toast } from &quot;sonner&quot;;
import * as z from &quot;zod&quot;;
import {
  Button,
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
  Input,
  RadioGroup,
  RadioGroupItem
} from &quot;@/components/ui&quot;;

const onboardingSchema</code></pre></div><div class="py-4"><p class="text-gray-600">app/onboarding/page.tsx (Line 58:5 - Line 73:15), app/(platform)/profile/profile-settings/page.tsx (Line 66:5 - Line 81:12)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn314" onclick="toggleCodeBlock('cloneGroup314', 'expandBtn314', 'collapseBtn314')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn314" onclick="toggleCodeBlock('cloneGroup314', 'expandBtn314', 'collapseBtn314')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup314"><code class="language-tsx text-sm text-gray-800">]);

  // Redirect to login if not authenticated
  if (!isLoading &amp;&amp; !isAuthenticated) {
    redirect(&quot;/login&quot;);
  }

  if (isLoading) {
    return (
      &lt;div className=&quot;flex h-screen w-screen items-center justify-center&quot;&gt;
        &lt;Loader2 className=&quot;h-8 w-8 animate-spin&quot; /&gt;
      &lt;/div&gt;
    );
  }

  async function onSubmit(data: OnboardingData</code></pre></div><div class="py-4"><p class="text-gray-600">app/onboarding/page.tsx (Line 87:13 - Line 102:9), app/(platform)/profile/profile-settings/page.tsx (Line 92:2 - Line 107:8)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn315" onclick="toggleCodeBlock('cloneGroup315', 'expandBtn315', 'collapseBtn315')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn315" onclick="toggleCodeBlock('cloneGroup315', 'expandBtn315', 'collapseBtn315')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup315"><code class="language-tsx text-sm text-gray-800">);
    } catch (error) {
      toast.error(&quot;Something went wrong&quot;, {
        description: &quot;We couldn&amp;apos;t update your profile. Please try again.&quot;,
      });
    }
  }

  return (
    &lt;div className=&quot;flex min-h-screen flex-col&quot;&gt;
      &lt;PlatformHeader /&gt;
      &lt;main className=&quot;flex-1 pt-16&quot;&gt;
        &lt;div className=&quot;container py-12&quot;&gt;
          &lt;div className=&quot;mx-auto max-w-md&quot;&gt;
            &lt;div className=&quot;text-center mb-8&quot;&gt;
              &lt;h1 className=&quot;text-3xl font-bold&quot;&gt;Complete</code></pre></div><div class="py-4"><p class="text-gray-600">app/calendly-test/page.tsx (Line 23:2 - Line 41:2), app/test/calendly-debug/page.tsx (Line 18:6 - Line 36:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn316" onclick="toggleCodeBlock('cloneGroup316', 'expandBtn316', 'collapseBtn316')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn316" onclick="toggleCodeBlock('cloneGroup316', 'expandBtn316', 'collapseBtn316')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup316"><code class="language-tsx text-sm text-gray-800">&lt;/h1&gt;
      
      &lt;div className=&quot;mb-6&quot;&gt;
        &lt;p className=&quot;mb-2&quot;&gt;Select a test URL:&lt;/p&gt;
        &lt;select 
          className=&quot;border p-2 rounded w-full max-w-md&quot;
          value={selectedUrl}
          onChange={(e) =&gt; setSelectedUrl(e.target.value)}
        &gt;
          &lt;option value=&quot;&quot;&gt;Select a session type&lt;/option&gt;
          {testUrls.map((url) =&gt; (
            &lt;option key={url} value={url}&gt;
              {url.split('/').pop()}
            &lt;/option&gt;
          ))}
        &lt;/select&gt;
      &lt;/div&gt;
      
      &lt;</code></pre></div><div class="py-4"><p class="text-gray-600">app/calendly-test/page.tsx (Line 103:9 - Line 110:2), app/test/calendly-debug/page.tsx (Line 53:9 - Line 60:3)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn317" onclick="toggleCodeBlock('cloneGroup317', 'expandBtn317', 'collapseBtn317')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn317" onclick="toggleCodeBlock('cloneGroup317', 'expandBtn317', 'collapseBtn317')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup317"><code class="language-tsx text-sm text-gray-800">&lt;/div&gt;
      )}
      
      &lt;div className=&quot;mt-8 p-4 bg-gray-100 rounded&quot;&gt;
        &lt;h3 className=&quot;font-semibold mb-2&quot;&gt;Debug Information:&lt;/h3&gt;
        &lt;p&gt;Check the browser console for detailed logs.&lt;/p&gt;
        &lt;p&gt;Current URL: {selectedUrl || 'None selected'}&lt;/p&gt;
        &lt;</code></pre></div><div class="py-4"><p class="text-gray-600">app/auth-test/client.tsx (Line 52:2 - Line 61:6), app/role-test/client.tsx (Line 60:7 - Line 67:40)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn318" onclick="toggleCodeBlock('cloneGroup318', 'expandBtn318', 'collapseBtn318')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn318" onclick="toggleCodeBlock('cloneGroup318', 'expandBtn318', 'collapseBtn318')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup318"><code class="language-tsx text-sm text-gray-800">);
  
  // Local state for API testing
  const [apiResponse, setApiResponse] = useState&lt;ApiResponse | null&gt;(null);
  const [loading, setLoading] = useState&lt;string | null&gt;(null);
  const [error, setError] = useState&lt;string | null&gt;(null);

  /**
   * Test a specific API endpoint
   */</code></pre></div><div class="py-4"><p class="text-gray-600">app/auth-test/client.tsx (Line 67:17 - Line 84:7), app/role-test/client.tsx (Line 109:17 - Line 126:45)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn319" onclick="toggleCodeBlock('cloneGroup319', 'expandBtn319', 'collapseBtn319')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn319" onclick="toggleCodeBlock('cloneGroup319', 'expandBtn319', 'collapseBtn319')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup319"><code class="language-tsx text-sm text-gray-800">, { 
        method,
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      const data = await res.json();
      setApiResponse(data);
    } catch (err) {
      setError((err as Error).message);
      setApiResponse(null);
    } finally {
      setLoading(null);
    }
  };

  return</code></pre></div><div class="py-4"><p class="text-gray-600">app/auth-test/client.tsx (Line 114:15 - Line 134:2), app/auth-test/page.tsx (Line 67:15 - Line 86:2)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn320" onclick="toggleCodeBlock('cloneGroup320', 'expandBtn320', 'collapseBtn320')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn320" onclick="toggleCodeBlock('cloneGroup320', 'expandBtn320', 'collapseBtn320')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup320"><code class="language-tsx text-sm text-gray-800">&lt;/p&gt;

              &lt;div className=&quot;mb-2&quot;&gt;
                &lt;span className=&quot;font-medium&quot;&gt;Roles:&lt;/span&gt; 
                &lt;div className=&quot;mt-1 flex flex-wrap gap-2&quot;&gt;
                  {auth.roles.length &gt; 0 ? (
                    auth.roles.map(role =&gt; (
                      &lt;span 
                        key={role} 
                        className=&quot;bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium&quot;
                      &gt;
                        {role}
                      &lt;/span&gt;
                    ))
                  ) : (
                    &lt;span className=&quot;text-gray-500 italic&quot;&gt;No roles assigned&lt;/span&gt;
                  )}
                &lt;/div&gt;
              &lt;/div&gt;

              &lt;</code></pre></div><div class="py-4"><p class="text-gray-600">app/auth-test/client.tsx (Line 249:26 - Line 259:27), app/role-test/client.tsx (Line 230:48 - Line 240:49)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn321" onclick="toggleCodeBlock('cloneGroup321', 'expandBtn321', 'collapseBtn321')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn321" onclick="toggleCodeBlock('cloneGroup321', 'expandBtn321', 'collapseBtn321')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup321"><code class="language-tsx text-sm text-gray-800">&quot;&gt;
                    &lt;p&gt;&lt;span className=&quot;font-medium&quot;&gt;Error Type:&lt;/span&gt; {apiResponse.error.type}&lt;/p&gt;
                    &lt;p&gt;&lt;span className=&quot;font-medium&quot;&gt;Detail:&lt;/span&gt; {apiResponse.error.detail}&lt;/p&gt;
                  &lt;/div&gt;
                )}
              &lt;/div&gt;
            &lt;/div&gt;
          )}
          
          {error &amp;&amp; (
            &lt;div className=&quot;mt-4 p-4 bg-red-50 rounded</code></pre></div><!-- Add more clone groups for .txt format as needed         // Add more clone groups for .txt format as needed--></div><a name="css-clones"></a><h2 class="text-2xl font-semibold text-gray-700 mb-4">css</h2><div class="divide-y divide-gray-200 border-b-2"><div class="py-4"><p class="text-gray-600">app/globals.css (Line 338:2 - Line 363:11), app/globals.css (Line 281:31 - Line 308:7)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn348" onclick="toggleCodeBlock('cloneGroup348', 'expandBtn348', 'collapseBtn348')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn348" onclick="toggleCodeBlock('cloneGroup348', 'expandBtn348', 'collapseBtn348')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup348"><code class="language-css text-sm text-gray-800">;
    }
  }
  @keyframes aurora {
  0% {
    background-position: 0% 50%;
    transform: rotate(-5deg) scale(0.9);
    }
  25% {
    background-position: 50% 100%;
    transform: rotate(5deg) scale(1.1);
    }
  50% {
    background-position: 100% 50%;
    transform: rotate(-3deg) scale(0.95);
    }
  75% {
    background-position: 50% 0%;
    transform: rotate(3deg) scale(1.05);
    }
  100% {
    background-position: 0% 50%;
    transform: rotate(-5deg) scale(0.9);
    }
  }
  @keyframes</code></pre></div><div class="py-4"><p class="text-gray-600">app/globals.css (Line 360:4 - Line 385:7), app/globals.css (Line 338:2 - Line 363:8)</p><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2" id="expandBtn349" onclick="toggleCodeBlock('cloneGroup349', 'expandBtn349', 'collapseBtn349')">Show code</button><button class="bg-gray-500 text-white px-1 py-0.5 text-xs rounded focus:outline-none ml-2 hidden" id="collapseBtn349" onclick="toggleCodeBlock('cloneGroup349', 'expandBtn349', 'collapseBtn349')">Hide code</button><pre class="bg-gray-100 border border-gray-200 p-4 rounded mt-2 hidden" id="cloneGroup349"><code class="language-css text-sm text-gray-800">);
    }
  }
  @keyframes aurora {
  0% {
    background-position: 0% 50%;
    transform: rotate(-5deg) scale(0.9);
    }
  25% {
    background-position: 50% 100%;
    transform: rotate(5deg) scale(1.1);
    }
  50% {
    background-position: 100% 50%;
    transform: rotate(-3deg) scale(0.95);
    }
  75% {
    background-position: 50% 0%;
    transform: rotate(3deg) scale(1.05);
    }
  100% {
    background-position: 0% 50%;
    transform: rotate(-5deg) scale(0.9);
    }
  }
  @keyframes shine</code></pre></div><!-- Add more clone groups for .txt format as needed         // Add more clone groups for .txt format as needed--></div></section><!-- Add more sections for other formats and clone groups as needed--></main><footer class="bg-white shadow mt-8 py-4"><div class="container mx-auto px-4 text-center"><p class="text-sm text-gray-600">This report is generated by jscpd, an open-source copy/paste detector.</p><p class="text-sm text-gray-600">jscpd is licensed under the MIT License.</p><a class="text-blue-500 text-sm" href="https://github.com/kucherenko/jscpd" target="_blank" rel="noopener noreferrer">View jscpd on GitHub</a></div></footer><script src="js/prism.js"></script><script>function toggleCodeBlock(codeBlockId, expandBtnId, collapseBtnId) {
  const codeBlock = document.getElementById(codeBlockId);
  const expandBtn = document.getElementById(expandBtnId);
  const collapseBtn = document.getElementById(collapseBtnId);

  codeBlock.classList.toggle('hidden');
  expandBtn.classList.toggle('hidden');
  collapseBtn.classList.toggle('hidden');
}</script></body></html>